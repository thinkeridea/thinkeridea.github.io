<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>thinkerideaåšå®¢</title>
  <icon>https://www.gravatar.com/avatar/9d6f60998913bb76135b4779bbb90154</icon>
  <subtitle>thinkeridea</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.thinkeridea.com/"/>
  <updated>2019-01-26T12:02:37.245Z</updated>
  <id>https://blog.thinkeridea.com/</id>
  
  <author>
    <name>æˆšé“¶</name>
    <email>qiyin@thinkeridea.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€Goã€‘ä¼˜é›…çš„è¯»å–httpè¯·æ±‚æˆ–å“åº”çš„æ•°æ®</title>
    <link href="https://blog.thinkeridea.com/201901/go/you_ya_de_du_qu_http_qing_qiu_huo_xiang_ying_de_shu_ju.html"/>
    <id>https://blog.thinkeridea.com/201901/go/you_ya_de_du_qu_http_qing_qiu_huo_xiang_ying_de_shu_ju.html</id>
    <published>2019-01-26T12:02:37.245Z</published>
    <updated>2019-01-26T12:02:37.245Z</updated>
    
    <content type="html"><![CDATA[<p>ä» <code>http.Request.Body</code> æˆ– <code>http.Response.Body</code> ä¸­è¯»å–æ•°æ®æ–¹æ³•æˆ–è®¸å¾ˆå¤šï¼Œæ ‡å‡†åº“ä¸­å¤§å¤šæ•°ä½¿ç”¨ <code>ioutil.ReadAll</code> æ–¹æ³•ä¸€æ¬¡è¯»å–æ‰€æœ‰æ•°æ®ï¼Œå¦‚æœæ˜¯ <code>json</code> æ ¼å¼çš„æ•°æ®è¿˜å¯ä»¥ä½¿ç”¨ <code>json.NewDecoder</code> ä» <code>io.Reader</code> åˆ›å»ºä¸€ä¸ªè§£æå™¨ï¼Œå‡ä½¿ä½¿ç”¨ <code>pprof</code> æ¥åˆ†æç¨‹åºæ€»æ˜¯ä¼šå‘ç° <code>bytes.makeSlice</code> åˆ†é…äº†å¤§é‡å†…å­˜ï¼Œä¸”æ€»æ˜¯æ’è¡Œç¬¬ä¸€ï¼Œä»Šå¤©å°±è¿™ä¸ªé—®é¢˜æ¥è¯´ä¸€ä¸‹å¦‚ä½•é«˜æ•ˆä¼˜é›…çš„è¯»å– <code>http</code> ä¸­çš„æ•°æ®ã€‚</p><a id="more"></a><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><p>æˆ‘ä»¬æœ‰è®¸å¤š <code>api</code> æœåŠ¡ï¼Œå…¨éƒ¨é‡‡ç”¨ <code>json</code> æ•°æ®æ ¼å¼ï¼Œè¯·æ±‚ä½“å°±æ˜¯æ•´ä¸ª <code>json</code> å­—ç¬¦ä¸²ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡ç«¯ä¼šç»è¿‡ä¸€äº›ä¸šåŠ¡å¤„ç†ï¼Œç„¶åå†è¯·æ±‚åé¢æ›´å¤šçš„æœåŠ¡ï¼Œæ‰€æœ‰çš„æœåŠ¡ä¹‹é—´éƒ½ç”¨ <code>http</code> åè®®æ¥é€šä¿¡(å•Šï¼Œ ä¸ºå•¥ä¸ç”¨ <code>RPC</code>ï¼Œå› ä¸ºæ‰€æœ‰çš„æœåŠ¡éƒ½ä¼šå¯¹ç¬¬ä¸‰æ–¹å¼€æ”¾ï¼Œ<code>http</code> + <code>json</code> æ›´å¥½å¯¹æ¥)ï¼Œå¤§å¤šæ•°è¯·æ±‚æ•°æ®å¤§å°åœ¨ 1K~4Kï¼Œå“åº”çš„æ•°æ®åœ¨ 1K~8Kï¼Œæ—©æœŸæ‰€æœ‰çš„æœåŠ¡éƒ½ä½¿ç”¨ <code>ioutil.ReadAll</code> æ¥è¯»å–æ•°æ®ï¼Œéšç€æµé‡å¢åŠ ä½¿ç”¨ <code>pprof</code> æ¥åˆ†æå‘ç° <code>bytes.makeSlice</code> æ€»æ˜¯æ’åœ¨ç¬¬ä¸€ï¼Œå¹¶ä¸”å ç”¨äº†æ•´ä¸ªç¨‹åº <code>1/10</code> çš„å†…å­˜åˆ†é…ï¼Œæˆ‘å†³å®šé’ˆå¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œä¼˜åŒ–ï¼Œä¸‹é¢æ˜¯æ•´ä¸ªä¼˜åŒ–è¿‡ç¨‹çš„è®°å½•ã€‚</p><h2 id="pprof-åˆ†æ"><a href="#pprof-åˆ†æ" class="headerlink" title="pprof åˆ†æ"></a>pprof åˆ†æ</h2><p>è¿™é‡Œä½¿ç”¨ <a href="https://github.com/thinkeridea/go-extend/blob/master/exnet/exhttp/expprof/pprof.go" target="_blank" rel="noopener">https://github.com/thinkeridea/go-extend/blob/master/exnet/exhttp/expprof/pprof.go</a> ä¸­çš„ <code>API</code> æ¥å®ç°ç”Ÿäº§ç¯å¢ƒçš„ <code>/debug/pprof</code> ç›‘æµ‹æ¥å£ï¼Œæ²¡æœ‰ä½¿ç”¨æ ‡å‡†åº“çš„ <code>net/http/pprof</code> åŒ…å› ä¸ºä¼šè‡ªåŠ¨æ³¨å†Œè·¯ç”±ï¼Œä¸”é•¿æœŸå¼€æ”¾ <code>API</code>ï¼Œè¿™ä¸ªåŒ…å¯ä»¥è®¾å®š <code>API</code> æ˜¯å¦å¼€æ”¾ï¼Œå¹¶åœ¨è§„å®šæ—¶é—´åè‡ªåŠ¨å…³é—­æ¥å£ï¼Œé¿å…å­˜åœ¨å·¥å…·å—…æ¢ã€‚</p><p>æœåŠ¡éƒ¨ç½²ä¸Šçº¿ç¨³å®šå(å¤§çº¦è¿‡äº†ä¸€å¤©åŠ)ï¼Œé€šè¿‡ <code>curl</code> ä¸‹è½½ <code>allocs</code> æ•°æ®ï¼Œç„¶åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹åˆ†æã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof allocs</span><br><span class="line">File: xxx</span><br><span class="line">Type: alloc_space</span><br><span class="line">Time: Jan <span class="number">25</span>, <span class="number">2019</span> at <span class="number">3</span>:<span class="number">02</span>pm (CST)</span><br><span class="line">Entering interactive mode (type <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">604.62</span>GB, <span class="number">44.50</span>% of <span class="number">1358.61</span>GB total</span><br><span class="line">Dropped <span class="number">776</span> nodes (cum &lt;= <span class="number">6.79</span>GB)</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">155</span></span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">  <span class="number">111.40</span>GB  <span class="number">8.20</span>%  <span class="number">8.20</span>%   <span class="number">111.40</span>GB  <span class="number">8.20</span>%  bytes.makeSlice</span><br><span class="line">  <span class="number">107.72</span>GB  <span class="number">7.93</span>% <span class="number">16.13</span>%   <span class="number">107.72</span>GB  <span class="number">7.93</span>%  github.com/sirupsen/logrus.(*Entry).WithFields</span><br><span class="line">   <span class="number">65.94</span>GB  <span class="number">4.85</span>% <span class="number">20.98</span>%    <span class="number">65.94</span>GB  <span class="number">4.85</span>%  strings.Replace</span><br><span class="line">   <span class="number">54.10</span>GB  <span class="number">3.98</span>% <span class="number">24.96</span>%    <span class="number">56.03</span>GB  <span class="number">4.12</span>%  github.com/json-iterator/go.(*frozenConfig).Marshal</span><br><span class="line">   <span class="number">47.54</span>GB  <span class="number">3.50</span>% <span class="number">28.46</span>%    <span class="number">47.54</span>GB  <span class="number">3.50</span>%  net/url.unescape</span><br><span class="line">   <span class="number">47.11</span>GB  <span class="number">3.47</span>% <span class="number">31.93</span>%    <span class="number">48.16</span>GB  <span class="number">3.55</span>%  github.com/json-iterator/go.(*Iterator).readStringSlowPath</span><br><span class="line">   <span class="number">46.63</span>GB  <span class="number">3.43</span>% <span class="number">35.36</span>%   <span class="number">103.04</span>GB  <span class="number">7.58</span>%  handlers.(*AdserviceHandler).returnAd</span><br><span class="line">   <span class="number">42.43</span>GB  <span class="number">3.12</span>% <span class="number">38.49</span>%    <span class="number">84.62</span>GB  <span class="number">6.23</span>%  models.LogItemsToBytes</span><br><span class="line">   <span class="number">42.22</span>GB  <span class="number">3.11</span>% <span class="number">41.59</span>%    <span class="number">42.22</span>GB  <span class="number">3.11</span>%  strings.Join</span><br><span class="line">   <span class="number">39.52</span>GB  <span class="number">2.91</span>% <span class="number">44.50</span>%    <span class="number">87.06</span>GB  <span class="number">6.41</span>%  net/url.parseQuery</span><br></pre></td></tr></table></figure><p>ä»ç»“æœä¸­å¯ä»¥çœ‹å‡ºé‡‡é›†æœŸé—´ä¸€å…±åˆ†é…äº† <code>1358.61GB</code> <code>top 10</code> å ç”¨äº† <code>44.50%</code> å…¶ä¸­ <code>bytes.makeSlice</code> å äº†æ¥è¿‘ <code>1/10</code>ï¼Œé‚£ä¹ˆçœ‹çœ‹éƒ½æ˜¯è°åœ¨è°ƒç”¨ <code>bytes.makeSlice</code> å§ã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(pprof) web bytes.makeSlice</span><br></pre></td></tr></table></figure><p><img src="/assets/image/20190126/1.jpg" alt="image-1"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºè°ƒç”¨ <code>bytes.makeSlice</code> çš„æœ€ç»ˆæ–¹æ³•æ˜¯ <code>ioutil.ReadAll</code>, (å—ç¯‡å¹…å½±å“å°±æ²¡æœ‰æˆªå– <code>ioutil.ReadAll</code> ä¸Šé¢çš„æ–¹æ³•äº†)ï¼Œè€Œ 90% éƒ½æ˜¯ <code>ioutil.ReadAll</code> è¯»å– <code>http</code> æ•°æ®è°ƒç”¨ï¼Œæ‰¾åˆ°åœ°æ–¹å…ˆåˆ«æ€¥æƒ³ä¼˜åŒ–æ–¹æ¡ˆï¼Œå…ˆçœ‹çœ‹ä¸ºå•¥ <code>ioutil.ReadAll</code> ä¼šå¯¼è‡´è¿™ä¹ˆå¤šå†…å­˜åˆ†é…ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readAll</span><span class="params">(r io.Reader, capacity <span class="keyword">int64</span>)</span> <span class="params">(b []<span class="keyword">byte</span>, err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line"><span class="comment">// If the buffer overflows, we will get bytes.ErrTooLarge.</span></span><br><span class="line"><span class="comment">// Return that as an error. Any other panic remains.</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">e := <span class="built_in">recover</span>()</span><br><span class="line"><span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;</span><br><span class="line">err = panicErr</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">int64</span>(<span class="keyword">int</span>(capacity)) == capacity &#123;</span><br><span class="line">buf.Grow(<span class="keyword">int</span>(capacity))</span><br><span class="line">&#125;</span><br><span class="line">_, err = buf.ReadFrom(r)</span><br><span class="line"><span class="keyword">return</span> buf.Bytes(), err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> readAll(r, bytes.MinRead)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯æ ‡å‡†åº“ <code>ioutil.ReadAll</code> çš„ä»£ç ï¼Œæ¯æ¬¡ä¼šåˆ›å»ºä¸€ä¸ª <code>var buf bytes.Buffer</code> å¹¶ä¸”åˆå§‹åŒ– <code>buf.Grow(int(capacity))</code> çš„å¤§å°ä¸º <code>bytes.MinRead</code>, è¿™ä¸ªå€¼å‘¢å°±æ˜¯ <code>512</code>ï¼ŒæŒ‰è¿™ä¸ª <code>buffer</code> çš„å¤§å°è¯»å–ä¸€æ¬¡æ•°æ®éœ€è¦åˆ†é… 2~16 æ¬¡å†…å­˜ï¼Œå¤©å•Šç®€ç›´ä¸èƒ½å¿ï¼Œæˆ‘è‡ªå·±åˆ›å»ºä¸€ä¸ª <code>buffer</code> å¥½ä¸å¥½ã€‚</p><p>çœ‹ä¸€ä¸‹ç«ç„°å›¾ğŸ”¥å§ï¼Œå…¶ä¸­çº¢æ¡†æ ‡è®°çš„å°±æ˜¯ <code>ioutil.ReadAll</code> çš„éƒ¨åˆ†ï¼Œé¢œè‰²æ¯”è¾ƒé²œè‰³ã€‚</p><p><img src="/assets/image/20190126/2.jpg" alt="image-2"></p><h2 id="ä¼˜åŒ–è¯»å–æ–¹æ³•"><a href="#ä¼˜åŒ–è¯»å–æ–¹æ³•" class="headerlink" title="ä¼˜åŒ–è¯»å–æ–¹æ³•"></a>ä¼˜åŒ–è¯»å–æ–¹æ³•</h2><p>è‡ªå·±åˆ›å»ºè¶³å¤Ÿå¤§çš„ <code>buffer</code> å‡å°‘å› ä¸ºå®¹é‡ä¸å¤Ÿå¯¼è‡´çš„å¤šæ¬¡æ‰©å®¹é—®é¢˜ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">buffer := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>))</span><br><span class="line">_, err := io.Copy(buffer, request.Body)</span><br><span class="line"><span class="keyword">if</span> err !=<span class="literal">nil</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ©æ©è¿™æ ·åº”è¯¥å·®ä¸å¤šäº†ï¼Œä¸ºå•¥æ˜¯åˆå§‹åŒ– <code>4096</code> çš„å¤§å°ï¼Œè¿™æ˜¯ä¸ªå‡å€¼ï¼Œå³ä½¿æ¯” <code>4096</code> å¤§åŸºæœ¬ä¹Ÿå°±å¤šåˆ†é…ä¸€æ¬¡å†…å­˜å³å¯ï¼Œè€Œä¸”å¤§å¤šæ•°æ•°æ®éƒ½æ˜¯æ¯” <code>4096</code> å°çš„ã€‚</p><p>ä½†æ˜¯è¿™æ ·çœŸçš„å°±ç®—å¥½äº†å—ï¼Œå½“ç„¶ä¸èƒ½è¿™æ ·ï¼Œè¿™ä¸ª <code>buffer</code> ä¸ªæ¯è¯·æ±‚éƒ½è¦åˆ›å»ºä¸€æ¬¡ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥è€ƒè™‘ä¸€ä¸‹å¤ç”¨å‘¢ï¼Œä½¿ç”¨ <code>sync.Pool</code> å»ºç«‹ä¸€ä¸ªç¼“å†²æ± æ•ˆæœå°±æ›´å¥½äº†ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¼˜åŒ–è¯»å–è¯·æ±‚çš„ç®€åŒ–ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> adapter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"bytes"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/json-iterator/go"</span></span><br><span class="line"><span class="string">"github.com/sirupsen/logrus"</span></span><br><span class="line"><span class="string">"github.com/thinkeridea/go-extend/exbytes"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Adapter <span class="keyword">struct</span> &#123;</span><br><span class="line">pool sync.Pool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Adapter</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Adapter&#123;</span><br><span class="line">pool: sync.Pool&#123;</span><br><span class="line">New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">return</span> bytes.NewBuffer(<span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>))</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *Adapter)</span> <span class="title">GetRequest</span><span class="params">(r *http.Request)</span> <span class="params">(*Request, error)</span></span> &#123;</span><br><span class="line">buffer := api.pool.Get().(*bytes.Buffer)</span><br><span class="line">buffer.Reset()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> buffer != <span class="literal">nil</span> &#123;</span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">_, err := io.Copy(buffer, r.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request := &amp;Request&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> err = jsoniter.Unmarshal(buffer.Bytes(), request); err != <span class="literal">nil</span> &#123;</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"json"</span>: exbytes.ToString(buffer.Bytes()),</span><br><span class="line">&#125;).Errorf(<span class="string">"jsoniter.UnmarshalJSON fail. error:%v"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> request, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>sync.Pool</code> çš„æ–¹å¼æ˜¯ä¸æ˜¯æœ‰ç‚¹æ€ªï¼Œä¸»è¦æ˜¯ <code>defer</code> å’Œ <code>api.pool.Put(buffer)ï¼›buffer = nil</code> è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œä¸ºäº†æé«˜ <code>buufer</code> çš„å¤ç”¨ç‡ä¼šåœ¨ä¸ä½¿ç”¨æ—¶å°½å¿«æŠŠ <code>buffer</code> æ”¾å›åˆ°ç¼“å†²æ± ä¸­ï¼Œ<code>defer</code> ä¹‹æ‰€ä»¥ä¼šåˆ¤æ–­ <code>buffer != nil</code> ä¸»è¦æ˜¯åœ¨ä¸šåŠ¡é€»è¾‘å‡ºç°é”™è¯¯æ—¶ï¼Œä½†æ˜¯ <code>buffer</code> è¿˜æ²¡æœ‰æ”¾å›ç¼“å†²æ± æ—¶æŠŠ <code>buffer</code> æ”¾å›åˆ°ç¼“å†²æ± ï¼Œå› ä¸ºåœ¨æ¯ä¸ªé”™è¯¯å¤„ç†ä¹‹åéƒ½å†™ <code>api.pool.Put(buffer)</code> ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ³•ï¼Œè€Œä¸”å®¹æ˜“å¿˜è®°ï¼Œä½†æ˜¯å¦‚æœåœ¨ç¡®å®šä¸å†ä½¿ç”¨æ—¶ <code>api.pool.Put(buffer)ï¼›buffer = nil</code> å°±å¯ä»¥å°½æ—©æŠŠ <code>buffer</code> æ”¾å›åˆ°ç¼“å†²æ± ä¸­ï¼Œæé«˜å¤ç”¨ç‡ï¼Œå‡å°‘æ–°å»º <code>buffer</code>ã€‚</p><p>è¿™æ ·å°±å¥½äº†å—ï¼Œåˆ«æ€¥ï¼Œä¹‹å‰è¯´æœåŠ¡é‡Œé¢è¿˜ä¼šæ„å»ºè¯·æ±‚ï¼Œçœ‹çœ‹æ„å»ºè¯·æ±‚å¦‚ä½•ä¼˜åŒ–å§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> adapter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"bytes"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/json-iterator/go"</span></span><br><span class="line"><span class="string">"github.com/sirupsen/logrus"</span></span><br><span class="line"><span class="string">"github.com/thinkeridea/go-extend/exbytes"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Adapter <span class="keyword">struct</span> &#123;</span><br><span class="line">pool sync.Pool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Adapter</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Adapter&#123;</span><br><span class="line">pool: sync.Pool&#123;</span><br><span class="line">New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">return</span> bytes.NewBuffer(<span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>))</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *Adapter)</span> <span class="title">Request</span><span class="params">(r *Request)</span> <span class="params">(*Response, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">buffer := api.pool.Get().(*bytes.Buffer)</span><br><span class="line">buffer.Reset()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> buffer != <span class="literal">nil</span> &#123;</span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">e := jsoniter.NewEncoder(buffer)</span><br><span class="line">err = e.Encode(r)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"request"</span>: r,</span><br><span class="line">&#125;).Errorf(<span class="string">"jsoniter.Marshal failure: %v"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"jsoniter.Marshal failure: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data := buffer.Bytes()</span><br><span class="line">req, err := http.NewRequest(<span class="string">"POST"</span>, <span class="string">"http://xxx.com"</span>, buffer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"data"</span>: exbytes.ToString(data),</span><br><span class="line">&#125;).Errorf(<span class="string">"http.NewRequest failed: %v"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"http.NewRequest failed: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"xxx"</span>)</span><br><span class="line"></span><br><span class="line">httpResponse, err := http.DefaultClient.Do(req)</span><br><span class="line"><span class="keyword">if</span> httpResponse != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">io.Copy(ioutil.Discard, httpResponse.Body)</span><br><span class="line">httpResponse.Body.Close()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"url"</span>: <span class="string">"http://xxx.com"</span>,</span><br><span class="line">&#125;).Errorf(<span class="string">"query service failed %v"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"query service failed %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> httpResponse.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"url"</span>:         <span class="string">"http://xxx.com"</span>,</span><br><span class="line"><span class="string">"status"</span>:      httpResponse.Status,</span><br><span class="line"><span class="string">"status_code"</span>: httpResponse.StatusCode,</span><br><span class="line">&#125;).Errorf(<span class="string">"invalid http status code"</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"invalid http status code"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buffer.Reset()</span><br><span class="line">_, err = io.Copy(buffer, httpResponse.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"adapter io.copy failure error:%v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">respData := buffer.Bytes()</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"response_json"</span>: exbytes.ToString(respData),</span><br><span class="line">&#125;).Debug(<span class="string">"response json"</span>)</span><br><span class="line"></span><br><span class="line">res := &amp;Response&#123;&#125;</span><br><span class="line">err = jsoniter.Unmarshal(respData, res)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logrus.WithFields(logrus.Fields&#123;</span><br><span class="line"><span class="string">"data"</span>: exbytes.ToString(respData),</span><br><span class="line"><span class="string">"url"</span>:  <span class="string">"http://xxx.com"</span>,</span><br><span class="line">&#125;).Errorf(<span class="string">"adapter jsoniter.Unmarshal failed, error:%v"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"adapter jsoniter.Unmarshal failed, error:%v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¤ºä¾‹å’Œä¹‹å‰å·®ä¸å¤šï¼Œåªæ˜¯ä¸ä»…ç”¨æ¥è¯»å– <code>http.Response.Body</code> è¿˜ç”¨æ¥åˆ›å»ºä¸€ä¸ª <code>jsoniter.NewEncoder</code> ç”¨æ¥æŠŠè¯·æ±‚å‹ç¼©æˆ <code>json</code> å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ä½œä¸º <code>http.NewRequest</code> çš„ <code>body</code> å‚æ•°ï¼Œ å¦‚æœç›´æ¥ç”¨ <code>jsoniter.Marshal</code> åŒæ ·ä¼šåˆ›å»ºå¾ˆå¤šæ¬¡å†…å­˜ï¼Œ<code>jsoniter</code> ä¹Ÿä½¿ç”¨ <code>buffer</code> åšä¸ºç¼“å†²åŒºï¼Œå¹¶ä¸”é»˜è®¤å¤§å°ä¸º <code>512</code>, ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cfg Config)</span> <span class="title">Froze</span><span class="params">()</span> <span class="title">API</span></span> &#123;</span><br><span class="line">api := &amp;frozenConfig&#123;</span><br><span class="line">sortMapKeys:                   cfg.SortMapKeys,</span><br><span class="line">indentionStep:                 cfg.IndentionStep,</span><br><span class="line">objectFieldMustBeSimpleString: cfg.ObjectFieldMustBeSimpleString,</span><br><span class="line">onlyTaggedField:               cfg.OnlyTaggedField,</span><br><span class="line">disallowUnknownFields:         cfg.DisallowUnknownFields,</span><br><span class="line">&#125;</span><br><span class="line">api.streamPool = &amp;sync.Pool&#123;</span><br><span class="line">New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">return</span> NewStream(api, <span class="literal">nil</span>, <span class="number">512</span>)</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// .....</span></span><br><span class="line"><span class="keyword">return</span> api</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œä¸”åºåˆ—åŒ–ä¹‹åä¼šè¿›è¡Œä¸€æ¬¡æ•°æ®æ‹·è´ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cfg *frozenConfig)</span> <span class="title">Marshal</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">stream := cfg.BorrowStream(<span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">defer</span> cfg.ReturnStream(stream)</span><br><span class="line">stream.WriteVal(v)</span><br><span class="line"><span class="keyword">if</span> stream.Error != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, stream.Error</span><br><span class="line">&#125;</span><br><span class="line">result := stream.Buffer()</span><br><span class="line">copied := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(result))</span><br><span class="line"><span class="built_in">copy</span>(copied, result)</span><br><span class="line"><span class="keyword">return</span> copied, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è¦ç”¨ <code>buffer</code> é‚£å°±ä¸€èµ·å§^_^ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¤šæ¬¡å†…å­˜åˆ†é…ï¼Œä¸‹è¯»å– <code>http.Response.Body</code> ä¹‹å‰ä¸€å®šè¦è®°å¾— <code>buffer.Reset()</code>ï¼Œ è¿™æ ·åŸºæœ¬å°±å·²ç»å®Œæˆäº† <code>http.Request.Body</code> å’Œ <code>http.Response.Body</code> çš„æ•°æ®è¯»å–ä¼˜åŒ–äº†ï¼Œå…·ä½“æ•ˆæœç­‰ä¸Šçº¿è·‘ä¸€æ®µæ—¶é—´ç¨³å®šä¹‹åæ¥æŸ¥çœ‹å§ã€‚</p><h2 id="æ•ˆæœåˆ†æ"><a href="#æ•ˆæœåˆ†æ" class="headerlink" title="æ•ˆæœåˆ†æ"></a>æ•ˆæœåˆ†æ</h2><p>ä¸Šçº¿è·‘äº†ä¸€å¤©ï¼Œæ¥çœ‹çœ‹æ•ˆæœå§</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof allocs2</span><br><span class="line">File: connect_server</span><br><span class="line">Type: alloc_space</span><br><span class="line">Time: Jan <span class="number">26</span>, <span class="number">2019</span> at <span class="number">10</span>:<span class="number">27</span>am (CST)</span><br><span class="line">Entering interactive mode (type <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">295.40</span>GB, <span class="number">40.62</span>% of <span class="number">727.32</span>GB total</span><br><span class="line">Dropped <span class="number">738</span> nodes (cum &lt;= <span class="number">3.64</span>GB)</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">174</span></span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">   <span class="number">73.52</span>GB <span class="number">10.11</span>% <span class="number">10.11</span>%    <span class="number">73.52</span>GB <span class="number">10.11</span>%  git.tvblack.com/tvblack/connect_server/vendor/github.com/sirupsen/logrus.(*Entry).WithFields</span><br><span class="line">   <span class="number">31.70</span>GB  <span class="number">4.36</span>% <span class="number">14.47</span>%    <span class="number">31.70</span>GB  <span class="number">4.36</span>%  net/url.unescape</span><br><span class="line">   <span class="number">27.49</span>GB  <span class="number">3.78</span>% <span class="number">18.25</span>%    <span class="number">54.87</span>GB  <span class="number">7.54</span>%  git.tvblack.com/tvblack/connect_server/models.LogItemsToBytes</span><br><span class="line">   <span class="number">27.41</span>GB  <span class="number">3.77</span>% <span class="number">22.01</span>%    <span class="number">27.41</span>GB  <span class="number">3.77</span>%  strings.Join</span><br><span class="line">   <span class="number">25.04</span>GB  <span class="number">3.44</span>% <span class="number">25.46</span>%    <span class="number">25.04</span>GB  <span class="number">3.44</span>%  bufio.NewWriterSize</span><br><span class="line">   <span class="number">24.81</span>GB  <span class="number">3.41</span>% <span class="number">28.87</span>%    <span class="number">24.81</span>GB  <span class="number">3.41</span>%  bufio.NewReaderSize</span><br><span class="line">   <span class="number">23.91</span>GB  <span class="number">3.29</span>% <span class="number">32.15</span>%    <span class="number">23.91</span>GB  <span class="number">3.29</span>%  regexp.(*bitState).reset</span><br><span class="line">   <span class="number">23.06</span>GB  <span class="number">3.17</span>% <span class="number">35.32</span>%    <span class="number">23.06</span>GB  <span class="number">3.17</span>%  math/big.nat.make</span><br><span class="line">   <span class="number">19.90</span>GB  <span class="number">2.74</span>% <span class="number">38.06</span>%    <span class="number">20.35</span>GB  <span class="number">2.80</span>%  git.tvblack.com/tvblack/connect_server/vendor/github.com/json-iterator/go.(*Iterator).readStringSlowPath</span><br><span class="line">   <span class="number">18.58</span>GB  <span class="number">2.56</span>% <span class="number">40.62</span>%    <span class="number">19.12</span>GB  <span class="number">2.63</span>%  net/textproto.(*Reader).ReadMIMEHeader</span><br></pre></td></tr></table></figure><p>å“‡å¡ <code>bytes.makeSlice</code> ç»ˆäºä»å‰åä¸­æ¶ˆå¤±äº†ï¼ŒçœŸçš„å¤ªæ£’äº†ï¼Œè¿˜æ˜¯çœ‹çœ‹ <code>bytes.makeSlice</code> çš„å…¶å®ƒè°ƒç”¨æƒ…å†µå§ã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(pprof) web bytes.makeSlice</span><br></pre></td></tr></table></figure><p><img src="/assets/image/20190126/3.jpg" alt="image-3"></p><p>ä»å›¾ä¸­å¯ä»¥å‘ç° <code>bytes.makeSlice</code> çš„åˆ†é…å·²ç»å¾ˆå°äº†ï¼Œ ä¸”å¤§å¤šæ•°æ˜¯ <code>http.Request.ParseForm</code> è¯»å– <code>http.Request.Body</code> ä½¿ç”¨ <code>ioutil.ReadAll</code> åŸå› ï¼Œè¿™æ¬¡ä¼˜åŒ–çš„æ•ˆæœéå¸¸çš„å¥½ã€‚</p><p>çœ‹ä¸€ä¸‹æ›´ç›´è§‚çš„ç«ç„°å›¾ğŸ”¥å§ï¼Œå’Œä¼˜åŒ–å‰å¯¹æ¯”ä¸€ä¸‹å¾ˆæ˜æ˜¾ <code>ioutil.ReadAll</code> çœ‹ä¸åˆ°äº†</p><p><img src="/assets/image/20190126/4.jpg" alt="image-4"></p><h2 id="ä¼˜åŒ–æœŸé—´é‡åˆ°çš„é—®é¢˜"><a href="#ä¼˜åŒ–æœŸé—´é‡åˆ°çš„é—®é¢˜" class="headerlink" title="ä¼˜åŒ–æœŸé—´é‡åˆ°çš„é—®é¢˜"></a>ä¼˜åŒ–æœŸé—´é‡åˆ°çš„é—®é¢˜</h2><p>æ¯”è¾ƒæƒ­æ„§åœ¨ä¼˜åŒ–çš„è¿‡ç¨‹å‡ºç°äº†ä¸€ä¸ªè¿‡å¤±ï¼Œå¯¼è‡´ç”Ÿäº§ç¯å¢ƒ2åˆ†é’Ÿæ•…éšœï¼Œé€šè¿‡è‡ªåŠ¨éƒ¨ç½²ç«‹å³å›æ»šæ‰å¾—ä»¥å¿«é€Ÿæ¢å¤ï¼Œä¹‹ååˆ†æä»£ç è§£å†³ä¹‹åä¸Šçº¿æ‰å®Œç¾ä¼˜åŒ–ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹å‡ºç°çš„é—®é¢˜å§ã€‚</p><p>åœ¨æ„å»º <code>http</code> è¯·æ±‚æ—¶æˆ‘åˆ†äº†ä¸¤ä¸ªéƒ¨åˆ†ä¼˜åŒ–ï¼Œåºåˆ—åŒ– <code>json</code> å’Œè¯»å– <code>http.Response.Body</code> æ•°æ®ï¼Œä¿æŒä¸€ä¸ªè§‚ç‚¹å°±æ˜¯å°½æ—©æŠŠ <code>buffer</code> æ”¾å›åˆ°ç¼“å†²æ± ï¼Œå› ä¸º <code>http.DefaultClient.Do(req)</code> æ˜¯ç½‘ç»œè¯·æ±‚ä¼šç›¸å¯¹è€—æ—¶ï¼Œåœ¨è¿™ä¸ªä¹‹å‰æˆ‘æŠŠ <code>buffer</code> æ”¾å›åˆ°ç¼“å†²æ± ä¸­ï¼Œä¹‹åè¯»å– <code>http.Response.Body</code> æ—¶åœ¨é‡æ–°è·å–ä¸€ä¸ª <code>buffer</code>ï¼Œå¤§æ¦‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> adapter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"bytes"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/json-iterator/go"</span></span><br><span class="line"><span class="string">"github.com/sirupsen/logrus"</span></span><br><span class="line"><span class="string">"github.com/thinkeridea/go-extend/exbytes"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Adapter <span class="keyword">struct</span> &#123;</span><br><span class="line">pool sync.Pool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Adapter</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Adapter&#123;</span><br><span class="line">pool: sync.Pool&#123;</span><br><span class="line">New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">return</span> bytes.NewBuffer(<span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>))</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *Adapter)</span> <span class="title">Request</span><span class="params">(r *Request)</span> <span class="params">(*Response, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">buffer := api.pool.Get().(*bytes.Buffer)</span><br><span class="line">buffer.Reset()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> buffer != <span class="literal">nil</span> &#123;</span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">e := jsoniter.NewEncoder(buffer)</span><br><span class="line">err = e.Encode(r)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"jsoniter.Marshal failure: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data := buffer.Bytes()</span><br><span class="line">req, err := http.NewRequest(<span class="string">"POST"</span>, <span class="string">"http://xxx.com"</span>, buffer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"http.NewRequest failed: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"xxx"</span>)</span><br><span class="line"></span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">httpResponse, err := http.DefaultClient.Do(req)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">buffer = api.pool.Get().(*bytes.Buffer)</span><br><span class="line">buffer.Reset()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> buffer != <span class="literal">nil</span> &#123;</span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">_, err = io.Copy(buffer, httpResponse.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"adapter io.copy failure error:%v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">api.pool.Put(buffer)</span><br><span class="line">buffer = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šçº¿ä¹‹åé©¬ä¸Šå‘ç”Ÿäº†é”™è¯¯ <code>http: ContentLength=2090 with Body length 0</code> å‘é€è¯·æ±‚çš„æ—¶å€™ä» <code>buffer</code> è¯»å–æ•°æ®å‘ç°æ•°æ®ä¸è§äº†æˆ–è€…æ•°æ®ä¸å¤Ÿäº†ï¼Œæˆ‘å»è¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Œé©¬ä¸Šå›æ»šæ¢å¤ä¸šåŠ¡ï¼Œç„¶ååˆ†æ <code>http.DefaultClient.Do(req)</code> å’Œ <code>http.NewRequest</code>ï¼Œåœ¨è°ƒç”¨ <code>http.NewRequest</code> æ˜¯å¹¶æ²¡æœ‰ä» <code>buffer</code> è¯»å–æ•°æ®ï¼Œè€Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª <code>req.GetBody</code> ä¹‹ååœ¨ <code>http.DefaultClient.Do</code> æ˜¯æ‰è¯»å–æ•°æ®ï¼Œå› ä¸ºåœ¨ <code>http.DefaultClient.Do</code> ä¹‹å‰æŠŠ <code>buffer</code> æ”¾å›åˆ°ç¼“å†²æ± ä¸­ï¼Œå…¶å®ƒ <code>goroutine</code> è·å–åˆ° <code>buffer</code> å¹¶è¿›è¡Œ <code>Reset</code> å°±å‘ç”Ÿäº†æ•°æ®äº‰ç”¨ï¼Œå½“ç„¶ä¼šå¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´äº†ï¼ŒçœŸå®æ±—é¢œï¼Œå¯¹ <code>http.Client</code> äº†è§£å¤ªå°‘ï¼Œäº‰å–æœ‰ç©ºæ’¸ä¸€éæºç ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½¿ç”¨åˆé€‚å¤§å°çš„ <code>buffer</code> æ¥å‡å°‘å†…å­˜åˆ†é…ï¼Œ<code>sync.Pool</code> å¯ä»¥å¸®åŠ©å¤ç”¨ <code>buffer</code>ï¼Œ ä¸€å®šè¦è‡ªå·±å†™è¿™äº›é€»è¾‘ï¼Œé¿å…ä½¿ç”¨ä¸‰æ–¹åŒ…ï¼Œä¸‰æ–¹åŒ…å³ä½¿ä½¿ç”¨åŒæ ·çš„æŠ€å·§ä¸ºäº†é¿å…æ•°æ®äº‰ç”¨ï¼Œåœ¨è¿”å›æ•°æ®æ—¶å€™å¿…ç„¶ä¼šæ‹·è´ä¸€ä¸ªæ–°çš„æ•°æ®è¿”å›ï¼Œå°±åƒ <code>jsoniter</code> è™½ç„¶ä½¿ç”¨äº† <code>sync.Pool</code> å’Œ <code>buffer</code> ä½†æ˜¯è¿”å›æ•°æ®æ—¶è¿˜éœ€è¦æ‹·è´ï¼Œå¦å¤–è¿™ç§é€šç”¨åŒ…å¹¶ä¸èƒ½ç»™ä¸€ä¸ªéå¸¸è´´åˆä¸šåŠ¡çš„åˆå§‹ <code>buffer</code> å¤§å°ï¼Œè¿‡å°ä¼šå¯¼è‡´æ•°æ®å‘ç”Ÿæ‹·è´ï¼Œè¿‡å¤§ä¼šå¤ªè¿‡æµªè´¹å†…å­˜ã€‚</p><p>ç¨‹åºä¸­å–„ç”¨ <code>buffer</code> å’Œ <code>sync.Pool</code> å¯ä»¥å¤§å¤§çš„æ”¹å–„ç¨‹åºçš„æ€§èƒ½ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªç»„åˆåœ¨ä¸€èµ·ä½¿ç”¨éå¸¸çš„ç®€å•ï¼Œå¹¶ä¸ä¼šä½¿ä»£ç å˜çš„å¤æ‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä» &lt;code&gt;http.Request.Body&lt;/code&gt; æˆ– &lt;code&gt;http.Response.Body&lt;/code&gt; ä¸­è¯»å–æ•°æ®æ–¹æ³•æˆ–è®¸å¾ˆå¤šï¼Œæ ‡å‡†åº“ä¸­å¤§å¤šæ•°ä½¿ç”¨ &lt;code&gt;ioutil.ReadAll&lt;/code&gt; æ–¹æ³•ä¸€æ¬¡è¯»å–æ‰€æœ‰æ•°æ®ï¼Œå¦‚æœæ˜¯ &lt;code&gt;json&lt;/code&gt; æ ¼å¼çš„æ•°æ®è¿˜å¯ä»¥ä½¿ç”¨ &lt;code&gt;json.NewDecoder&lt;/code&gt; ä» &lt;code&gt;io.Reader&lt;/code&gt; åˆ›å»ºä¸€ä¸ªè§£æå™¨ï¼Œå‡ä½¿ä½¿ç”¨ &lt;code&gt;pprof&lt;/code&gt; æ¥åˆ†æç¨‹åºæ€»æ˜¯ä¼šå‘ç° &lt;code&gt;bytes.makeSlice&lt;/code&gt; åˆ†é…äº†å¤§é‡å†…å­˜ï¼Œä¸”æ€»æ˜¯æ’è¡Œç¬¬ä¸€ï¼Œä»Šå¤©å°±è¿™ä¸ªé—®é¢˜æ¥è¯´ä¸€ä¸‹å¦‚ä½•é«˜æ•ˆä¼˜é›…çš„è¯»å– &lt;code&gt;http&lt;/code&gt; ä¸­çš„æ•°æ®ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="https://blog.thinkeridea.com/categories/go/"/>
    
    
      <category term="net.http" scheme="https://blog.thinkeridea.com/tags/net-http/"/>
    
      <category term="http" scheme="https://blog.thinkeridea.com/tags/http/"/>
    
      <category term="pool" scheme="https://blog.thinkeridea.com/tags/pool/"/>
    
      <category term="bytes" scheme="https://blog.thinkeridea.com/tags/bytes/"/>
    
      <category term="buffer" scheme="https://blog.thinkeridea.com/tags/buffer/"/>
    
      <category term="makeSlice" scheme="https://blog.thinkeridea.com/tags/makeslice/"/>
    
      <category term="ioutil" scheme="https://blog.thinkeridea.com/tags/ioutil/"/>
    
  </entry>
  
  <entry>
    <title>ã€Goã€‘sliceçš„ä¸€äº›ä½¿ç”¨æŠ€å·§</title>
    <link href="https://blog.thinkeridea.com/201901/go/slice_de_yi_xie_shi_yong_ji_qiao.html"/>
    <id>https://blog.thinkeridea.com/201901/go/slice_de_yi_xie_shi_yong_ji_qiao.html</id>
    <published>2019-01-22T22:34:57.000Z</published>
    <updated>2019-01-26T12:01:42.402Z</updated>
    
    <content type="html"><![CDATA[<p><code>slice</code> æ˜¯ <code>Go</code> è¯­è¨€ååˆ†é‡è¦çš„æ•°æ®ç±»å‹ï¼Œå®ƒæ‰¿è½½ç€å¾ˆå¤šä½¿å‘½ï¼Œä»è¯­è¨€å±‚é¢æ¥çœ‹æ˜¯ <code>Go</code> è¯­è¨€çš„å†…ç½®æ•°æ®ç±»å‹ï¼Œä»æ•°æ®ç»“æ„æ¥çœ‹æ˜¯åŠ¨æ€é•¿åº¦çš„é¡ºåºé“¾è¡¨ï¼Œç”±äº <code>Go</code> ä¸èƒ½ç›´æ¥æ“ä½œå†…å­˜ï¼ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨å¯ä»¥å®ç°ï¼Œä½†æ˜¯è¯­è¨€æœ¬èº«å¹¶ä¸æ”¯æŒï¼‰ï¼Œå¾€å¾€ <code>slice</code> ä¹Ÿå¯ä»¥ç”¨æ¥å¸®åŠ©å¼€å‘è€…ç”³è¯·å¤§å—å†…å­˜å®ç°ç¼“å†²ã€ç¼“å­˜ç­‰åŠŸèƒ½ã€‚</p><p>åœ¨ <code>Go</code> è¯­è¨€é¡¹ç›®ä¸­å¤§é‡çš„ä½¿ç”¨ <code>slice</code>, æˆ‘æ€»ç»“ä¸‰å¹´æ¥å¯¹ <code>slice</code> çš„ä¸€äº›æ“ä½œæŠ€å·§ï¼Œä»¥æ–¹ä¾¿å¯ä»¥é«˜æ•ˆçš„ä½¿ç”¨ <code>slice</code>ï¼Œ å¹¶ä½¿ç”¨ <code>slice</code> è§£å†³ä¸€äº›æ£˜æ‰‹çš„é—®é¢˜ã€‚</p><h2 id="slice-çš„åŸºæœ¬æ“ä½œ"><a href="#slice-çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="slice çš„åŸºæœ¬æ“ä½œ"></a>slice çš„åŸºæœ¬æ“ä½œ</h2><p>å…ˆç†Ÿæ‚‰ä¸€äº› <code>slice</code> çš„åŸºæœ¬çš„æ“ä½œ, å¯¹æœ€å¸¸è§„çš„ <code>:</code> æ“ä½œå°±å¯ç©å‡ºå¾ˆå¤šèŠ±æ ·ã€‚</p><ul><li><code>s=ss[:]</code> å¼•ç”¨ä¸€ä¸ªåˆ‡ç‰‡æˆ–æ•°ç»„</li><li><code>s=s[:0]</code> æ¸…ç©ºåˆ‡ç‰‡</li><li><code>s=s[:10]</code> <code>s=s[10:]</code> <code>s=s[10:20]</code> æˆªå–æ¥ç‰‡</li><li><code>s=ss[0:10:20]</code> ä»åˆ‡ç‰‡æˆ–æ•°ç»„å¼•ç”¨æŒ‡å®šé•¿åº¦å’Œå®¹é‡çš„åˆ‡ç‰‡</li></ul><p>ä¸‹æ ‡ç´¢å¼•æ“ä½œçš„ä¸€äº›è¯¯åŒº <code>s[i:l:c]</code> <code>i</code> æ˜¯èµ·å§‹åç§»çš„èµ·å§‹ä½ç½®ï¼Œ<code>l</code> æ˜¯èµ·å§‹åç§»çš„é•¿åº¦ç»“æŸä½ç½®ï¼Œ <code>l-i</code> å°±æ˜¯æ–° <code>slice</code> çš„é•¿åº¦ï¼Œ <code>c</code> æ˜¯èµ·å§‹åç§»çš„å®¹é‡ç»“æŸä½ç½®ï¼Œ<code>c-i</code> å°±æ˜¯æ–° <code>slice</code> çš„å®¹é‡ã€‚å…¶ä¸­ <code>i</code> ã€<code>l</code> ã€<code>c</code> å¹¶ä¸æ˜¯å½“å‰ <code>slice</code> çš„ç´¢å¼•ï¼Œè€Œæ˜¯å¼•ç”¨åº•å±‚æ•°ç»„ç›¸å¯¹å½“å‰ <code>slice</code> èµ·å§‹ä½ç½®çš„åç§»é‡ï¼Œæ‰€ä»¥æ˜¯å¯è¶…å‡ºå½“å‰ <code>slice</code> çš„é•¿åº¦çš„ï¼Œ ä½†ä¸èƒ½è¶…å‡ºå½“å‰ <code>slice</code> çš„å®¹é‡ï¼Œå¦‚ä¸‹æ“ä½œæ˜¯åˆæ³•çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line">s[<span class="number">20</span>] = <span class="number">100</span></span><br><span class="line">s1 := s[<span class="number">10</span>:<span class="number">10</span>]</span><br><span class="line">s2 := s1[<span class="number">10</span>:<span class="number">20</span>]</span><br><span class="line">fmt.Println(s1)</span><br><span class="line">fmt.Println(s2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>s1</code> æ˜¯ <code>[]</code>ï¼›<code>s2</code> æ˜¯ <code>[100 0 0 0 0 0 0 0 0 0]</code>, è¿™é‡Œå¹¶ä¸ä¼šå‘ç”Ÿä¸‹æ ‡è¶Šç•Œçš„æƒ…å†µï¼Œä¸€ä¸ªæ›´å¥½çš„ä¾‹å­åœ¨ <a href="#csv-reader-ä¸­çš„ä¸€ä¸ªä¾‹å­">csv reader ä¸­çš„ä¸€ä¸ªä¾‹å­</a></p><a id="more"></a><p><strong>åˆ›å»º slice</strong></p><p>åˆ›å»ºåˆ‡ç‰‡çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¸‹é¢ç½—åˆ—ä¸€äº›å¸¸è§„çš„ï¼š</p><ul><li><code>var s []int</code> åˆ›å»º nilåˆ‡ç‰‡</li><li><code>s := make([]int, 0, 0)</code> ã€ <code>s=[]int{}</code> åˆ›å»ºæ— å®¹é‡ç©ºåˆ‡ç‰‡</li><li><code>s:= make([]int, 0, 100)</code> åˆ›å»ºæœ‰å®¹é‡ç©ºåˆ‡ç‰‡</li><li><code>s:=make([]int, 100)</code> åˆ›å»ºé›¶å€¼åˆ‡ç‰‡</li><li><code>s:=array[:]</code> å¼•ç”¨æ•°ç»„åˆ›å»ºåˆ‡ç‰‡</li></ul><p><strong>å†…ç½®å‡½æ•°</strong></p><ul><li><code>len(s)</code> è·å–åˆ‡ç‰‡çš„é•¿åº¦</li><li><code>cap(s)</code> è·å–åˆ‡ç‰‡çš„å®¹é‡</li><li><code>append(s, ...)</code> å‘åˆ‡ç‰‡è¿½åŠ å†…å®¹</li><li><code>copy(s, s1)</code> å‘åˆ‡ç‰‡æ‹·è´å†…å®¹</li></ul><h2 id="ä¸€ä¸ªç¼“å†²çš„ç®€å•ç¤ºä¾‹"><a href="#ä¸€ä¸ªç¼“å†²çš„ç®€å•ç¤ºä¾‹" class="headerlink" title="ä¸€ä¸ªç¼“å†²çš„ç®€å•ç¤ºä¾‹"></a>ä¸€ä¸ªç¼“å†²çš„ç®€å•ç¤ºä¾‹</h2><p>é‡åˆ°è¿‡å¾ˆå¤šæ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œå„ç§å„æ ·çš„éƒ½æœ‰ <code>fmt</code> <code>builder</code> <code>buffer</code> <code>+</code> ç­‰ç­‰ï¼Œå®é™…ä¸Š <code>builder</code> å’Œ <code>buffer</code> éƒ½æ˜¯ä½¿ç”¨ <code>[]byte</code> çš„åˆ‡ç‰‡ä½œä¸ºç¼“å†²æ¥å®ç°çš„ï¼Œ<code>fmt</code> å¾€å¾€æ€§èƒ½æœ€å·®ï¼ŒåŸå› æ˜¯å®ƒä¸»è¦åŠŸèƒ½ä¸æ˜¯è¿æ¥å­—ç¬¦ä¸²è€Œæ˜¯æ ¼å¼åŒ–æ•°æ®ä¼šç”¨åˆ°åå°„ç­‰ç­‰æ“ä½œã€‚<code>+</code> æ“ä½œåœ¨å¤§é‡æ‹¼æ¥æ—¶æ€§èƒ½ä¹Ÿæ˜¯å¾ˆå·®ï¼Œ ä¸è¿‡å°å­—ç¬¦ä¸²å°‘é‡æ‹¼æ¥æ•ˆæœå¾ˆç†æƒ³ï¼Œ<code>builder</code> å¾€å¾€æ€§èƒ½ä¸å¦‚ <code>buffer</code> ç‰¹åˆ«æ˜¯åœ¨è¾ƒçŸ­å­—ç¬¦ä¸²æ‹¼æ¥ä¸Šï¼Œå®é™… <code>builder</code> å’Œ <code>buffer</code> å®ç°åŸç†éå¸¸ç±»ä¼¼ï¼Œ<code>builder</code> åœ¨è½¬æˆå­—ç¬¦ä¸²æ—¶ä½¿ç”¨äº† <code>unsafe</code> å‡å°‘äº†ä¸€æ¬¡å†…å­˜åˆ†é…ï¼Œå› ä¸ºå°å­—ç¬¦ä¸²å› ä¸ºæ‰©å®¹æœºåˆ¶ä¸å¦‚ <code>buffer</code> çµæ´»ï¼Œæ‰€ä»¥æ€§èƒ½æœ‰æ‰€ä¸å¦‚ï¼Œå¤§å­—ç¬¦ä¸²é™ä½ä¸€æ¬¡å¤§çš„å†…å­˜åˆ†é…å°±æ˜¾å¾—å¾ˆæ˜æ˜¾äº†ã€‚</p><p>ç»å¸¸é‡åˆ°ä¸€ä¸ªéœ€æ±‚å°±æ˜¯æ‹¼æ¥ <code>[]int</code> ä¸­ä¸ªå„ä¸ªå…ƒç´ ï¼Œå¾ˆå¤šç§å®ç°éƒ½æœ‰äººç”¨ï¼Œéƒ½æ˜¯éœ€è¦éå†è½¬æ¢ <code>int</code> åˆ° <code>string</code>ï¼Œä½†æ˜¯æ‹¼æ¥æ–¹æ³•åƒå¥‡ç™¾æ€ªï¼Œä»¥ä¸‹æä¾›ä¸¤ç§æ–¹æ³•å¯¹æ¯”ï¼ˆ<a href="https://github.com/thinkeridea/example/blob/master/slice/slice_int_to_string.go" target="_blank" rel="noopener">æºç åœ¨GitHub</a>ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> slice</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"strconv"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SliceInt2String1</span><span class="params">(s []<span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ss := strconv.Itoa(s[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">ss += <span class="string">","</span> + strconv.Itoa(s[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ss</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SliceInt2String2</span><span class="params">(s []<span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, strconv.Itoa(s[<span class="number">0</span>])...)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">','</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, strconv.Itoa(s[i])...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SliceInt2String3</span><span class="params">(s []<span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, strconv.Itoa(s[<span class="number">0</span>])...)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">','</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, strconv.Itoa(s[i])...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SliceInt2String1</code> ä½¿ç”¨åŸå§‹çš„ <code>+</code> æ“ä½œï¼Œå› ä¸ºæ˜¯è¾ƒå°çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä½¿ç”¨ <code>+</code> ä¸»è¦æ˜¯å› ä¸ºåœ¨å°å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½ä¼˜äºå…¶å®ƒå‡ ç§æ–¹æ³•ï¼Œ<code>SliceInt2String2</code> ä¸ <code>SliceInt2String3</code> éƒ½ä½¿ç”¨äº†ä¸€ä¸ª <code>256</code> å®¹é‡çš„ <code>[]byte</code> ä½œä¸ºç¼“å†²ï¼Œ å”¯ä¸€çš„åŒºåˆ«æ˜¯åœ¨è¿”å›æ—¶ä¸€ä¸ªä½¿ç”¨ <code>string</code> è½¬æ¢ç±»å‹ï¼Œä¸€ä¸ªä½¿ç”¨ <code>unsafe</code> è½¬æ¢ç±»å‹ã€‚</p><p>å†™äº†ä¸€ä¸ªæ€§èƒ½æµ‹è¯•ï¼ˆ<a href="https://github.com/thinkeridea/example/blob/master/slice/slice_int_to_string_test.go" target="_blank" rel="noopener">æºç åœ¨GitHub</a>ï¼‰ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœå§:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">pkg: github.com/thinkeridea/example/slice</span><br><span class="line">BenchmarkSliceInt2String1-8    3000000       461 ns/op     144 B/op       9 allocs/op</span><br><span class="line">BenchmarkSliceInt2String2-8   20000000       117 ns/op      32 B/op       1 allocs/op</span><br><span class="line">BenchmarkSliceInt2String3-8   10000000       144 ns/op     256 B/op       1 allocs/op</span><br><span class="line">PASS</span><br><span class="line">ok  github.com/thinkeridea/example/slice5.928s</span><br></pre></td></tr></table></figure><p>æ˜æ˜¾å¯ä»¥çœ‹å¾—å‡º <code>SliceInt2String2</code> çš„æ€§èƒ½æ˜¯ <code>SliceInt2String1</code> 7å€å·¦å³ï¼Œæå‡å¾ˆæ˜æ˜¾ï¼Œ<code>SliceInt2String2</code> ä¸ <code>SliceInt2String3</code> å·®å¼‚å¾ˆå°ï¼Œä¸»è¦æ˜¯å› ä¸ºä½¿ç”¨ <code>unsafe</code>  è½¬æ¢ç±»å‹å¯¼è‡´å¤§å†…å­˜æ— æ³•é‡Šæ”¾ï¼Œå®é™…è¿™ä¸ªæµ‹è¯•ä¸­è¿æ¥å­—ç¬¦ä¸²åªéœ€è¦ <code>32</code> ä¸ªå­—èŠ‚ï¼Œä½¿ç”¨ <code>unsafe</code> å´å¯¼è‡´ <code>256</code> ä¸ªå­—èŠ‚æ— æ³•è¢«é‡Šæ”¾ï¼Œè¿™ä¹Ÿæ­£æ˜¯ <code>builder</code> å’Œ <code>buffer</code> çš„å·®åˆ«ï¼Œæ‰€ä»¥å°å­—ç¬¦ä¸²æ‹¼æ¥ <code>buffer</code> æ€§èƒ½å¾€å¾€æ›´å¥½ã€‚åœ¨è¿™é‡Œç®€å•çš„é€šè¿‡ <code>[]byte</code> å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°æ¥å®ç°ç¼“å†²ã€‚</p><p>å¦‚æœè¿ç»­æ‹¼æ¥ä¸€ç»„è¿™æ ·çš„æ“ä½œï¼Œæ¯”å¦‚è¾“å…¥ <code>[][]int</code>,  è¾“å‡º <code>[]string</code> ï¼ˆ<a href="https://github.com/thinkeridea/example/blob/master/slice/slice_int_to_string.go#L52" target="_blank" rel="noopener">æºç åœ¨GitHub</a>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> slice</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"strconv"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SliceInt2String4</span><span class="params">(s [][]<span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">res := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(s))</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> s &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(v) &lt; <span class="number">1</span> &#123;</span><br><span class="line">res[i] = <span class="string">""</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res[i] += strconv.Itoa(v[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">1</span>; j &lt; <span class="built_in">len</span>(v); j++ &#123;</span><br><span class="line">res[i] += <span class="string">","</span> + strconv.Itoa(v[j])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SliceInt2String5</span><span class="params">(s [][]<span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">res := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(s))</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> s &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(v) &lt; <span class="number">1</span> &#123;</span><br><span class="line">res[i] = <span class="string">""</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b = b[:<span class="number">0</span>]</span><br><span class="line">b = <span class="built_in">append</span>(b, strconv.Itoa(v[<span class="number">0</span>])...)</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">1</span>; j &lt; <span class="built_in">len</span>(v); j++ &#123;</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">','</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, strconv.Itoa(v[j])...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res[i] = <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SliceInt2String5</code> ä¸­ä½¿ç”¨ <code>b = b[:0]</code>  æ¥ä¿ƒä½¿è¾¾åˆ°åå¤ä½¿ç”¨ä¸€å—ç¼“å†²åŒºï¼Œå†™äº†ä¸€ä¸ªæ€§èƒ½æµ‹è¯•ï¼ˆ<a href="https://github.com/thinkeridea/example/blob/master/slice/slice_int_to_string_test.go#L85" target="_blank" rel="noopener">æºç åœ¨GitHub</a>ï¼‰ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœå§:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">pkg: github.com/thinkeridea/example/slice</span><br><span class="line">BenchmarkSliceInt2String4-8     300000      4420 ns/op    1440 B/op      82 allocs/op</span><br><span class="line">BenchmarkSliceInt2String5-8    1000000      1102 ns/op     432 B/op      10 allocs/op</span><br><span class="line">PASS</span><br><span class="line">ok  github.com/thinkeridea/example/slice8.364s</span><br></pre></td></tr></table></figure><p>è¾ƒ <code>+</code> ç‰ˆæœ¬æå‡æ¥è¿‘4å€çš„æ€§èƒ½ï¼Œè¿™æ˜¯ä½¿ç”¨ <code>slice</code> ä½œä¸ºç¼“å†²åŒºæå¥½çš„æŠ€å·§ï¼Œä½¿ç”¨éå¸¸æ–¹ä¾¿ï¼Œå¹¶ä¸ç”¨ä½¿ç”¨ <code>builder</code> å’Œ <code>buffer</code>ï¼Œ <code>slice</code> æ“ä½œéå¸¸çš„ç®€å•å®ç”¨ã€‚</p><h2 id="append-ä¸-copy"><a href="#append-ä¸-copy" class="headerlink" title="append ä¸ copy"></a>append ä¸ copy</h2><p>å¦‚æœåˆå¹¶å¤šä¸ª <code>slice</code> ä¸ºä¸€ä¸ªï¼Œæœ‰ä¸‰ç§æ–¹å¼æ¥åˆå¹¶ï¼Œä¸»è¦åˆå¹¶å·®å¼‚æ¥æºäºåˆ›å»ºæ–° <code>slice</code> çš„æ–¹æ³•ï¼Œä½¿ç”¨ <code>var news []int</code> æˆ–è€… <code>news:=make([]int, 0, len(s1)+len(s2)....)</code> çš„æ–¹å¼åˆ›å»ºçš„æ–°å˜é‡å°±éœ€è¦ä½¿ç”¨ <code>append</code> æ¥åˆå¹¶ï¼Œå¦‚æœä½¿ç”¨ <code>news:=make([]int, len(s1)+len(s2)....)</code> å°±éœ€è¦ä½¿ç”¨ <code>copy</code> æ¥åˆå¹¶ã€‚ä¸åŒçš„æ–¹æ³•ä¹Ÿæœ‰å·®å¼‚ï¼Œ<code>append</code> å’Œ <code>copy</code> åœ¨è¿™ä¸ªä¾‹å­ä¸­ä¸»è¦å·®å¼‚åœ¨äº <code>append</code> é€‚ç”¨äºé›¶é•¿åº¦çš„åˆå§‹åŒ– <code>slice</code>ï¼Œ <code>copy</code> é€‚ç”¨äºç¡®å®šé•¿åº¦çš„ <code>slice</code>ã€‚</p><p>å†™äº†ä¸€ä¸ªæµ‹è¯•æ¥çœ‹çœ‹ä¸¤è€…çš„å·®å¼‚å§ï¼ˆ<a href="https://github.com/thinkeridea/example/blob/master/slice/append_and_copy_test.go" target="_blank" rel="noopener">æºç åœ¨GitHub</a>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkExperiment3Append1</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line"><span class="keyword">var</span> s []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">20</span>; j++ &#123;</span><br><span class="line">s = <span class="built_in">append</span>(s, []<span class="keyword">int</span>&#123;j, j + <span class="number">1</span>, j + <span class="number">2</span>, j + <span class="number">3</span>, j + <span class="number">4</span>&#125;...)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkExperiment3Append2</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">20</span>; j++ &#123;</span><br><span class="line">s = <span class="built_in">append</span>(s, []<span class="keyword">int</span>&#123;j, j + <span class="number">1</span>, j + <span class="number">2</span>, j + <span class="number">3</span>, j + <span class="number">4</span>&#125;...)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkExperiment3Copy</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line">n := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">20</span>; j++ &#123;</span><br><span class="line">n += <span class="built_in">copy</span>(s[n:], []<span class="keyword">int</span>&#123;j, j + <span class="number">1</span>, j + <span class="number">2</span>, j + <span class="number">3</span>, j + <span class="number">4</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">pkg: github.com/thinkeridea/example/slice</span><br><span class="line">BenchmarkExperiment3Append1-8    2000000       782 ns/op    3024 B/op       6 allocs/op</span><br><span class="line">BenchmarkExperiment3Append2-8   10000000       192 ns/op       0 B/op       0 allocs/op</span><br><span class="line">BenchmarkExperiment3Copy-8      10000000       217 ns/op       0 B/op       0 allocs/op</span><br><span class="line">PASS</span><br><span class="line">ok  github.com/thinkeridea/example/slice6.926s</span><br></pre></td></tr></table></figure><p>ä»ç»“æœä¸Šæ¥çœ‹ä½¿ç”¨æ²¡æœ‰å®¹é‡çš„ <code>append</code> æ€§èƒ½çœŸçš„å¾ˆç³Ÿç³•ï¼Œå®é™…ä¸Šä¸è¦å¯¹æ²¡æœ‰ä»»ä½•å®¹é‡çš„ <code>slice</code> è¿›è¡Œ <code>append</code> æ“ä½œæ˜¯æœ€å¥½çš„å®è·µï¼Œåœ¨å‡†å¤‡ç”¨ <code>append</code> çš„æ—¶å€™åº”è¯¥é¢„å…ˆç»™å®šä¸€ä¸ªå®¹é‡ï¼Œå“ªæ€•è¿™ä¸ªå®¹é‡å¹¶ä¸æ˜¯ç¡®å®šçš„ï¼Œåƒå‰é¢ç¼“å­˜è¿æ¥å­—ç¬¦ä¸²æ—¶ä¸€æ ·ï¼Œå¹¶ä¸èƒ½æ˜ç¡®ä½¿ç”¨çš„ç©ºé—´ï¼Œå…ˆåˆ†é…256ä¸ªå­—èŠ‚ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜çš„æ¬¡æ•°ï¼Œå³ä½¿ç©ºé—´ä¸èƒ½ç”¨å®Œï¼Œä¹Ÿä¸ç”¨å¤ªè¿‡æ‹…å¿ƒæµªè´¹ï¼Œ<code>append</code> æœ¬èº«æ‰©å®¹æœºåˆ¶ä¹Ÿä¼šå¯¼è‡´ç©ºé—´ä¸æ˜¯åˆšåˆšå¥½ç”¨å®Œçš„ï¼Œè€Œåˆå§‹åŒ–çš„å®¹é‡å¾€å¾€ç»“åˆä¸šåŠ¡åœºæ™¯ç»™çš„ä¸€ä¸ªå‡å€¼ï¼Œè¿™æ˜¯å¾ˆå¥½çš„ã€‚</p><p><code>append</code> å’Œ <code>copy</code> åœ¨é¢„å…ˆç¡®å®šé•¿åº¦å’Œå®¹é‡æ—¶ <code>append</code> æ•ˆæœæ›´å¥½ä¸€äº›ï¼Œä¸»è¦åŸå› æ˜¯ <code>copy</code> éœ€è¦ä¸€ä¸ªå˜é‡æ¥è®°å½•ä½ç½®ã€‚ å¦‚æœä½¿ç”¨åœºæ™¯ä¸­æ²¡æœ‰å¼ºåˆ¶é™å®šé•¿åº¦ï¼Œå»ºè®®ä½¿ç”¨ <code>append</code> å› ä¸º <code>append</code> ä¼šæ ¹æ®å®é™…æƒ…å†µå†åšå†…å­˜åˆ†é…ï¼Œè¾ƒ <code>copy</code> ä¹Ÿæ›´åŠ çµæ´»ä¸€äº›ï¼Œ è€Œ <code>copy</code> å¾€å¾€ç”¨åœ¨é•¿åº¦å›ºå®šçš„åœ°æ–¹ï¼Œå¯ä»¥é˜²æ­¢æ•°æ®é•¿åº¦æº¢å‡ºçš„é—®é¢˜ï¼Œä¾‹å¦‚æ ‡å‡†åº“ä¸­ <code>strings.Repeat</code> å‡½æ•°ï¼Œå®ƒé‡‡ç”¨æŒ‡æ•°å¢é•¿çš„æ–¹å¼å¿«é€Ÿå¡«å……æŒ‡å®šæ•°é‡çš„å­—ç¬¦ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ <code>append</code> å°±ä¼šå‘ç”Ÿå¤šä½™çš„å†…å­˜åˆ†é…ï¼Œå¯¼è‡´é•¿åº¦æº¢å‡ºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Repeat</span><span class="params">(s <span class="keyword">string</span>, count <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(s)*count)</span><br><span class="line">bp := <span class="built_in">copy</span>(b, s)</span><br><span class="line"><span class="keyword">for</span> bp &lt; <span class="built_in">len</span>(b) &#123;</span><br><span class="line"><span class="built_in">copy</span>(b[bp:], b[:bp])</span><br><span class="line">bp *= <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="csv-reader-ä¸­çš„ä¸€ä¸ªä¾‹å­"><a href="#csv-reader-ä¸­çš„ä¸€ä¸ªä¾‹å­" class="headerlink" title="csv reader ä¸­çš„ä¸€ä¸ªä¾‹å­"></a>csv reader ä¸­çš„ä¸€ä¸ªä¾‹å­</h2><p>å®˜æ–¹æ ‡å‡†åº“ <code>csv</code> çš„è¯»å–æ€§èƒ½æé«˜ï¼Œå…¶ä¸­ <code>reader</code> é‡Œé¢æœ‰ä½¿ç”¨ <code>slice</code> æå¥½çš„ä¾‹å­ï¼Œä»¥ä¸‹æ˜¯ç®€ç•¥çš„ä»£ç ï¼Œå¦‚æœæƒ³è¦å…¨é¢äº†è§£ç¨‹åºéœ€è¦å»çœ‹æ ‡å‡†åº“çš„æºç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">readRecord</span><span class="params">(dst []<span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">line, errRead = r.readLine()</span><br><span class="line"><span class="keyword">if</span> errRead == io.EOF &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errRead</span><br><span class="line">&#125;</span><br><span class="line">r.recordBuffer = r.recordBuffer[:<span class="number">0</span>]</span><br><span class="line">r.fieldIndexes = r.fieldIndexes[:<span class="number">0</span>]</span><br><span class="line">parseField:</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> r.TrimLeadingSpace &#123;</span><br><span class="line">line = bytes.TrimLeftFunc(line, unicode.IsSpace)</span><br><span class="line">&#125;</span><br><span class="line">i := bytes.IndexRune(line, r.Comma)</span><br><span class="line">field := line</span><br><span class="line"><span class="keyword">if</span> i &gt;= <span class="number">0</span> &#123;</span><br><span class="line">field = field[:i]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">field = field[:<span class="built_in">len</span>(field)-lengthNL(field)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.recordBuffer = <span class="built_in">append</span>(r.recordBuffer, field...)</span><br><span class="line">r.fieldIndexes = <span class="built_in">append</span>(r.fieldIndexes, <span class="built_in">len</span>(r.recordBuffer))</span><br><span class="line"><span class="keyword">if</span> i &gt;= <span class="number">0</span> &#123;</span><br><span class="line">line = line[i+commaLen:]</span><br><span class="line"><span class="keyword">continue</span> parseField</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span> parseField</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">err = errRead</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a single string and create slices out of it.</span></span><br><span class="line"><span class="comment">// This pins the memory of the fields together, but allocates once.</span></span><br><span class="line">str := <span class="keyword">string</span>(r.recordBuffer) <span class="comment">// Convert to string once to batch allocations</span></span><br><span class="line">dst = dst[:<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">cap</span>(dst) &lt; <span class="built_in">len</span>(r.fieldIndexes) &#123;</span><br><span class="line">dst = <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(r.fieldIndexes))</span><br><span class="line">&#125;</span><br><span class="line">dst = dst[:<span class="built_in">len</span>(r.fieldIndexes)]</span><br><span class="line"><span class="keyword">var</span> preIdx <span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> i, idx := <span class="keyword">range</span> r.fieldIndexes &#123;</span><br><span class="line">dst[i] = str[preIdx:idx]</span><br><span class="line">preIdx = idx</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dst, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ é™¤äº†æå¤šçš„ä»£ç ï¼Œä½†æ˜¯èƒ½çœ‹æ‡‚å¤§æ„ï¼Œå…¶ä¸­ <code>line</code> æ˜¯ä¸€æ®µ <code>bufio</code> ä¸­çš„ä¸€æ®µå¼•ç”¨ï¼Œæ‰€ä»¥è¿™å—æ•°æ®ä¸èƒ½è¿”å›ç»™ç”¨æˆ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œå¹¶å‘è¯»å–æ“ä½œã€‚</p><p><code>r.recordBuffer</code> å’Œ <code>r.fieldIndexes</code> æ˜¯ <code>csv</code> çš„ç¼“å­˜ï¼Œä»–ä»¬åˆå§‹çš„æ—¶å€™å®¹é‡æ˜¯0ï¼Œæ˜¯ä¸æ˜¯ä¼šæœ‰äº›å¥‡æ€ªï¼Œä¹‹å‰è¿˜å»ºè®® <code>slice</code> åˆå§‹ä¸€ä¸ªé•¿åº¦ï¼Œæ¥å‡å°‘å†…å­˜åˆ†é…ï¼Œ<code>csv</code> è¿™ä¸ªåº“çš„è®¾è®¡éå¸¸çš„å·§å¦™ï¼Œå‡è®¾ <code>csv</code> æ¯è¡Œå­—æ®µçš„ä¸ªæ•°ä¸€æ ·ï¼Œæ•°æ®é•¿åº¦ä¹Ÿç›¸è¿‘ï¼Œç°å®ä¸šåŠ¡ç¡®å®å¦‚æ­¤ï¼Œæ‰€ä»¥åªæœ‰è¯»å–ç¬¬ä¸€è¡Œæ•°æ®çš„æ—¶å€™æ‰ä¼šå‘ç”Ÿå¤§é‡çš„ <code>slice</code> æ‰©å®¹ï¼Œ ä¹‹åå…¶å®ƒè¡Œæ‰©å®¹çš„å¯èƒ½æ€§éå¸¸çš„å°ï¼Œæ•´ä¸ªæ–‡ä»¶è¯»å–å®Œä¹Ÿä¸ä¼šå‘ç”Ÿå¤ªå¤šæ¬¡ï¼Œä¸å¾—ä¸è¯´è®¾è®¡çš„å¤ªå¦™äº†ã€‚</p><p><code>r.recordBuffer</code> ç”¨æ¥å­˜å‚¨è¡Œä¸­é™¤äº†åˆ†éš”ç¬¦çš„æ‰€æœ‰æ•°æ®ï¼Œ<code>r.fieldIndexes</code> ç”¨æ¥å­˜å‚¨æ¯ä¸ªå­—æ®µæ•°æ®åœ¨ <code>r.recordBuffer</code> ä¸­çš„ç´¢å¼•ã€‚æ¯æ¬¡éƒ½é€šè¿‡ <code>r.recordBuffer[:0]</code> è¿™ä¸ªçš„æ•°æ®è·å–ï¼Œè¯»å–æ¯è¡Œæ•°æ®éƒ½åå¤ä½¿ç”¨è¿™å—å†…å­˜ï¼Œæå¤§çš„å‡å°‘å†…å­˜å¼€é”€ã€‚</p><p>æ›´å·§å¦™çš„è®¾è®¡æ˜¯ <code>str := string(r.recordBuffer)</code> æºä»£ç ä¸­ä¹Ÿæœ‰è¯¦ç»†çš„è¯´æ˜ï¼Œä¸€æ¬¡æ€§åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œ è¦çŸ¥é“ç±»å‹è½¬æ¢æ˜¯ä¼šå‘ç”Ÿå†…å­˜æ‹·è´çš„ï¼Œåˆ†é…æ–°çš„å†…å­˜ï¼Œ å¦‚æœæ¯ä¸ªå­—æ®µè½¬æ¢ä¸€æ¬¡ï¼Œä¼šå‘ç”Ÿå¾ˆå¤šçš„å†…å­˜æ‹·è´å’Œåˆ†é…ï¼Œä¹‹åé€šè¿‡ <code>dst[i] = str[preIdx:idx]</code> å¼•ç”¨ <code>str</code> ä¸­çš„æ•°æ®è¾¾åˆ°åˆ‡åˆ†å­—æ®µçš„æ•ˆæœï¼Œå› ä¸ºå¼•ç”¨å­—ç¬¦ä¸²å¹¶ä¸ä¼šæ‹·è´å­—ç¬¦ä¸²ï¼ˆå­—ç¬¦ä¸²ä¸å¯å˜ï¼Œå¼•ç”¨å­—ç¬¦ä¸²çš„å­ä¸²æ˜¯å®‰å…¨çš„ï¼‰æ‰€ä»¥å…¶ä»£ä»·éå¸¸çš„å°ã€‚</p><p>è¿™æ®µæºç ä¸­è¿˜æœ‰ä¸€ä¸ªå¾ˆå¤šäººéƒ½ä¸çŸ¥é“çš„ <code>slice</code> ç‰¹æ€§çš„ä¾‹å­ï¼Œ<code>dst = dst[:0]; dst = dst[:len(r.fieldIndexes)]</code> è¿™ä¸¤å¥è¯æ”¾åˆ°ä¸€èµ·æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆä¸å¯æ€è®®ï¼Œæ˜æ˜ <code>dst</code> çš„é•¿åº¦è¢«æ¸…ç©ºäº†ï¼Œ<code>dst[:len(r.fieldIndexes)]</code> ä¸æ˜¯ä¼šå‘ç”Ÿç´¢å¼•è¶Šç•Œå—ï¼Œå¾ˆå¤šäººè®¤ä¸º <code>s[i:l]</code> è¿™ç§å†™æ³•æ˜¯å½“å‰ <code>slice</code> çš„ç´¢å¼•ï¼Œå®é™…å¹¶éå¦‚æ­¤ï¼Œè¿™é‡Œé¢çš„ <code>i</code> å’Œ <code>j</code> æ˜¯åº•å±‚å¼•ç”¨æ•°ç»„ç›¸å¯¹å½“å‰ <code>slice</code> å¼•ç”¨ä½ç½®çš„ç´¢å¼•ï¼Œå¹¶ä¸å—å½“å‰ <code>slice</code> çš„é•¿åº¦çš„å½±å“ã€‚</p><p>è¿™é‡Œåªæ˜¯ç®€å•å¼•ç”¨ <code>csv</code> æºç ä¸­çš„ä¸€æ®µåˆ†æå…¶ <code>slice</code> çš„å·§å¦™ç”¨æ³•ï¼Œå³æŠŠ <code>slice</code> å½“åšæ•°æ®ç¼“å­˜ï¼Œä¹Ÿä½œä¸ºåˆ†é…å†…å­˜çš„ä¸€ç§æä½³çš„æ–¹æ³•ï¼Œè¿™ä¸ªç¤ºä¾‹ä¸­çš„å…³äº <code>slice</code> çš„ä½¿ç”¨å€¼å¾—åå¤æ¨æ•²ã€‚</p><h2 id="å†…å­˜æ± "><a href="#å†…å­˜æ± " class="headerlink" title="å†…å­˜æ± "></a>å†…å­˜æ± </h2><p>æ—©äº›æ—¶é—´é˜…è¯» GitHub ä¸Šçš„ä¸€äº›æºç ï¼Œå‘ç°ä¸€ä¸ªå®ç°å†…å­˜æ¬¡çš„ä¾‹å­ï¼Œé‡Œé¢å¯¹ <code>slice</code> çš„åº”ç”¨éå¸¸æœ‰ç‰¹ç‚¹ï¼Œåœ¨è¿™é‡Œæ‹¿æ¥åˆ†æä¸€ä¸‹ï¼ˆ<a href="https://github.com/funny/slab/blob/master/chan_pool.go" target="_blank" rel="noopener">GitHubæºç </a>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewChanPool</span><span class="params">(minSize, maxSize, factor, pageSize <span class="keyword">int</span>)</span> *<span class="title">ChanPool</span></span> &#123;</span><br><span class="line">pool := &amp;ChanPool&#123;<span class="built_in">make</span>([]chanClass, <span class="number">0</span>, <span class="number">10</span>), minSize, maxSize&#125;</span><br><span class="line"><span class="keyword">for</span> chunkSize := minSize; chunkSize &lt;= maxSize &amp;&amp; chunkSize &lt;= pageSize; chunkSize *= factor &#123;</span><br><span class="line">c := chanClass&#123;</span><br><span class="line">size:   chunkSize,</span><br><span class="line">page:   <span class="built_in">make</span>([]<span class="keyword">byte</span>, pageSize),</span><br><span class="line">chunks: <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>, pageSize/chunkSize),</span><br><span class="line">&#125;</span><br><span class="line">c.pageBegin = <span class="keyword">uintptr</span>(unsafe.Pointer(&amp;c.page[<span class="number">0</span>]))</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; pageSize/chunkSize; i++ &#123;</span><br><span class="line"><span class="comment">// lock down the capacity to protect append operation</span></span><br><span class="line">mem := c.page[i*chunkSize : (i+<span class="number">1</span>)*chunkSize : (i+<span class="number">1</span>)*chunkSize]</span><br><span class="line">c.chunks &lt;- mem</span><br><span class="line"><span class="keyword">if</span> i == <span class="built_in">len</span>(c.chunks)<span class="number">-1</span> &#123;</span><br><span class="line">c.pageEnd = <span class="keyword">uintptr</span>(unsafe.Pointer(&amp;mem[<span class="number">0</span>]))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">pool.classes = <span class="built_in">append</span>(pool.classes, c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pool</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡‡ç”¨æ­¥è¿›å¼åˆ†é¡µï¼Œä¿è¯æ¯é¡µä¸Šçš„æ•°æ®å—å¤§å°ç›¸åŒï¼Œä¸€æ¬¡æ€§åˆ›å»ºæ•´ä¸ªé¡µ <code>make([]byte, pageSize)</code> ï¼Œä¹‹åä»é¡µåˆ‡åˆ†æ•°æ®å— <code>mem := c.page[i*chunkSize : (i+1)*chunkSize : (i+1)*chunkSize]</code>ï¼Œ å®¹é‡å’Œæ•°æ®å—é•¿åº¦ä¸€è‡´ï¼Œåˆ›å»ºä¸€å—è¾ƒå¤§çš„å†…å­˜ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œå½“ç„¶è¿™ä¸ªä¾‹å­ä¸­è¿˜å¯ä»¥åˆ›å»ºæ›´å¤§çš„å†…å­˜ï¼Œå°±æ˜¯æ¯é¡µå®¹é‡çš„æ€»å¤§å°ï¼Œé¿å…åˆ›å»ºæ›´å¤šé¡µï¼Œæ‰€æœ‰çš„å—æ•°æ®éƒ½å¼•ç”¨ä¸€å—å†…å­˜ã€‚</p><p>è¿™é‡Œé™åˆ¶äº†æ¯ä¸ªå—çš„å®¹é‡ï¼Œé»˜è®¤å¼•ç”¨ <code>slice</code> çš„å®¹é‡æ˜¯å¼•ç”¨èµ·å§‹ä½ç½®åˆ°åº•å±‚æ•°ç»„çš„ç»“å°¾ï¼Œä½†æ˜¯å¯ä»¥æŒ‡å®šå®¹é‡ï¼Œè¿™å°±ä¿è¯äº†è·å–çš„æ•°æ®å—ä¸ä¼šå› ä¸ºç”¨æˆ·ä¸éµå®ˆçº¦å®šè¶…å‡ºå…¶å¤§å°å¯¼è‡´æ•°æ®å†™å…¥åˆ°å…¶å®ƒå—ä¸­çš„é—®é¢˜ï¼Œè®¾å®šäº†å®¹é‡ç”¨æˆ·ä½¿ç”¨è¶…å‡ºå®¹é‡åå°±ä¼šæ‹·è´å‡ºå»å¹¶åˆ›å»ºæ–°çš„ <code>slice</code> å®åœ¨çš„å¾ˆå¦™çš„ç”¨æ³•ã€‚</p><p>ä¸€æ¬¡åˆ†é…æ›´å¤§çš„å†…å­˜å¯ä»¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæ›´å¥½çš„å¤ç”¨å†…å­˜ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *ChanPool)</span> <span class="title">Alloc</span><span class="params">(size <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> size &lt;= pool.maxSize &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(pool.classes); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> pool.classes[i].size &gt;= size &#123;</span><br><span class="line">mem := pool.classes[i].Pop()</span><br><span class="line"><span class="keyword">if</span> mem != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> mem[:size]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–å†…å­˜æ± ä¸­çš„å†…å­˜å°±éå¸¸ç®€å•ï¼ŒæŸ¥æ‰¾æ¯”éœ€è¦å¤§å°æ›´å¤§çš„å—å¹¶è¿”å›å³å¯ï¼Œè¿™ä¸å¤±ä¸ºä¸€ä¸ªè¾ƒå¥½çš„å†…å­˜å¤ç”¨ç®—æ³•ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *ChanPool)</span> <span class="title">Free</span><span class="params">(mem []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">size := <span class="built_in">cap</span>(mem)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(pool.classes); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> pool.classes[i].size == size &#123;</span><br><span class="line">pool.classes[i].Push(mem)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä½¿ç”¨å®Œé‡Šæ”¾å†…å­˜æ—¶å®ç°çš„å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œåº”è¯¥åˆ¤æ–­é‡Šæ”¾çš„æ•°æ®æ˜¯å¦æ˜¯å½“å‰å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æœä¸æ˜¯çš„å°±ä¸èƒ½æ”¾å›åˆ°å†…å­˜æ± ä¸­ï¼Œå› ä¸ºç”¨æˆ·æœªæŒ‰çº¦å®šå¤§å°ä½¿ç”¨ï¼Œå¯¼è‡´å¤§é‡æ‰©å®¹è€Œä½¿å¾—å†…å­˜æ± ä¸­çš„æ•°æ®ç¢ç‰‡åŒ–ï¼Œå½“ç„¶ç”¨æˆ·ä¸€æ—¦å‘ç”Ÿæ‰©å®¹å°±ä¼šå¯¼è‡´å†…å­˜æ± ä¸­çš„ç¼“å­˜å—ä¸¢å¤±ï¼Œå¯¼è‡´å­˜åœ¨å¤§å—å†…å­˜æ— æ³•é‡Šæ”¾ï¼Œå´ä¹Ÿæ²¡æ³•ä½¿ç”¨çš„æƒ…å†µã€‚</p><p>ä¹‹æ‰€ä»¥åˆ†æè¿™ä¸ªä¾‹å­ä¸»è¦æ˜¯åˆ†æå…¶ä½¿ç”¨ <code>slice</code> çš„æ–¹æ³•å’ŒæŠ€å·§ï¼Œå¹¶ä¸æ¨èä½¿ç”¨è¯¥æ–¹æ³•ç®¡ç†å†…å­˜ã€‚</p><h2 id="æ‹“å±•"><a href="#æ‹“å±•" class="headerlink" title="æ‹“å±•"></a>æ‹“å±•</h2><p>æ›´å¤šå…³äº <code>slice</code> åº”ç”¨çš„ä¾‹å­å¯ä»¥å‚è€ƒæ ‡å‡†åº“ <code>bytes</code> ä¸ <code>bufio</code>ï¼Œ <code>buffer</code> ä¸ <code>bufio</code> çš„ä½¿ç”¨æå…¶ç›¸ä¼¼ï¼Œä¸¤ä¸ªåŒ…éƒ½æ˜¯ä½¿ç”¨ <code>slice</code> æ¥å‡å°‘å†…å­˜åˆ†é…åŠç³»ç»Ÿè°ƒç”¨æ¥è¾¾åˆ°å®ç°ç¼“å†²å’Œç¼“å­˜çš„ä¾‹å­ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;slice&lt;/code&gt; æ˜¯ &lt;code&gt;Go&lt;/code&gt; è¯­è¨€ååˆ†é‡è¦çš„æ•°æ®ç±»å‹ï¼Œå®ƒæ‰¿è½½ç€å¾ˆå¤šä½¿å‘½ï¼Œä»è¯­è¨€å±‚é¢æ¥çœ‹æ˜¯ &lt;code&gt;Go&lt;/code&gt; è¯­è¨€çš„å†…ç½®æ•°æ®ç±»å‹ï¼Œä»æ•°æ®ç»“æ„æ¥çœ‹æ˜¯åŠ¨æ€é•¿åº¦çš„é¡ºåºé“¾è¡¨ï¼Œç”±äº &lt;code&gt;Go&lt;/code&gt; ä¸èƒ½ç›´æ¥æ“ä½œå†…å­˜ï¼ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨å¯ä»¥å®ç°ï¼Œä½†æ˜¯è¯­è¨€æœ¬èº«å¹¶ä¸æ”¯æŒï¼‰ï¼Œå¾€å¾€ &lt;code&gt;slice&lt;/code&gt; ä¹Ÿå¯ä»¥ç”¨æ¥å¸®åŠ©å¼€å‘è€…ç”³è¯·å¤§å—å†…å­˜å®ç°ç¼“å†²ã€ç¼“å­˜ç­‰åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ &lt;code&gt;Go&lt;/code&gt; è¯­è¨€é¡¹ç›®ä¸­å¤§é‡çš„ä½¿ç”¨ &lt;code&gt;slice&lt;/code&gt;, æˆ‘æ€»ç»“ä¸‰å¹´æ¥å¯¹ &lt;code&gt;slice&lt;/code&gt; çš„ä¸€äº›æ“ä½œæŠ€å·§ï¼Œä»¥æ–¹ä¾¿å¯ä»¥é«˜æ•ˆçš„ä½¿ç”¨ &lt;code&gt;slice&lt;/code&gt;ï¼Œ å¹¶ä½¿ç”¨ &lt;code&gt;slice&lt;/code&gt; è§£å†³ä¸€äº›æ£˜æ‰‹çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&quot;slice-çš„åŸºæœ¬æ“ä½œ&quot;&gt;&lt;a href=&quot;#slice-çš„åŸºæœ¬æ“ä½œ&quot; class=&quot;headerlink&quot; title=&quot;slice çš„åŸºæœ¬æ“ä½œ&quot;&gt;&lt;/a&gt;slice çš„åŸºæœ¬æ“ä½œ&lt;/h2&gt;&lt;p&gt;å…ˆç†Ÿæ‚‰ä¸€äº› &lt;code&gt;slice&lt;/code&gt; çš„åŸºæœ¬çš„æ“ä½œ, å¯¹æœ€å¸¸è§„çš„ &lt;code&gt;:&lt;/code&gt; æ“ä½œå°±å¯ç©å‡ºå¾ˆå¤šèŠ±æ ·ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;s=ss[:]&lt;/code&gt; å¼•ç”¨ä¸€ä¸ªåˆ‡ç‰‡æˆ–æ•°ç»„&lt;/li&gt;
&lt;li&gt;&lt;code&gt;s=s[:0]&lt;/code&gt; æ¸…ç©ºåˆ‡ç‰‡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;s=s[:10]&lt;/code&gt; &lt;code&gt;s=s[10:]&lt;/code&gt; &lt;code&gt;s=s[10:20]&lt;/code&gt; æˆªå–æ¥ç‰‡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;s=ss[0:10:20]&lt;/code&gt; ä»åˆ‡ç‰‡æˆ–æ•°ç»„å¼•ç”¨æŒ‡å®šé•¿åº¦å’Œå®¹é‡çš„åˆ‡ç‰‡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸‹æ ‡ç´¢å¼•æ“ä½œçš„ä¸€äº›è¯¯åŒº &lt;code&gt;s[i:l:c]&lt;/code&gt; &lt;code&gt;i&lt;/code&gt; æ˜¯èµ·å§‹åç§»çš„èµ·å§‹ä½ç½®ï¼Œ&lt;code&gt;l&lt;/code&gt; æ˜¯èµ·å§‹åç§»çš„é•¿åº¦ç»“æŸä½ç½®ï¼Œ &lt;code&gt;l-i&lt;/code&gt; å°±æ˜¯æ–° &lt;code&gt;slice&lt;/code&gt; çš„é•¿åº¦ï¼Œ &lt;code&gt;c&lt;/code&gt; æ˜¯èµ·å§‹åç§»çš„å®¹é‡ç»“æŸä½ç½®ï¼Œ&lt;code&gt;c-i&lt;/code&gt; å°±æ˜¯æ–° &lt;code&gt;slice&lt;/code&gt; çš„å®¹é‡ã€‚å…¶ä¸­ &lt;code&gt;i&lt;/code&gt; ã€&lt;code&gt;l&lt;/code&gt; ã€&lt;code&gt;c&lt;/code&gt; å¹¶ä¸æ˜¯å½“å‰ &lt;code&gt;slice&lt;/code&gt; çš„ç´¢å¼•ï¼Œè€Œæ˜¯å¼•ç”¨åº•å±‚æ•°ç»„ç›¸å¯¹å½“å‰ &lt;code&gt;slice&lt;/code&gt; èµ·å§‹ä½ç½®çš„åç§»é‡ï¼Œæ‰€ä»¥æ˜¯å¯è¶…å‡ºå½“å‰ &lt;code&gt;slice&lt;/code&gt; çš„é•¿åº¦çš„ï¼Œ ä½†ä¸èƒ½è¶…å‡ºå½“å‰ &lt;code&gt;slice&lt;/code&gt; çš„å®¹é‡ï¼Œå¦‚ä¸‹æ“ä½œæ˜¯åˆæ³•çš„ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	s := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	s[&lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	s1 := s[&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	s2 := s1[&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(s1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(s2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å…¶ä¸­ &lt;code&gt;s1&lt;/code&gt; æ˜¯ &lt;code&gt;[]&lt;/code&gt;ï¼›&lt;code&gt;s2&lt;/code&gt; æ˜¯ &lt;code&gt;[100 0 0 0 0 0 0 0 0 0]&lt;/code&gt;, è¿™é‡Œå¹¶ä¸ä¼šå‘ç”Ÿä¸‹æ ‡è¶Šç•Œçš„æƒ…å†µï¼Œä¸€ä¸ªæ›´å¥½çš„ä¾‹å­åœ¨ &lt;a href=&quot;#csv-reader-ä¸­çš„ä¸€ä¸ªä¾‹å­&quot;&gt;csv reader ä¸­çš„ä¸€ä¸ªä¾‹å­&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="https://blog.thinkeridea.com/categories/go/"/>
    
    
      <category term="go" scheme="https://blog.thinkeridea.com/tags/go/"/>
    
      <category term="slice" scheme="https://blog.thinkeridea.com/tags/slice/"/>
    
      <category term="ç¼“å­˜" scheme="https://blog.thinkeridea.com/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="å†…å­˜æ± " scheme="https://blog.thinkeridea.com/tags/%E5%86%85%E5%AD%98%E6%B1%A0/"/>
    
  </entry>
  
  <entry>
    <title>ã€Goã€‘æ·±å…¥å‰–æsliceå’Œarray</title>
    <link href="https://blog.thinkeridea.com/201901/go/shen_ru_pou_xi_slice_he_array.html"/>
    <id>https://blog.thinkeridea.com/201901/go/shen_ru_pou_xi_slice_he_array.html</id>
    <published>2019-01-11T22:36:26.000Z</published>
    <updated>2019-01-13T14:40:05.579Z</updated>
    
    <content type="html"><![CDATA[<p><code>array</code> å’Œ <code>slice</code> çœ‹ä¼¼ç›¸ä¼¼ï¼Œå´æœ‰ç€æå¤§çš„ä¸åŒï¼Œä½†ä»–ä»¬ä¹‹é—´è¿˜æœ‰ç€åƒæ¬¡ä¸‡ç¼•çš„è”ç³» <code>slice</code> æ˜¯å¼•ç”¨ç±»å‹ã€æ˜¯ <code>array</code> çš„å¼•ç”¨ï¼Œç›¸å½“äºåŠ¨æ€æ•°ç»„ï¼Œ<br>è¿™äº›éƒ½æ˜¯ <code>slice</code> çš„ç‰¹æ€§ï¼Œä½†æ˜¯ <code>slice</code> åº•å±‚å¦‚ä½•è¡¨ç°ï¼Œå†…å­˜ä¸­æ˜¯å¦‚ä½•åˆ†é…çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¨‹åºä¸­å¤§é‡ä½¿ç”¨ <code>slice</code> çš„æƒ…å†µä¸‹ï¼Œæ€æ ·å¯ä»¥é«˜æ•ˆä½¿ç”¨ <code>slice</code>ï¼Ÿ<br>ä»Šå¤©å€ŸåŠ© <code>Go</code> çš„ <code>unsafe</code> åŒ…æ¥æ¢ç´¢ <code>array</code> å’Œ <code>slice</code> çš„å„ç§å¥¥å¦™ã€‚</p><a id="more"></a><h2 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h2><p><code>slice</code> æ˜¯åœ¨ <code>array</code> çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œéœ€è¦å…ˆè¯¦ç»†äº†è§£ä¸€ä¸‹æ•°ç»„ã€‚</p><p><strong> ç»´åŸºä¸Šå¦‚æ­¤ä»‹ç»æ•°ç»„ï¼š</strong></p><blockquote><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæ•°ç»„æ•°æ®ç»“æ„ï¼ˆè‹±è¯­ï¼šarray data structureï¼‰ï¼Œç®€ç§°æ•°ç»„ï¼ˆè‹±è¯­ï¼šArrayï¼‰ï¼Œæ˜¯ç”±ç›¸åŒç±»å‹çš„å…ƒç´ ï¼ˆelementï¼‰çš„é›†åˆæ‰€ç»„æˆçš„æ•°æ®ç»“æ„ï¼Œåˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜æ¥å­˜å‚¨ï¼Œåˆ©ç”¨å…ƒç´ çš„ç´¢å¼•ï¼ˆindexï¼‰å¯ä»¥è®¡ç®—å‡ºè¯¥å…ƒç´ å¯¹åº”çš„å­˜å‚¨åœ°å€ã€‚<br><strong> æ•°ç»„è®¾è®¡ä¹‹åˆæ˜¯åœ¨å½¢å¼ä¸Šä¾èµ–å†…å­˜åˆ†é…è€Œæˆçš„ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ä½¿ç”¨å‰é¢„å…ˆè¯·æ±‚ç©ºé—´ã€‚è¿™ä½¿å¾—æ•°ç»„æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</strong></p><ol><li>è¯·æ±‚ç©ºé—´ä»¥åå¤§å°å›ºå®šï¼Œä¸èƒ½å†æ”¹å˜ï¼ˆæ•°æ®æº¢å‡ºé—®é¢˜ï¼‰ï¼›</li><li>åœ¨å†…å­˜ä¸­æœ‰ç©ºé—´è¿ç»­æ€§çš„è¡¨ç°ï¼Œä¸­é—´ä¸ä¼šå­˜åœ¨å…¶ä»–ç¨‹åºéœ€è¦è°ƒç”¨çš„æ•°æ®ï¼Œä¸ºæ­¤æ•°ç»„çš„ä¸“ç”¨å†…å­˜ç©ºé—´ï¼›</li><li>åœ¨æ—§å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼ˆå¦‚æœ‰ä¸­é˜¶è¯­è¨€ä¹‹ç§°çš„Cï¼‰ï¼Œç¨‹åºä¸ä¼šå¯¹æ•°ç»„çš„æ“ä½œåšä¸‹ç•Œåˆ¤æ–­ï¼Œä¹Ÿå°±æœ‰æ½œåœ¨çš„è¶Šç•Œæ“ä½œçš„é£é™©ï¼ˆæ¯”å¦‚ä¼šæŠŠæ•°æ®å†™åœ¨è¿è¡Œä¸­ç¨‹åºéœ€è¦è°ƒç”¨çš„æ ¸å¿ƒéƒ¨åˆ†çš„å†…å­˜ä¸Šï¼‰ã€‚</li></ol></blockquote><p>æ ¹æ®ç»´åŸºçš„ä»‹ç»ï¼Œäº†è§£åˆ°æ•°ç»„æ˜¯å­˜å‚¨åœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ä¸­ï¼Œæ¯ä¸ªå…ƒç´ çš„ç±»å‹ç›¸åŒï¼Œå³æ˜¯æ¯ä¸ªå…ƒç´ çš„å®½åº¦ç›¸åŒï¼Œå¯ä»¥æ ¹æ®å…ƒç´ çš„å®½åº¦è®¡ç®—å…ƒç´ å­˜å‚¨çš„ä½ç½®ã€‚<br>é€šè¿‡è¿™æ®µä»‹ç»æ€»ç»“ä¸€ä¸‹æ•°ç»„æœ‰ä¸€ä¸‹ç‰¹æ€§ï¼š</p><ul><li>åˆ†é…åœ¨è¿ç»­çš„å†…å­˜åœ°å€ä¸Š</li><li>å…ƒç´ ç±»å‹ä¸€è‡´ï¼Œå…ƒç´ å­˜å‚¨å®½åº¦ä¸€è‡´</li><li>ç©ºé—´å¤§å°å›ºå®šï¼Œä¸èƒ½ä¿®æ”¹</li><li>å¯ä»¥é€šè¿‡ç´¢å¼•è®¡ç®—å‡ºå…ƒç´ å¯¹åº”å­˜å‚¨çš„ä½ç½®ï¼ˆåªéœ€è¦çŸ¥é“æ•°ç»„å†…å­˜çš„èµ·å§‹ä½ç½®å’Œæ•°æ®å…ƒç´ å®½åº¦å³å¯ï¼‰</li><li>ä¼šå‡ºç°æ•°æ®æº¢å‡ºçš„é—®é¢˜ï¼ˆä¸‹æ ‡è¶Šç•Œï¼‰</li></ul><p><code>Go</code> ä¸­çš„æ•°ç»„å¦‚ä½•å®ç°çš„å‘¢ï¼Œæ°æ°å°±æ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œå®é™…ä¸Šå‡ ä¹æ‰€æœ‰è®¡ç®—æœºè¯­è¨€ï¼Œæ•°ç»„çš„å®ç°éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œä¹Ÿæ‹¥æœ‰ä¸Šé¢æ€»ç»“çš„ç‰¹æ€§ã€‚<br><code>Go</code> è¯­è¨€çš„æ•°ç»„ä¸åŒäº <code>C</code> è¯­è¨€æˆ–è€…å…¶ä»–è¯­è¨€çš„æ•°ç»„ï¼Œ<code>C</code> è¯­è¨€çš„æ•°ç»„å˜é‡æ˜¯æŒ‡å‘æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼›<br>è€Œ <code>Go</code> è¯­è¨€çš„æ•°ç»„æ˜¯ä¸€ä¸ªå€¼ï¼Œ<code>Go</code> è¯­è¨€ä¸­çš„æ•°ç»„æ˜¯å€¼ç±»å‹ï¼Œä¸€ä¸ªæ•°ç»„å˜é‡å°±è¡¨ç¤ºç€æ•´ä¸ªæ•°ç»„ï¼Œæ„å‘³ç€ <code>Go</code> è¯­è¨€çš„æ•°ç»„åœ¨ä¼ é€’çš„æ—¶å€™ï¼Œä¼ é€’çš„æ˜¯åŸæ•°ç»„çš„æ‹·è´ã€‚</p><p>åœ¨ç¨‹åºä¸­æ•°ç»„çš„åˆå§‹åŒ–æœ‰ä¸¤ç§æ–¹æ³• <code>arr := [10]int{}</code> æˆ– <code>var arr  [10]int</code>ï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨ <code>make</code> æ¥åˆ›å»ºï¼Œæ•°ç»„è¿™èŠ‚ç»“æŸæ—¶å†æ¢è®¨ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚<br>ä½¿ç”¨ <code>unsafe</code>æ¥çœ‹ä¸€ä¸‹åœ¨å†…å­˜ä¸­éƒ½æ˜¯å¦‚ä½•å­˜å‚¨çš„å§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(unsafe.Sizeof(arr))</span><br><span class="line">size := unsafe.Sizeof(arr[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ•°ç»„æŒ‡å®šç´¢å¼•å…ƒç´ çš„å€¼</span></span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;arr[<span class="number">0</span>])) + <span class="number">1</span>*size)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ•°ç»„æŒ‡å®šç´¢å¼•å…ƒç´ çš„å€¼</span></span><br><span class="line">*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;arr[<span class="number">0</span>])) + <span class="number">1</span>*size)) = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ (<a href="https://play.golang.org/p/3v-rAQZG-E6" target="_blank" rel="noopener">Go Playground</a>)ï¼š</p><blockquote><p>12<br>2<br>10</p></blockquote><p>é¦–å…ˆè¯´ <code>12</code> æ˜¯ <code>fmt.Println(unsafe.Sizeof(arr))</code> è¾“å‡ºçš„ï¼Œ<code>unsafe.Sizeof</code> ç”¨æ¥è®¡ç®—å½“å‰å˜é‡çš„å€¼åœ¨å†…å­˜ä¸­çš„å¤§å°ï¼Œ<code>12</code> è¿™ä¸ªä»£è¡¨ä¸€ä¸ª <code>int</code> æœ‰4ä¸ªå­—èŠ‚ï¼Œ<code>3 * 4</code> å°±æ˜¯ <code>12</code>ã€‚<br>è¿™æ˜¯åœ¨32ä½å¹³å°ä¸Šè¿è¡Œå¾—å‡ºçš„ç»“æœï¼Œ å¦‚æœåœ¨64ä½å¹³å°ä¸Šè¿è¡Œæ•°ç»„çš„å¤§å°æ˜¯ <code>24</code>ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡º <code>[3]int</code> åœ¨å†…å­˜ä¸­ç”±3ä¸ªè¿ç»­çš„ <code>int</code> ç±»å‹ç»„æˆï¼Œä¸”æœ‰ <code>12</code> ä¸ªå­—èŠ‚é‚£ä¹ˆé•¿ï¼Œè¿™å°±è¯´æ˜äº†æ•°ç»„åœ¨å†…å­˜ä¸­æ²¡æœ‰å­˜å‚¨å¤šä½™çš„æ•°æ®ï¼Œåªå­˜å‚¨å…ƒç´ æœ¬èº«ã€‚</p><p><code>size := unsafe.Sizeof(arr[0])</code> ç”¨æ¥è®¡ç®—å•ä¸ªå…ƒç´ çš„å®½åº¦ï¼Œ<code>int</code>åœ¨32ä½å¹³å°ä¸Šå°±æ˜¯4ä¸ªå­—èŠ‚ï¼Œ<code>uintptr(unsafe.Pointer(&amp;arr[0]))</code> ç”¨æ¥è®¡ç®—æ•°ç»„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆï¼Œ<code>1*size</code> ç”¨æ¥è·å–ç´¢å¼•ä¸º1çš„å…ƒç´ ç›¸å¯¹æ•°ç»„èµ·å§‹ä½ç½®çš„åç§»ï¼Œ<code>unsafe.Pointer(uintptr(unsafe.Pointer(&amp;arr[0])) + 1*size))</code> è·å–ç´¢å¼•ä¸º1çš„å…ƒç´ æŒ‡é’ˆï¼Œ<code>*(*int)</code> ç”¨æ¥è½¬æ¢æŒ‡é’ˆä½ç½®çš„æ•°æ®ç±»å‹ï¼Œ å› ä¸º <code>int</code> æ˜¯4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åªä¼šè¯»å–4ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œç”±å…ƒç´ ç±»å‹é™åˆ¶æ•°æ®å®½åº¦ï¼Œæ¥ç¡®å®šå…ƒç´ çš„ç»“æŸä½ç½®ï¼Œå› æ­¤å¾—åˆ°çš„ç»“æœæ˜¯ <code>2</code>ã€‚</p><p>ä¸Šä¸€ä¸ªæ­¥éª¤è·å–å…ƒç´ çš„å€¼ï¼Œå…¶ä¸­å…ˆè·å–äº†å…ƒç´ çš„æŒ‡é’ˆï¼Œèµ‹å€¼çš„æ—¶å€™åªéœ€è¦å¯¹è¿™ä¸ªæŒ‡é’ˆä½ç½®è®¾ç½®å€¼å°±å¯ä»¥äº†ï¼Œ <code>*(*int)(unsafe.Pointer(uintptr(unsafe.Pointer(&amp;arr[0])) + 1*size)) = 10</code> å°±æ˜¯ç”¨æ¥ç»™æŒ‡å®šä¸‹æ ‡å…ƒç´ èµ‹å€¼ã€‚</p><p><img src="/assets/image/20190111/array.jpg" alt="æ•°ç»„åœ¨å†…å­˜ä¸­çš„ç»“æ„"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">n:= <span class="number">10</span></span><br><span class="line"><span class="keyword">var</span> arr = [n]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">fmt.Println(arr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç ï¼ŒåŠ¨æ€çš„ç»™æ•°ç»„è®¾å®šé•¿åº¦ï¼Œä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ <code>non-constant array bound n</code>ï¼Œ ç”±æ­¤æ¨å¯¼æ•°ç»„çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯ç¼–è¯‘æ—¶å®Œæˆçš„ï¼Œä¼šè½¬æˆå¯¹åº”çš„æŒ‡ä»¤ï¼Œé€šè¿‡è¿™ä¸ªç‰¹æ€§çŸ¥é“æ•°ç»„çš„é•¿åº¦æ˜¯æ•°ç»„ç±»å‹ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å¿…é¡»åœ¨ç¼–å†™ç¨‹åºæ—¶ç¡®å®šã€‚<br>å¯ä»¥é€šè¿‡ <code>GOOS=linux GOARCH=amd64 go tool compile -S array.go</code> æ¥è·å–å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œåœ¨ <code>array.go</code> ä¸­åšä¸€äº›æ•°ç»„ç›¸å…³çš„æ“ä½œï¼ŒæŸ¥çœ‹è½¬æ¢å¯¹åº”çš„æŒ‡ä»¤ã€‚</p><p>ä¹‹å‰çš„ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæ•°ç»„ä¸èƒ½ç”¨ <code>make</code> åˆ›å»ºï¼Ÿ ä¸Šé¢åˆ†æäº†è§£åˆ°æ•°ç»„æ“ä½œæ˜¯åœ¨ç¼–è¯‘æ—¶è½¬æ¢æˆå¯¹åº”æŒ‡ä»¤çš„ï¼Œè€Œ <code>make</code> æ˜¯åœ¨è¿è¡Œæ—¶å¤„ç†ï¼ˆç‰¹æ®ŠçŠ¶æ€ä¸‹ä¼šåšç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œmakeå¯ä»¥è¢«ä¼˜åŒ–ï¼Œä¸‹é¢ <code>slice</code> åˆ†ææ—¶æ¥è®²ï¼‰ã€‚</p><h2 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h2><p>å› ä¸ºæ•°ç»„æ˜¯å›ºå®šé•¿åº¦ä¸”æ˜¯å€¼ä¼ é€’ï¼Œå¾ˆä¸çµæ´»ï¼Œæ‰€ä»¥åœ¨ <code>Go</code> ç¨‹åºä¸­å¾ˆå°‘çœ‹åˆ°æ•°ç»„çš„å½±å­ã€‚ç„¶è€Œ <code>slice</code> æ— å¤„ä¸åœ¨ï¼Œ<code>slice</code> ä»¥æ•°ç»„ä¸ºåŸºç¡€ï¼Œæä¾›å¼ºå¤§çš„åŠŸèƒ½å’Œéå†æ€§ã€‚<br><code>slice</code> çš„ç±»å‹è§„èŒƒæ˜¯[]Tï¼Œ<code>slice</code> Tå…ƒç´ çš„ç±»å‹ã€‚ä¸æ•°ç»„ç±»å‹ä¸åŒï¼Œ<code>slice</code> ç±»å‹æ²¡æœ‰æŒ‡å®šçš„é•¿åº¦ã€‚</p><p><strong> <code>slice</code> ç”³æ˜çš„å‡ ç§æ–¹æ³•ï¼š</strong> </p><blockquote><p><code>s := []int{1, 2, 3}</code> ç®€çŸ­çš„èµ‹å€¼è¯­å¥<br><code>var s []int</code> <code>var</code> ç”³æ˜<br><code>make([]int, 3, 8)</code> æˆ– <code>make([]int, 3)</code> <code>make</code> å†…ç½®æ–¹æ³•åˆ›å»º<br><code>s := ss[:5]</code> ä»åˆ‡ç‰‡æˆ–è€…æ•°ç»„åˆ›å»º</p></blockquote><p><strong> <code>slice</code> æœ‰ä¸¤ä¸ªå†…ç½®å‡½æ•°æ¥è·å–å…¶å±æ€§ï¼š</strong></p><blockquote><p><code>len</code> è·å– <code>slice</code> çš„é•¿åº¦<br><code>cap</code> è·å– <code>slice</code> çš„å®¹é‡</p></blockquote><p><code>slice</code> çš„å±æ€§ï¼Œè¿™ä¸œè¥¿æ˜¯ä»€ä¹ˆï¼Œè¿˜éœ€å€ŸåŠ© <code>unsafe</code> æ¥æ¢ç©¶ä¸€ä¸‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">s[<span class="number">2</span>] = <span class="number">100</span></span><br><span class="line">s[<span class="number">9</span>] = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">size := unsafe.Sizeof(<span class="number">0</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">fmt.Println(*(*[<span class="number">20</span>]<span class="keyword">int</span>)(unsafe.Pointer(*(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ (<a href="https://play.golang.org/p/Z_TMWD53syD" target="_blank" rel="noopener">Go Playground</a>)ï¼š</p><blockquote><p>c00007ce90<br>10<br>20<br>[0 0 100 0 0 0 0 0 0 200 0 0 0 0 0 0 0 0 0 0]</p></blockquote><p>è¿™æ®µè¾“å‡ºé™¤äº†ç¬¬ä¸€ä¸ªï¼Œå‰©ä½™ä¸‰ä¸ªå¥½åƒéƒ½èƒ½çœ‹å‡ºç‚¹ä»€ä¹ˆï¼Œ <code>10</code> ä¸æ˜¯åˆ›å»º <code>slice</code> çš„é•¿åº¦å—ï¼Œ<code>20</code> ä¸å°±æ˜¯æŒ‡å®šçš„å®¹é‡å—ï¼Œ æœ€åè¿™ä¸ªçœ‹èµ·æ¥æœ‰ç‚¹åƒ <code>slice</code> é‡Œé¢çš„æ•°æ®ï¼Œä½†æ˜¯æ•°é‡è²Œä¼¼æœ‰ç‚¹å¤šï¼Œä»ç¬¬ä¸‰ä¸ªå…ƒç´ å’Œç¬¬åä¸ªå…ƒç´ æ¥çœ‹ï¼Œæ­£å¥½æ˜¯ç»™ <code>slice</code> ç´¢å¼• <code>2</code> å’Œ <code>10</code> æŒ‡å®šçš„å€¼ï¼Œä½†æ˜¯åˆ‡ç‰‡ä¸æ˜¯é•¿åº¦æ˜¯ <code>10</code> ä¸ªå—ï¼Œéš¾é“è¿™ä¸ªæ˜¯å®¹é‡ï¼Œå®¹é‡åˆšå¥½æ˜¯ <code>20</code>ä¸ªã€‚ </p><p>ç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªè¾“å‡ºå¾ˆå¥½å¼„æ˜ç™½ï¼Œå°±æ˜¯ <code>slice</code> çš„é•¿åº¦å’Œå®¹é‡ï¼Œ æœ€åä¸€ä¸ªå…¶å®æ˜¯ <code>slice</code> å¼•ç”¨åº•å±‚æ•°ç»„çš„æ•°æ®ï¼Œå› ä¸ºåˆ›å»ºå®¹é‡ä¸º <code>20</code>ï¼Œæ‰€ä»¥åº•å±‚æ•°ç»„çš„é•¿åº¦å°±æ˜¯ <code>20</code>ï¼Œä»è¿™é‡Œäº†è§£åˆ°åˆ‡ç‰‡æ˜¯å¼•ç”¨åº•å±‚æ•°ç»„ä¸Šçš„ä¸€æ®µæ•°æ®ï¼Œåº•å±‚æ•°ç»„çš„é•¿åº¦å°±æ˜¯ <code>slice</code> çš„å®¹é‡ï¼Œç”±äºæ•°ç»„é•¿åº¦ä¸å¯å˜çš„ç‰¹æ€§ï¼Œå½“ <code>slice</code> çš„é•¿åº¦è¾¾åˆ°å®¹é‡å¤§å°ä¹‹åå°±éœ€è¦è€ƒè™‘æ‰©å®¹ï¼Œä¸æ˜¯è¯´æ•°ç»„é•¿åº¦ä¸èƒ½å˜å—ï¼Œé‚£ <code>slice</code> æ€ä¹ˆå®ç°æ‰©å®¹å‘¢ï¼Œ å…¶å®å°±æ˜¯åœ¨å†…å­˜ä¸Šåˆ†é…ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼ŒæŠŠå½“å‰æ•°ç»„ä¸Šçš„å†…å®¹æ‹·è´åˆ°æ–°çš„æ•°ç»„ä¸Šï¼Œ <code>slice</code> æ¥å¼•ç”¨æ–°çš„æ•°ç»„ï¼Œè¿™æ ·å°±å®ç°æ‰©å®¹äº†ã€‚</p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œè¿˜æ˜¯æ²¡æœ‰çœ‹å‡ºæ¥ <code>slice</code> æ˜¯å¦‚ä½•å¼•ç”¨æ•°ç»„çš„ï¼Œé¢â€¦â€¦ ä¹‹å‰çš„ç¨‹åºè¿˜æœ‰ä¸€ä¸ªè¾“å‡ºæ²¡æœ‰ææ‡‚æ˜¯ä»€ä¹ˆï¼Œéš¾é“è¿™ä¸ªå°±æ˜¯åº•å±‚æ•°ç»„çš„å¼•ç”¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := [<span class="number">10</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">arr[<span class="number">7</span>] = <span class="number">100</span></span><br><span class="line">arr[<span class="number">9</span>] = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">fmt.Println(arr)</span><br><span class="line"></span><br><span class="line">s1 := arr[:]</span><br><span class="line">s2 := arr[<span class="number">2</span>:<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">size := unsafe.Sizeof(<span class="number">0</span>)</span><br><span class="line">fmt.Println(<span class="string">"----------s1---------"</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s1)))</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, <span class="keyword">uintptr</span>(unsafe.Pointer(&amp;arr[<span class="number">0</span>])))</span><br><span class="line"></span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">fmt.Println(s1)</span><br><span class="line">fmt.Println(*(*[<span class="number">10</span>]<span class="keyword">int</span>)(unsafe.Pointer(*(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s1)))))</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"----------s2---------"</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s2)))</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, <span class="keyword">uintptr</span>(unsafe.Pointer(&amp;arr[<span class="number">0</span>]))+size*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s2)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s2)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">fmt.Println(s2)</span><br><span class="line">fmt.Println(*(*[<span class="number">8</span>]<span class="keyword">int</span>)(unsafe.Pointer(*(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s2)))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç è¾“å‡ºå¦‚ä¸‹(<a href="https://play.golang.org/p/4KgHvKClbzZ" target="_blank" rel="noopener">Go Playground</a>)ï¼š</p><blockquote><p>[1 2 3 0 0 0 0 100 0 200]<br>  â€”â€”â€”-s1â€”â€”â€”<br>  c00001c0a0<br>  c00001c0a0<br>  10<br>  10<br>  [1 2 3 0 0 0 0 100 0 200]<br>  [1 2 3 0 0 0 0 100 0 200]<br>  â€”â€”â€”-s2â€”â€”â€”<br>  c00001c0b0<br>  c00001c0b0<br>  6<br>  8<br>  [3 0 0 0 0 100]<br>[3 0 0 0 0 100 0 200]</p></blockquote><p>è¿™æ®µè¾“å‡ºçœ‹èµ·æ¥æœ‰ç‚¹å°å¤æ‚ï¼Œç¬¬ä¸€è¡Œè¾“å‡ºå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿™ä¸ªæ˜¯æ‰“å°æ•´ä¸ªæ•°ç»„çš„æ•°æ®ã€‚å…ˆåˆ†æä¸€ä¸‹ <code>s1</code> å˜é‡çš„ä¸‹é¢çš„è¾“å‡ºå§ï¼Œ<code>s1 := arr[:]</code> å¼•ç”¨äº†æ•´ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥åœ¨ç¬¬5ã€6è¡Œè¾“å‡ºéƒ½æ˜¯10ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦ä¸º10ï¼Œæ‰€æœ‰ <code>s1</code> çš„é•¿åº¦å’Œå®¹é‡éƒ½ä¸º10ï¼Œé‚£ç¬¬3ã€4è¡Œè¾“å‡ºæ˜¯ä»€ä¹ˆå‘¢ï¼Œä»–ä»¬æ€ä¹ˆéƒ½ä¸€æ ·å‘¢ï¼Œä¹‹å‰åˆ†ææ•°ç»„çš„æ—¶å€™ é€šè¿‡ <code>uintptr(unsafe.Pointer(&amp;arr[0]))</code> æ¥è·å–æ•°ç»„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆçš„ï¼Œé‚£ä¹ˆç¬¬4è¡Œæ‰“å°çš„å°±æ˜¯æ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¹ˆå°±äº†è§£äº†ç¬¬ä¸‰è¡Œè¾“å‡ºçš„æ˜¯ä¸Šé¢äº†å§ï¼Œå°±æ˜¯æ•°ç»„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ <code>*(*uintptr)(unsafe.Pointer(&amp;s1))</code> è·å–çš„å°±æ˜¯å¼•ç”¨æ•°ç»„çš„æŒ‡é’ˆï¼Œä½†æ˜¯è¿™ä¸ªå¹¶ä¸æ˜¯æ•°ç»„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆï¼Œè€Œæ˜¯ <code>slice</code> å¼•ç”¨æ•°ç»„å…ƒç´ çš„æŒ‡é’ˆï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p><p>æ¥ç€çœ‹ <code>s2</code> å˜é‡ä¸‹é¢çš„è¾“å‡ºå§ï¼Œ<code>s2 := arr[2:8]</code> å¼•ç”¨æ•°ç»„ç¬¬3~8çš„å…ƒç´ ï¼Œé‚£ä¹ˆ <code>s2</code> çš„é•¿åº¦å°±æ˜¯ 6ã€‚ æ ¹æ®ç»éªŒå¯ä»¥çŸ¥é“ <code>s2</code> å˜é‡è¾“å‡ºä¸‹é¢ç¬¬3è¡Œå°±æ˜¯ <code>slice</code> çš„é•¿åº¦ï¼Œä½†æ˜¯ä¸ºå•¥ç¬¬4è¡Œæ˜¯ <code>8</code> å‘¢ï¼Œ<code>slice</code> åº”ç”¨æ•°ç»„çš„æŒ‡å®šç´¢å¼•èµ·å§‹ä½ç½®åˆ°æ•°ç»„ç»“å°¾å°±æ˜¯ <code>slice</code> çš„å®¹é‡ï¼Œ æ‰€ä»¥ æ‰€ä»¥ä»ç¬¬3ä¸ªä½ç½®åˆ°æœ«å°¾ï¼Œå°±æ˜¯8ä¸ªå®¹é‡ã€‚åœ¨çœ‹ç¬¬1è¡Œå’Œç¬¬2è¡Œçš„è¾“å‡ºï¼Œä¹‹å‰åˆ†ææ•°ç»„çš„æ—¶å€™é€šè¿‡ <code>uintptr(unsafe.Pointer(&amp;arr[0]))+size*2</code> æ¥è·å–æ•°ç»„æŒ‡å®šç´¢å¼•ä½ç½®çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ®µç¬¬2è¡Œå°±æ˜¯æ•°ç»„ç´¢å¼•ä¸º2çš„å…ƒç´ æŒ‡é’ˆï¼Œ<code>*(*uintptr)(unsafe.Pointer(&amp;s2))</code> æ˜¯è·å–åˆ‡ç‰‡çš„æŒ‡é’ˆï¼Œç¬¬1è¡Œå’Œç¬¬2è¡Œè¾“å‡ºä¸€è‡´ï¼Œæ‰€ä»¥ <code>slice</code> å®é™…æ˜¯å¼•ç”¨æ•°ç»„å…ƒç´ ä½ç½®çš„æŒ‡é’ˆï¼Œå¹¶ä¸æ˜¯æ•°ç»„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆã€‚</p><p><strong> æ€»ç»“ï¼š</strong></p><ul><li><code>slice</code> æ˜¯çš„èµ·å§‹ä½ç½®æ˜¯å¼•ç”¨æ•°ç»„å…ƒç´ ä½ç½®çš„æŒ‡é’ˆã€‚</li><li><code>slice</code> çš„é•¿åº¦æ˜¯å¼•ç”¨æ•°ç»„å…ƒç´ èµ·å§‹ä½ç½®åˆ°ç»“æŸä½ç½®çš„é•¿åº¦ã€‚</li><li><code>slice</code> çš„å®¹é‡æ˜¯å¼•ç”¨æ•°ç»„å…ƒç´ èµ·å§‹ä½ç½®åˆ°æ•°ç»„æœ«å°¾çš„é•¿åº¦ã€‚</li></ul><p>ç»è¿‡ä¸Šé¢ä¸€è½®åˆ†æäº†è§£åˆ° <code>slice</code> æœ‰ä¸‰ä¸ªå±æ€§ï¼Œå¼•ç”¨æ•°ç»„å…ƒç´ ä½ç½®æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡ã€‚å®é™…ä¸Š <code>slice</code> çš„ç»“æ„åƒä¸‹å›¾ä¸€æ ·ï¼š</p><p><img src="/assets/image/20190111/slice_1.jpg" alt="slice"></p><h2 id="slice-å¢é•¿"><a href="#slice-å¢é•¿" class="headerlink" title="slice å¢é•¿"></a>slice å¢é•¿</h2><p><code>slice</code> æ˜¯å¦‚ä½•å¢é•¿çš„ï¼Œç”¨ <code>unsafe</code> åˆ†æä¸€ä¸‹çœ‹çœ‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">9</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨åº•å±‚çš„æ•°ç»„åœ°å€</span></span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨åº•å±‚çš„æ•°ç»„åœ°å€</span></span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨åº•å±‚çš„æ•°ç»„åœ°å€</span></span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç çš„è¾“å‡º(<a href="https://play.golang.org/p/3c4ek4-0ft5" target="_blank" rel="noopener">Go Playground</a>):</p><blockquote><p>c000082e90<br>  9 10<br>  c000082e90<br>  10 10<br>  c00009a000<br>11 20</p></blockquote><p>ä»ç»“æœä¸Šçœ‹å‰ä¸¤æ¬¡åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œåˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º9ï¼Œå®¹é‡ä¸º10çš„ <code>slice</code>ï¼Œå½“ç¬¬ä¸€æ¬¡ <code>append</code> çš„æ—¶å€™å®¹é‡æ˜¯è¶³å¤Ÿçš„ï¼Œæ‰€ä»¥åº•å±‚å¼•ç”¨æ•°ç»„åœ°å€æœªå‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶ <code>slice</code> çš„é•¿åº¦å’Œå®¹é‡éƒ½ä¸º10ï¼Œä¹‹åå†æ¬¡ <code>append</code> çš„æ—¶å€™å‘ç°åº•å±‚æ•°ç»„çš„åœ°å€ä¸ä¸€æ ·äº†ï¼Œå› ä¸º <code>slice</code> çš„é•¿åº¦è¶…è¿‡äº†å®¹é‡ï¼Œä½†æ˜¯æ–°çš„ <code>slice</code> å®¹é‡å¹¶ä¸æ˜¯11è€Œæ˜¯20ï¼Œè¿™è¦è¯´ <code>slice</code> çš„æœºåˆ¶äº†ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦ä¸å¯å˜ï¼Œæƒ³æ‰©å®¹ <code>slice</code>å°±å¿…é¡»åˆ†é…ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼Œå¹¶æŠŠä¹‹å‰çš„æ•°æ®æ‹·è´åˆ°æ–°æ•°ç»„ï¼Œå¦‚æœä¸€æ¬¡åªå¢åŠ 1ä¸ªé•¿åº¦ï¼Œé‚£å°±ä¼šé‚£å‘ç”Ÿå¤§é‡çš„å†…å­˜åˆ†é…å’Œæ•°æ®æ‹·è´ï¼Œè¿™ä¸ªæˆæœ¬æ˜¯å¾ˆå¤§çš„ï¼Œæ‰€ä»¥ <code>slice</code> æ˜¯æœ‰ä¸€ä¸ªå¢é•¿ç­–ç•¥çš„ã€‚</p><p><code>Go</code> æ ‡å‡†åº“ <code>runtime/slice.go</code> å½“ä¸­æœ‰è¯¦ç»†çš„ <code>slice</code> å¢é•¿ç­–ç•¥çš„é€»è¾‘ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growslice</span><span class="params">(et *_type, old slice, <span class="built_in">cap</span> <span class="keyword">int</span>)</span> <span class="title">slice</span></span> &#123;</span><br><span class="line">    .....</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—æ–°çš„å®¹é‡ï¼Œæ ¸å¿ƒç®—æ³•ç”¨æ¥å†³å®šsliceå®¹é‡å¢é•¿</span></span><br><span class="line">newcap := old.<span class="built_in">cap</span></span><br><span class="line">doublecap := newcap + newcap</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">cap</span> &gt; doublecap &#123;</span><br><span class="line">newcap = <span class="built_in">cap</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> old.<span class="built_in">len</span> &lt; <span class="number">1024</span> &#123;</span><br><span class="line">newcap = doublecap</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> <span class="number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="built_in">cap</span> &#123;</span><br><span class="line">newcap += newcap / <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> newcap &lt;= <span class="number">0</span> &#123;</span><br><span class="line">newcap = <span class="built_in">cap</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®et.sizeè°ƒæ•´æ–°çš„å®¹é‡</span></span><br><span class="line"><span class="keyword">var</span> overflow <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">var</span> lenmem, newlenmem, capmem <span class="keyword">uintptr</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> et.size == <span class="number">1</span>:</span><br><span class="line">lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>)</span><br><span class="line">newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>)</span><br><span class="line">capmem = roundupsize(<span class="keyword">uintptr</span>(newcap))</span><br><span class="line">overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxAlloc</span><br><span class="line">newcap = <span class="keyword">int</span>(capmem)</span><br><span class="line"><span class="keyword">case</span> et.size == sys.PtrSize:</span><br><span class="line">lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) * sys.PtrSize</span><br><span class="line">newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) * sys.PtrSize</span><br><span class="line">capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) * sys.PtrSize)</span><br><span class="line">overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxAlloc/sys.PtrSize</span><br><span class="line">newcap = <span class="keyword">int</span>(capmem / sys.PtrSize)</span><br><span class="line"><span class="keyword">case</span> isPowerOfTwo(et.size):</span><br><span class="line"><span class="keyword">var</span> shift <span class="keyword">uintptr</span></span><br><span class="line"><span class="keyword">if</span> sys.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line"><span class="comment">// Mask shift for better code generation.</span></span><br><span class="line">shift = <span class="keyword">uintptr</span>(sys.Ctz64(<span class="keyword">uint64</span>(et.size))) &amp; <span class="number">63</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">shift = <span class="keyword">uintptr</span>(sys.Ctz32(<span class="keyword">uint32</span>(et.size))) &amp; <span class="number">31</span></span><br><span class="line">&#125;</span><br><span class="line">lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) &lt;&lt; shift</span><br><span class="line">newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) &lt;&lt; shift</span><br><span class="line">capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) &lt;&lt; shift)</span><br><span class="line">overflow = <span class="keyword">uintptr</span>(newcap) &gt; (maxAlloc &gt;&gt; shift)</span><br><span class="line">newcap = <span class="keyword">int</span>(capmem &gt;&gt; shift)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) * et.size</span><br><span class="line">newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) * et.size</span><br><span class="line">capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) * et.size)</span><br><span class="line">overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxSliceCap(et.size)</span><br><span class="line">newcap = <span class="keyword">int</span>(capmem / et.size)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p unsafe.Pointer</span><br><span class="line"><span class="keyword">if</span> et.kind&amp;kindNoPointers != <span class="number">0</span> &#123;</span><br><span class="line">p = mallocgc(capmem, <span class="literal">nil</span>, <span class="literal">false</span>)  <span class="comment">// åˆ†é…æ–°çš„å†…å­˜</span></span><br><span class="line">memmove(p, old.array, lenmem) <span class="comment">// æ‹·è´æ•°æ®</span></span><br><span class="line">memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">p = mallocgc(capmem, et, <span class="literal">true</span>) <span class="comment">// åˆ†é…æ–°çš„å†…å­˜</span></span><br><span class="line"><span class="keyword">if</span> !writeBarrier.enabled &#123;</span><br><span class="line">memmove(p, old.array, lenmem)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">uintptr</span>(<span class="number">0</span>); i &lt; lenmem; i += et.size &#123;</span><br><span class="line">typedmemmove(et, add(p, i), add(old.array, i)) <span class="comment">// æ‹·è´æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slice&#123;p, old.<span class="built_in">len</span>, newcap&#125; <span class="comment">// æ–°sliceå¼•ç”¨æ–°çš„æ•°ç»„ï¼Œé•¿åº¦ä¸ºæ—§æ•°ç»„çš„é•¿åº¦ï¼Œå®¹é‡ä¸ºæ–°æ•°ç»„çš„å®¹é‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬å‘¢å°±ä¸‰ä¸ªæ­¥éª¤ï¼Œè®¡ç®—æ–°çš„å®¹é‡ã€åˆ†é…æ–°çš„æ•°ç»„ã€æ‹·è´æ•°æ®åˆ°æ–°æ•°ç»„ï¼Œç¤¾åŒºå¾ˆå¤šäººåˆ†äº« <code>slice</code> çš„å¢é•¿æ–¹æ³•ï¼Œå®é™…éƒ½ä¸æ˜¯å¾ˆç²¾ç¡®ï¼Œå› ä¸ºå¤§å®¶åªåˆ†æäº†è®¡ç®— <code>newcap</code> çš„é‚£ä¸€æ®µï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ³¨é‡Šçš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¸‹é¢çš„ <code>switch</code> æ ¹æ® <code>et.size</code> æ¥è°ƒæ•´ <code>newcap</code> ä¸€æ®µè¢«ç›´æ¥å¿½ç•¥ï¼Œç¤¾åŒºçš„ç»“è®ºæ˜¯ï¼šâ€å¦‚æœ <code>selic</code> çš„å®¹é‡å°äº1024ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆæ‰©å®¹çš„æ—¶å€™ <code>slice</code> çš„ <code>cap</code> å°±ç¿»ç•ªï¼Œä¹˜ä»¥2ï¼›ä¸€æ—¦å…ƒç´ ä¸ªæ•°è¶…è¿‡1024ä¸ªå…ƒç´ ï¼Œå¢é•¿å› å­å°±å˜æˆ1.25ï¼Œå³æ¯æ¬¡å¢åŠ åŸæ¥å®¹é‡çš„å››åˆ†ä¹‹ä¸€â€ å¤§å¤šæ•°æƒ…å†µä¹Ÿç¡®å®å¦‚æ­¤ï¼Œä½†æ˜¯æ ¹æ® <code>newcap</code> çš„è®¡ç®—è§„åˆ™ï¼Œå¦‚æœæ–°çš„å®¹é‡è¶…è¿‡æ—§çš„å®¹é‡2å€æ—¶ä¼šç›´æ¥æŒ‰æ–°çš„å®¹é‡åˆ†é…ï¼ŒçœŸçš„æ˜¯è¿™æ ·å—?</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">s2 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">append</span>(s, s2...)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç çš„è¾“å‡º(<a href="https://play.golang.org/p/x8kN4V5R7YW" target="_blank" rel="noopener">Go Playground</a>):</p><blockquote><p>10 10<br>50 52</p></blockquote><p>è¿™ä¸ªç»“æœæœ‰ç‚¹å‡ºäººæ„æ–™ï¼Œ å¦‚æœæ˜¯2å€å¢é•¿åº”è¯¥æ˜¯ <code>10 * 2 * 2 * 2</code> ç»“æœåº”è¯¥æ˜¯80ï¼Œ å¦‚æœè¯´æ–°çš„å®¹é‡é«˜äºæ—§å®¹é‡çš„ä¸¤å€ä½†ç»“æœä¹Ÿä¸æ˜¯50ï¼Œå®é™…ä¸Š <code>newcap</code> çš„ç»“æœå°±æ˜¯50ï¼Œé‚£æ®µé€»è¾‘å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯<code>switch</code> æ ¹æ® <code>et.size</code> æ¥è°ƒæ•´ <code>newcap</code> åå°±æ˜¯52äº†ï¼Œè¿™æ®µé€»è¾‘èµ°åˆ°äº† <code>case et.size == sys.PtrSize</code> è¿™æ®µï¼Œè¯¦ç»†çš„ä»¥ååšæºç åˆ†æå†è¯´ã€‚</p><p><strong> æ€»ç»“ </strong></p><ul><li>å½“ <code>slice</code> çš„é•¿åº¦è¶…è¿‡å…¶å®¹é‡ï¼Œä¼šåˆ†é…æ–°çš„æ•°ç»„ï¼Œå¹¶æŠŠæ—§æ•°ç»„ä¸Šçš„å€¼æ‹·è´åˆ°æ–°çš„æ•°ç»„</li><li>é€ä¸ªå…ƒç´ æ·»åŠ åˆ° <code>slice</code> å¹¶æ“è¿‡å…¶å®¹é‡ï¼Œ å¦‚æœ <code>selic</code> çš„å®¹é‡å°äº1024ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆæ‰©å®¹çš„æ—¶å€™ <code>slice</code> çš„ <code>cap</code> å°±ç¿»ç•ªï¼Œä¹˜ä»¥2ï¼›ä¸€æ—¦å…ƒç´ ä¸ªæ•°è¶…è¿‡1024ä¸ªå…ƒç´ ï¼Œå¢é•¿å› å­å°±å˜æˆ1.25ï¼Œå³æ¯æ¬¡å¢åŠ åŸæ¥å®¹é‡çš„å››åˆ†ä¹‹ä¸€ã€‚</li><li>æ‰¹é‡æ·»åŠ å…ƒç´ ï¼Œå½“æ–°çš„å®¹é‡é«˜äºæ—§å®¹é‡çš„ä¸¤å€ï¼Œå°±ä¼šåˆ†é…æ¯”æ–°å®¹é‡ç¨å¤§ä¸€äº›ï¼Œå¹¶ä¸ä¼šæŒ‰ä¸Šé¢ç¬¬äºŒæ¡çš„è§„åˆ™æ‰©å®¹ã€‚</li><li>å½“ <code>slice</code> å‘ç”Ÿæ‰©å®¹ï¼Œå¼•ç”¨æ–°æ•°ç»„åï¼Œ<code>slice</code> æ“ä½œä¸ä¼šå†å½±å“æ—§çš„æ•°ç»„ï¼Œè€Œæ˜¯æ–°çš„æ•°ç»„ï¼ˆç¤¾åŒºç»å¸¸è®¨è®ºçš„ä¼ é€’ <code>slice</code> å®¹é‡è¶…å‡ºåï¼Œä¿®æ”¹æ•°æ®ä¸ä¼šä½œç”¨åˆ°æ—§çš„æ•°æ®ä¸Šï¼‰ï¼Œæ‰€ä»¥å¾€å¾€è®¾è®¡å‡½æ•°å¦‚æœä¼šå¯¹é•¿åº¦è°ƒæ•´éƒ½ä¼šè¿”å›æ–°çš„ <code>slice</code>ï¼Œä¾‹å¦‚ <code>append</code> æ–¹æ³•ã€‚</li></ul><h2 id="slice-æ˜¯å¼•ç”¨ç±»å‹ï¼Ÿ"><a href="#slice-æ˜¯å¼•ç”¨ç±»å‹ï¼Ÿ" class="headerlink" title="slice æ˜¯å¼•ç”¨ç±»å‹ï¼Ÿ"></a>slice æ˜¯å¼•ç”¨ç±»å‹ï¼Ÿ</h2><p><code>slice</code> ä¸å‘ç”Ÿæ‰©å®¹ï¼Œæ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¼šä½œç”¨åœ¨åŸæ•°ç»„ä¸Šï¼Œé‚£å¦‚æœæŠŠ <code>slice</code> ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°æˆ–è€…èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Œ<code>slice</code> æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¼šæœ‰æ–°çš„å†…å­˜è¢«åˆ†é…å—ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">size := unsafe.Sizeof(<span class="number">0</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%p\n"</span>, &amp;s)</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">slice(s)</span><br><span class="line"></span><br><span class="line">s1 := s</span><br><span class="line">fmt.Printf(<span class="string">"%p\n"</span>, &amp;s1)</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s1)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"-"</span>, <span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size)) = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s1)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s1)) + size*<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">fmt.Println(s)</span><br><span class="line">fmt.Println(s1)</span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"-"</span>, <span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">s2 := s</span><br><span class="line">s2 = <span class="built_in">append</span>(s2, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1), s1)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s2), <span class="built_in">cap</span>(s2), s2)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">size := unsafe.Sizeof(<span class="number">0</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%p\n"</span>, &amp;s)</span><br><span class="line">fmt.Printf(<span class="string">"%x\n"</span>, *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size)))</span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;s)) + size*<span class="number">2</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­(<a href="https://play.golang.org/p/98NZEDdh0Mm" target="_blank" rel="noopener">Go Playground</a>)æ¯”è¾ƒé•¿å°±ä¸é€ä¸€åˆ†æäº†ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œé¢è°ƒç”¨å‡½æ•°ä¼ é€’ <code>slice</code> å…¶å˜é‡çš„åœ°å€å‘ç”Ÿäº†å˜åŒ–ï¼Œ ä½†æ˜¯å¼•ç”¨æ•°ç»„çš„åœ°å€ï¼Œ<code>slice</code> çš„é•¿åº¦å’Œå®¹é‡éƒ½æ²¡æœ‰å˜åŒ–ï¼Œ è¿™è¯´æ˜æ˜¯å¯¹ <code>slice</code> çš„æµ…æ‹·è´ï¼Œæ‹·è´ <code>slice</code> çš„ä¸‰ä¸ªå±æ€§åˆ›å»ºä¸€ä¸ªæ–°çš„å˜é‡ï¼Œè™½ç„¶å¼•ç”¨åº•å±‚æ•°ç»„è¿˜æ˜¯ä¸€ä¸ªï¼Œä½†æ˜¯å˜é‡å¹¶ä¸æ˜¯ä¸€ä¸ªã€‚</p><p>ç¬¬äºŒä¸ªåˆ›å»º <code>s1</code> å˜é‡ï¼Œä½¿ç”¨ <code>s</code> ä¸ºå…¶èµ‹å€¼ï¼Œå‘ç° <code>s1</code> å’Œå‡½æ•°è°ƒç”¨ä¸€æ ·ä¹Ÿæ˜¯ <code>s</code> çš„æµ…æ‹·è´ï¼Œä¹‹åä¿®æ”¹ <code>s1</code> çš„é•¿åº¦å‘ç° <code>s1</code> çš„é•¿åº¦å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯ <code>s</code> çš„é•¿åº¦ä¿æŒä¸å˜ï¼Œ è¿™ä¹Ÿè¯´æ˜ <code>s1</code> å°±æ˜¯ <code>s</code> çš„æµ…æ‹·è´ã€‚</p><p>è¿™æ ·è®¾è®¡æœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Œç¬¬ä¸‰æ­¥åˆ›å»º <code>s2</code> å˜é‡ï¼Œ å¹¶ä¸” <code>append</code> ä¸€ä¸ªå…ƒç´ ï¼Œ å‘ç° <code>s2</code> çš„é•¿åº¦å‘ç”Ÿå˜åŒ–äº†ï¼Œ <code>s</code> å¹¶æ²¡æœ‰ï¼Œè™½ç„¶è¿™ä¸ªæ•°æ®å°±åœ¨åº•å±‚æ•°ç»„ä¸Šï¼Œä½†æ˜¯ç”¨å¸¸è§„çš„æ–¹æ³• <code>s</code> æ˜¯çœ‹ä¸åˆ°ç¬¬11ä¸ªä½ç½®ä¸Šçš„æ•°æ®çš„ï¼Œ <code>s1</code> å› ä¸ºé•¿åº¦è¦†ç›–åˆ°ç¬¬11ä¸ªå…ƒç´ ï¼Œæ‰€æœ‰èƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªæ•°æ®çš„å˜åŒ–ã€‚è¿™é‡Œèƒ½çœ‹åˆ°é‡‡ç”¨æµ…æ‹·è´çš„æ–¹å¼å¯ä»¥ä½¿å¾—åˆ‡ç‰‡çš„å±æ€§å„è‡ªç‹¬ç«‹ï¼Œè€Œä¸ä¼šç›¸äº’å½±å“ï¼Œè¿™æ ·å¯ä»¥æœ‰ä¸€å®šçš„éš”ç¦»æ€§ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœä¸¤ä¸ªå˜é‡éƒ½å¼•ç”¨åŒä¸€ä¸ªæ•°ç»„ï¼ŒåŒæ—¶ <code>append</code>ï¼Œ åœ¨ä¸å‘ç”Ÿæ‰©å®¹çš„æƒ…å†µä¸‹ï¼Œæ€»æ˜¯æœ€åä¸€ä¸ª <code>append</code> çš„ç»“æœè¢«ä¿ç•™ï¼Œå¯èƒ½å¼•èµ·ä¸€äº›ç¼–ç¨‹ä¸Šç–‘æƒ‘ã€‚</p><p><strong> æ€»ç»“ </strong></p><p><code>slice</code> æ˜¯å¼•ç”¨ç±»å‹ï¼Œä½†æ˜¯å’Œ <code>C</code> ä¼ å¼•ç”¨æ˜¯æœ‰åŒºåˆ«çš„ï¼Œ <code>C</code> é‡Œé¢çš„ä¼ å¼•ç”¨æ˜¯åœ¨ç¼–è¯‘å™¨å¯¹åŸå˜é‡æ•°æ®å¼•ç”¨ï¼Œ å¹¶ä¸ä¼šå‘ç”Ÿå†…å­˜åˆ†é…ï¼Œè€Œ <code>Go</code> é‡Œé¢çš„å¼•ç”¨ç±»å‹ä¼ é€’å’Œèµ‹å€¼ä¼šè¿›è¡Œæµ…æ‹·è´ï¼Œåœ¨32ä½å¹³å°ä¸Šæœ‰12ä¸ªå­—èŠ‚çš„å†…å­˜åˆ†é…ï¼Œ åœ¨64ä½ä¸Šæœ‰24å­—èŠ‚çš„å†…å­˜åˆ†é…ã€‚</p><p><strong><em> ä¼ å¼•ç”¨å’Œå¼•ç”¨ç±»å‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œ <code>slice</code> æ˜¯å¼•ç”¨ç±»å‹ã€‚</em></strong> </p><h2 id="slice-çš„ä¸‰ç§çŠ¶æ€"><a href="#slice-çš„ä¸‰ç§çŠ¶æ€" class="headerlink" title="slice çš„ä¸‰ç§çŠ¶æ€"></a>slice çš„ä¸‰ç§çŠ¶æ€</h2><p><code>slice</code> æœ‰ä¸‰ç§çŠ¶æ€ï¼šé›¶åˆ‡ç‰‡ã€ç©ºåˆ‡ç‰‡ã€nilåˆ‡ç‰‡ã€‚</p><h4 id="é›¶åˆ‡ç‰‡"><a href="#é›¶åˆ‡ç‰‡" class="headerlink" title="é›¶åˆ‡ç‰‡"></a>é›¶åˆ‡ç‰‡</h4><p>æ‰€æœ‰çš„ç±»å‹éƒ½æœ‰é›¶å€¼ï¼Œå¦‚æœ <code>slice</code> æ‰€å¼•ç”¨æ•°ç»„å…ƒç´ éƒ½æ²¡æœ‰èµ‹å€¼ï¼Œå°±æ˜¯æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ç±»å‹é›¶å€¼ï¼Œé‚£è¿™å°±æ˜¯é›¶åˆ‡ç‰‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> s = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s1 = <span class="built_in">make</span>([]*<span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(s1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s2 = <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(s2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç è¾“å‡º(<a href="https://play.golang.org/p/RWJv8t6goas" target="_blank" rel="noopener">Go Playground</a>):</p><blockquote><p>[0 0 0 0 0 0 0 0 0 0]<br> [<nil> <nil> <nil> <nil> <nil> <nil> <nil> <nil> <nil> <nil>]<br>[         ]</nil></nil></nil></nil></nil></nil></nil></nil></nil></nil></p></blockquote><p>é›¶åˆ‡ç‰‡å¾ˆå¥½ç†è§£ï¼Œæ•°ç»„å…ƒç´ éƒ½ä¸ºç±»å‹é›¶å€¼å³ä¸ºé›¶åˆ‡ç‰‡ï¼Œè¿™ç§çŠ¶æ€ä¸‹çš„ <code>slice</code> å’Œæ­£å¸¸çš„ <code>slice</code> æ“ä½œæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚</p><h4 id="ç©ºåˆ‡ç‰‡"><a href="#ç©ºåˆ‡ç‰‡" class="headerlink" title="ç©ºåˆ‡ç‰‡"></a>ç©ºåˆ‡ç‰‡</h4><p>ç©ºåˆ‡ç‰‡å¯ä»¥ç†è§£å°±æ˜¯åˆ‡ç‰‡çš„é•¿åº¦ä¸º0ï¼Œå°±æ˜¯è¯´ <code>slice</code> æ²¡æœ‰å…ƒç´ ã€‚ ç¤¾åŒºå¤§å¤šæ•°è§£é‡Šç©ºåˆ‡ç‰‡ä¸ºå¼•ç”¨åº•å±‚æ•°ç»„ä¸º <code>zerobase</code> è¿™ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆã€‚ä½†æ˜¯ä»æ“ä½œä¸Šçœ‹ç©ºåˆ‡ç‰‡æ‰€æœ‰çš„è¡¨ç°å°±æ˜¯åˆ‡ç‰‡é•¿åº¦ä¸º0ï¼Œå¦‚æœå®¹é‡ä¹Ÿä¸ºé›¶åº•å±‚æ•°ç»„å°±ä¼šæŒ‡å‘ <code>zerobase</code> ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿå†…å­˜åˆ†é…ï¼Œ å¦‚æœå®¹é‡ä¸ä¼šé›¶å°±ä¼šæŒ‡å‘åº•å±‚æ•°æ®ï¼Œä¼šæœ‰å†…å­˜åˆ†é…ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"reflect"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line"><span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> s []<span class="keyword">int</span></span><br><span class="line">s1 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">s2 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">s3 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">arr := [<span class="number">10</span>]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">s4 := arr[:<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"--s--"</span>, <span class="number">10</span>))</span><br><span class="line">fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&amp;s)))</span><br><span class="line">fmt.Println(s)</span><br><span class="line">fmt.Println(s == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"--s1--"</span>, <span class="number">10</span>))</span><br><span class="line">fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&amp;s1)))</span><br><span class="line">fmt.Println(s1)</span><br><span class="line">fmt.Println(s1 == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"--s2--"</span>, <span class="number">10</span>))</span><br><span class="line">fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&amp;s2)))</span><br><span class="line">fmt.Println(s2)</span><br><span class="line">fmt.Println(s2 == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"--s3--"</span>, <span class="number">10</span>))</span><br><span class="line">fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&amp;s3)))</span><br><span class="line">fmt.Println(s3)</span><br><span class="line">fmt.Println(s3 == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(strings.Repeat(<span class="string">"--s4--"</span>, <span class="number">10</span>))</span><br><span class="line">fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&amp;s4)))</span><br><span class="line">fmt.Println(s4)</span><br><span class="line">fmt.Println(s4 == <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç è¾“å‡º(<a href="https://play.golang.org/p/I145ObQ32yG" target="_blank" rel="noopener">Go Playground</a>):</p><blockquote><p>â€“sâ€”-sâ€”-sâ€”-sâ€”-sâ€”-sâ€”-sâ€”-sâ€”-sâ€”-sâ€“<br> {0 0 0}<br> []<br> â€“s1â€”-s1â€”-s1â€”-s1â€”-s1â€”-s1â€”-s1â€”-s1â€”-s1â€”-s1â€“<br> {18349960 0 0}<br> []<br> â€“s2â€”-s2â€”-s2â€”-s2â€”-s2â€”-s2â€”-s2â€”-s2â€”-s2â€”-s2â€“<br> {18349960 0 0}<br> []<br> â€“s3â€”-s3â€”-s3â€”-s3â€”-s3â€”-s3â€”-s3â€”-s3â€”-s3â€”-s3â€“<br> {824634269696 0 100}<br> []<br> â€“s4â€”-s4â€”-s4â€”-s4â€”-s4â€”-s4â€”-s4â€”-s4â€”-s4â€”-s4â€“<br> {824633835680 0 10}<br>[]</p></blockquote><p>ä»¥ä¸Šç¤ºä¾‹ä¸­é™¤äº† <code>s</code> å…¶å®ƒçš„ <code>slice</code> éƒ½æ˜¯ç©ºåˆ‡ç‰‡ï¼Œæ‰“å°å‡ºæ¥å…¨éƒ¨éƒ½æ˜¯ <code>[]</code>ï¼Œ<code>s</code> æ˜¯nilåˆ‡ç‰‡ä¸‹ä¸€å°èŠ‚è¯´ã€‚è¦æ³¨æ„ <code>s1</code> å’Œ <code>s2</code> çš„é•¿åº¦å’Œå®¹é‡éƒ½ä¸º0ï¼Œä¸”å¼•ç”¨æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯ <code>18349960</code>ï¼Œ è¿™ç‚¹å¤ªé‡è¦äº†ï¼Œå› ä¸ºä»–ä»¬éƒ½æŒ‡å‘ <code>zerobase</code> è¿™ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆï¼Œæ˜¯æ²¡æœ‰å†…å­˜åˆ†é…çš„ã€‚</p><p><img src="/assets/image/20190111/slice_3.jpg" alt="slice"></p><h4 id="nilåˆ‡ç‰‡"><a href="#nilåˆ‡ç‰‡" class="headerlink" title="nilåˆ‡ç‰‡"></a>nilåˆ‡ç‰‡</h4><p>ä»€ä¹ˆæ˜¯nilåˆ‡ç‰‡ï¼Œè¿™ä¸ªåå­—è¯´æ˜nilåˆ‡ç‰‡æ²¡æœ‰å¼•ç”¨ä»»ä½•åº•å±‚æ•°ç»„ï¼Œåº•å±‚æ•°ç»„çš„åœ°å€ä¸ºnilå°±æ˜¯nilåˆ‡ç‰‡ã€‚ä¸Šä¸€å°èŠ‚ä¸­çš„ <code>s</code> å°±æ˜¯ä¸€ä¸ªnilåˆ‡ç‰‡ï¼Œå®ƒçš„åº•å±‚æ•°ç»„æŒ‡é’ˆä¸º0ï¼Œä»£è¡¨æ˜¯ä¸€ä¸ª <code>nil</code> æŒ‡é’ˆã€‚</p><p><img src="/assets/image/20190111/slice_2.jpg" alt="slice"></p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>é›¶åˆ‡ç‰‡å°±æ˜¯å…¶å…ƒç´ å€¼éƒ½æ˜¯å…ƒç´ ç±»å‹çš„é›¶å€¼çš„åˆ‡ç‰‡ã€‚<br>ç©ºåˆ‡ç‰‡å°±æ˜¯æ•°ç»„æŒ‡é’ˆä¸ä¸ºnilï¼Œä¸” <code>slice</code> çš„é•¿åº¦ä¸º0ã€‚<br>nilåˆ‡ç‰‡å°±æ˜¯å¼•ç”¨åº•å±‚æ•°ç»„æŒ‡é’ˆä¸º <code>nil</code> çš„ <code>slice</code>ã€‚</p><p>æ“ä½œä¸Šé›¶åˆ‡ç‰‡ã€ç©ºåˆ‡ç‰‡å’Œæ­£å¸¸çš„åˆ‡ç‰‡éƒ½æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä½†æ˜¯nilåˆ‡ç‰‡ä¼šå¤šä¸¤ä¸ªç‰¹æ€§ï¼Œä¸€ä¸ªnilåˆ‡ç‰‡ç­‰äº <code>nil</code> å€¼ï¼Œä¸”è¿›è¡Œ <code>json</code> åºåˆ—åŒ–æ—¶å…¶å€¼ä¸º <code>null</code>ï¼Œnilåˆ‡ç‰‡è¿˜å¯ä»¥é€šè¿‡èµ‹å€¼ä¸º <code>nil</code> è·å¾—ã€‚</p><h2 id="æ•°ç»„ä¸-slice-å¤§æ¯”æ‹¼"><a href="#æ•°ç»„ä¸-slice-å¤§æ¯”æ‹¼" class="headerlink" title="æ•°ç»„ä¸ slice å¤§æ¯”æ‹¼"></a>æ•°ç»„ä¸ slice å¤§æ¯”æ‹¼</h2><p>å¯¹æ•°ç»„å’Œ <code>slice</code> åšäº†æ€§èƒ½æµ‹è¯•ï¼Œæºç åœ¨ <a href="https://github.com/thinkeridea/example/blob/master/array_slice/test/branch_test.go" target="_blank" rel="noopener">GitHub</a>ã€‚</p><p>å¯¹ä¸åŒå®¹é‡å’Œæ•°ç»„å’Œåˆ‡ç‰‡åšæ€§èƒ½æµ‹è¯•ï¼Œä»£ç å¦‚ä¸‹ï¼Œåˆ†ä¸ºï¼š100ã€1000ã€10000ã€100000ã€1000000ã€10000000<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkSlice100</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> s &#123;</span><br><span class="line">s[i] = <span class="number">1</span> + i</span><br><span class="line">_ = v</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkArray100</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">a := [<span class="number">100</span>]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> a &#123;</span><br><span class="line">a[i] = <span class="number">1</span> + i</span><br><span class="line">_ = v</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><blockquote><p>goos: darwin<br> goarch: amd64<br> pkg: github.com/thinkeridea/example/array_slice/test<br> BenchmarkSlice100-8             20000000            69.8 ns/op           0 B/op           0 allocs/op<br> BenchmarkArray100-8             20000000            69.0 ns/op           0 B/op           0 allocs/op<br> BenchmarkSlice1000-8             5000000           318 ns/op           0 B/op           0 allocs/op<br> BenchmarkArray1000-8             5000000           316 ns/op           0 B/op           0 allocs/op<br> BenchmarkSlice10000-8             200000          9024 ns/op       81920 B/op           1 allocs/op<br> BenchmarkArray10000-8             500000          3143 ns/op           0 B/op           0 allocs/op<br> BenchmarkSlice100000-8             10000        114398 ns/op      802816 B/op           1 allocs/op<br> BenchmarkArray100000-8             20000         61856 ns/op           0 B/op           0 allocs/op<br> BenchmarkSlice1000000-8             2000        927946 ns/op     8003584 B/op           1 allocs/op<br> BenchmarkArray1000000-8             5000        342442 ns/op           0 B/op           0 allocs/op<br> BenchmarkSlice10000000-8             100      10555770 ns/op    80003072 B/op           1 allocs/op<br> BenchmarkArray10000000-8              50      22918998 ns/op    80003072 B/op           1 allocs/op<br> PASS<br>ok      github.com/thinkeridea/example/array_slice/test    23.333s</p></blockquote><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥å‘ç°æ•°ç»„å’Œ <code>slice</code> åœ¨1000ä»¥å†…çš„å®¹é‡ä¸Šæ—¶æ€§èƒ½æœºä¼šä¸€è‡´ï¼Œè€Œä¸”éƒ½æ²¡æœ‰å†…å­˜åˆ†é…ï¼Œè¿™åº”è¯¥æ˜¯ç¼–è¯‘å™¨å¯¹ <code>slice</code> çš„ç‰¹æ®Šä¼˜åŒ–ã€‚<br>ä»10000~1000000å®¹é‡æ—¶æ•°ç»„çš„æ•ˆç‡å°±æ¯”<code>slice</code>å¥½äº†ä¸€å€æœ‰ä½™ï¼Œä¸»è¦åŸå› æ˜¯æ•°ç»„åœ¨æ²¡æœ‰å†…å­˜åˆ†é…åšäº†ç¼–è¯‘ä¼˜åŒ–ï¼Œè€Œ <code>slice</code> æœ‰å†…å­˜åˆ†é…ã€‚<br>ä½†æ˜¯10000000å®¹é‡å¾€åæ•°ç»„æ€§èƒ½å¤§å¹…åº¦ä¸‹é™ï¼Œ<code>slice</code> æ˜¯æ•°ç»„æ€§èƒ½çš„ä¸¤å€ï¼Œä¸¤ä¸ªéƒ½åœ¨è¿è¡Œæ—¶åšäº†å†…å­˜åˆ†é…ï¼Œå…¶å®è¿™ä¹ˆå¤§çš„æ•°ç»„è¿˜çœŸæ˜¯ä¸å¸¸è§ï¼Œä¹Ÿæ²¡æœ‰æ¯”è¾ƒåšç¼–è¯‘å™¨ä¼˜åŒ–äº†ã€‚</p><h2 id="slice-ä¸æ•°ç»„çš„åº”ç”¨åœºæ™¯æ€»ç»“"><a href="#slice-ä¸æ•°ç»„çš„åº”ç”¨åœºæ™¯æ€»ç»“" class="headerlink" title="slice ä¸æ•°ç»„çš„åº”ç”¨åœºæ™¯æ€»ç»“"></a>slice ä¸æ•°ç»„çš„åº”ç”¨åœºæ™¯æ€»ç»“</h2><p><code>slice</code> å’Œæ•°ç»„æœ‰äº›å·®åˆ«ï¼Œç‰¹åˆ«æ˜¯åº”ç”¨å±‚ä¸Šï¼Œç‰¹æ€§å·®åˆ«å¾ˆå¤§ï¼Œé‚£ä»€ä¹ˆæ—¶é—´ä½¿ç”¨æ•°ç»„ï¼Œä»€ä¹ˆæ—¶é—´ä½¿ç”¨åˆ‡ç‰‡å‘¢ã€‚<br>ä¹‹å‰åšäº†æ€§èƒ½æµ‹è¯•ï¼Œåœ¨1000ä»¥å†…æ€§èƒ½å‡ ä¹ä¸€è‡´ï¼Œåªæœ‰10000~1000000æ—¶æ‰ä¼šå‡ºç°æ•°ç»„æ€§èƒ½å¥½äº <code>slice</code>ï¼Œç”±äºæ•°ç»„åœ¨ç¼–è¯‘æ—¶ç¡®å®šé•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å†ç¼–å†™ç¨‹åºæ—¶å¿…é¡»ç¡®è®¤é•¿åº¦ï¼Œæ‰€æœ‰å¾€å¸¸ä¸ä¼šç”¨åˆ°æ›´å¤§çš„æ•°ç»„ï¼Œå¤§å¤šæ•°éƒ½åœ¨1000ä»¥å†…çš„é•¿åº¦ã€‚æˆ‘è®¤ä¸ºå¦‚æœåœ¨ç¼–å†™ç¨‹åºæ˜¯å°±å·²ç»ç¡®å®šæ•°æ®é•¿åº¦ï¼Œå»ºè®®ç”¨æ•°ç»„ï¼Œè€Œä¸”ç«Ÿå¯èƒ½æ˜¯å±€éƒ¨ä½¿ç”¨çš„ä½ç½®å»ºè®®ç”¨æ•°ç»„ï¼ˆé¿å…ä¼ é€’äº§ç”Ÿå€¼æ‹·è´ï¼‰ï¼Œæ¯”å¦‚ä¸€å¤©24å°æ—¶ï¼Œä¸€å°æ—¶60åˆ†é’Ÿï¼Œipæ˜¯4ä¸ª <code>byte</code>è¿™ç§æƒ…å†µæ˜¯å¯ä»¥ç”¨æ—¶æ•°ç»„çš„ã€‚</p><p>ä¸ºä»€ä¹ˆæ¨èç”¨æ•°ç»„ï¼Œåªè¦èƒ½åœ¨ç¼–å†™ç¨‹åºæ˜¯ç¡®å®šæ•°æ®é•¿åº¦æˆ‘éƒ½ä¼šç”¨æ•°ç»„ï¼Œå› ä¸ºå…¶ç±»å‹ä¼šå¸®åŠ©é˜…è¯»ç†è§£ç¨‹åºï¼Œ<code>dayHour := [24]Data</code> ä¸€çœ¼å°±çŸ¥é“æ˜¯æŒ‰å°æ—¶åˆ‡åˆ†æ•°æ®å­˜å‚¨çš„ï¼Œå¦‚è¦ä¼ é€’æ•°ç»„æ—¶å¯ä»¥è€ƒè™‘ä¼ é€’æ•°ç»„çš„æŒ‡é’ˆï¼Œå½“ç„¶ä¼šå¸¦æ¥ä¸€äº›æ“ä½œä¸æ–¹ä¾¿ï¼Œå¾€å¸¸æˆ‘ä½¿ç”¨æ•°ç»„éƒ½æ˜¯ä¸éœ€è¦ä¼ é€’ç»™å…¶å®ƒå‡½æ•°çš„ï¼Œå¯èƒ½ä¼šåœ¨ <code>struct</code> é‡Œé¢ä¿å­˜æ•°ç»„ï¼Œç„¶åä¼ é€’ <code>struct</code> çš„æŒ‡é’ˆï¼Œæˆ–è€…ç”¨ <code>unsafe</code> æ¥åè§£ææ•°ç»„æŒ‡é’ˆåˆ°æ–°çš„æ•°ç»„ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿæ•°æ®æ‹·è´ï¼Œå¹¶ä¸”åªå¢åŠ ä¸€å¥è½¬æ¢è¯­å¥ã€‚<code>slice</code> ä¼šæ¯”æ•°ç»„å¤šå­˜å‚¨ä¸‰ä¸ª <code>int</code> çš„å±æ€§ï¼Œè€Œä¸”æŒ‡é’ˆå¼•ç”¨ä¼šå¢åŠ  <code>GC</code> æ‰«æçš„æˆæœ¬ï¼Œæ¯æ¬¡ä¼ é€’éƒ½ä¼šå¯¹è¿™ä¸‰ä¸ªå±æ€§è¿›è¡Œæ‹·è´ï¼Œå¦‚æœå¯ä»¥ä¹Ÿå¯ä»¥è€ƒè™‘ä¼ é€’ <code>slice</code> çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆåªæœ‰ä¸€ä¸ª <code>int</code> çš„å¤§å°ã€‚</p><p><strong> å¯¹äºä¸ç¡®å®šå¤§å°çš„æ•°æ®åªèƒ½ç”¨ <code>slice</code>ï¼Œå¦åˆ™å°±è¦è‡ªå·±åšæ‰©å®¹å¾ˆéº»çƒ¦ï¼Œ å¯¹äºç¡®å®šå¤§å°çš„é›†åˆå»ºè®®ä½¿ç”¨æ•°ç»„ã€‚</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;array&lt;/code&gt; å’Œ &lt;code&gt;slice&lt;/code&gt; çœ‹ä¼¼ç›¸ä¼¼ï¼Œå´æœ‰ç€æå¤§çš„ä¸åŒï¼Œä½†ä»–ä»¬ä¹‹é—´è¿˜æœ‰ç€åƒæ¬¡ä¸‡ç¼•çš„è”ç³» &lt;code&gt;slice&lt;/code&gt; æ˜¯å¼•ç”¨ç±»å‹ã€æ˜¯ &lt;code&gt;array&lt;/code&gt; çš„å¼•ç”¨ï¼Œç›¸å½“äºåŠ¨æ€æ•°ç»„ï¼Œ&lt;br&gt;è¿™äº›éƒ½æ˜¯ &lt;code&gt;slice&lt;/code&gt; çš„ç‰¹æ€§ï¼Œä½†æ˜¯ &lt;code&gt;slice&lt;/code&gt; åº•å±‚å¦‚ä½•è¡¨ç°ï¼Œå†…å­˜ä¸­æ˜¯å¦‚ä½•åˆ†é…çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¨‹åºä¸­å¤§é‡ä½¿ç”¨ &lt;code&gt;slice&lt;/code&gt; çš„æƒ…å†µä¸‹ï¼Œæ€æ ·å¯ä»¥é«˜æ•ˆä½¿ç”¨ &lt;code&gt;slice&lt;/code&gt;ï¼Ÿ&lt;br&gt;ä»Šå¤©å€ŸåŠ© &lt;code&gt;Go&lt;/code&gt; çš„ &lt;code&gt;unsafe&lt;/code&gt; åŒ…æ¥æ¢ç´¢ &lt;code&gt;array&lt;/code&gt; å’Œ &lt;code&gt;slice&lt;/code&gt; çš„å„ç§å¥¥å¦™ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="https://blog.thinkeridea.com/categories/go/"/>
    
    
      <category term="slice" scheme="https://blog.thinkeridea.com/tags/slice/"/>
    
      <category term="array" scheme="https://blog.thinkeridea.com/tags/array/"/>
    
      <category term="unsafe" scheme="https://blog.thinkeridea.com/tags/unsafe/"/>
    
  </entry>
  
  <entry>
    <title>ã€Goã€‘ä¸€æ¬¡è¯»é”é‡å…¥å¯¼è‡´çš„æ­»é”æ•…éšœ</title>
    <link href="https://blog.thinkeridea.com/201812/go/yi_ci_du_suo_chong_ru_dao_zhi_de_si_suo_gu_zhang.html"/>
    <id>https://blog.thinkeridea.com/201812/go/yi_ci_du_suo_chong_ru_dao_zhi_de_si_suo_gu_zhang.html</id>
    <published>2018-12-25T14:30:10.000Z</published>
    <updated>2019-01-12T14:47:24.523Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸¤å¤©å‰ç¬¬ä¸€æ¬¡é‡åˆ°è‡ªå·±çš„ç¨‹åºå‡ºç°æ­»é”ï¼Œ æˆ‘ä¸€ç›´éå¸¸çš„å°å¿ƒä½¿ç”¨é”ï¼Œäº†è§£æ­»é”å¯¼è‡´çš„å„ç§å¯èƒ½æ€§ï¼Œ<br>è¿™æ¬¡çš„ç»å†è®©æˆ‘æœªæ¥ä¼šæ›´åŠ å°å¿ƒï¼Œä¸‹é¢æ¥å›é¡¾ä¸€ä¸‹æ­»é”å‘ç”Ÿçš„è¿‡ç¨‹ä¸ä»£ç æ¼”è¿›çš„è¿‡ç¨‹å§ã€‚</p><h2 id="ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹"><a href="#ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹" class="headerlink" title="ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹"></a>ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹</h2><p>æˆ‘çš„ç¨‹åºä¸­æœ‰ä¸€å—ç¼“å­˜ï¼Œæ•°æ®ä¼šç»„ç»‡å¥½æ”¾åˆ°å†…å­˜ä¸­ï¼Œä¼šæ ¹æ®æ•°æ®æºï¼ˆMySQLï¼‰æ›´æ–°è€Œåˆ·æ–°ç¼“å­˜ï¼Œæ˜¯è¯»å¤šå†™å°‘çš„åº”ç”¨åœºæ™¯ã€‚<br>å†…å­˜ä¸­æœ‰ä¸€ä¸ªå¾ˆå¤§æ•°æ®åˆ—è¡¨ï¼Œç¼“å­˜æ¨¡å—ä¼šæŒ‰æ•°æ®ç»´åº¦è¿›è¡Œåˆ†ç»„ï¼Œæ¯æ¬¡è®¿é—®æ ¹æ®ç»´åº¦æŸ¥æ‰¾åˆ°è¿™ä¸ªåˆ—è¡¨é‡Œé¢çš„æ‰€æœ‰æ•°æ®ã€‚<br>ä¸šåŠ¡æ¨¡å—æ‹¿åˆ°æ•°æ®åä¼šæ ¹æ®ä¸šåŠ¡éœ€è¦å†åšä¸€æ¬¡ç­›é€‰ï¼Œé€‰å‡ºNä¸ªç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼ˆå…·ä½“å¤šå°‘ä¸ªç”±ä¸šåŠ¡æ¨¡å—çš„è§„åˆ™å†³å®šï¼‰ã€‚</p><a id="more"></a><p>ä»¥ä¸‹æ˜¯ç®€åŒ–çš„ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">lock sync.RWMutex</span><br><span class="line">data []<span class="keyword">int</span> <span class="comment">// å®é™…æ•°æ®æ¯”è¿™ä¸ªå¤æ‚å¾ˆå¤šæœ‰å¾ˆå¤šç»´åº¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Get</span><span class="params">()</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">c.lock.RLock()</span><br><span class="line"><span class="keyword">defer</span> c.lock.RUnlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­›é€‰æ•°æ®ï¼Œ ç®€å•å†™ä¸€ä¸ªç­›é€‰è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c.data &#123;</span><br><span class="line"><span class="keyword">if</span> c.data[i] &gt; <span class="number">10</span> &#123;</span><br><span class="line">res = <span class="built_in">append</span>(res, c.data[i])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ•°æ®ä¼šå¾ˆå¤šï¼Œå¯å®é™…ä¸šåŠ¡éœ€è¦çš„æ•°æ®åªæœ‰å‡ ä¸ªè€Œå·²ï¼Œé‚£åšä¸€ä¸ªä¼˜åŒ–å§ï¼Œåˆ©ç”¨ <code>go</code> çš„ <code>chan</code> å®ç°ä¸€ä¸ªè¿­ä»£ç”Ÿæˆå™¨ï¼Œæ¯æ¬¡åªè¿”å›ä¸€ä¸ªæ•°æ®ï¼Œä¸šåŠ¡ç«¯æ‰¾åˆ°éœ€è¦çš„æ•°æ®åç«‹å³ç»ˆæ­¢ã€‚</p><p>è°ƒæ•´åçš„æ–¹æ³•å¤§è‡´åƒä¸‹é¢è¿™æ ·:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">lock sync.RWMutex</span><br><span class="line">data []<span class="keyword">int</span> <span class="comment">// å®é™…æ•°æ®æ¯”è¿™ä¸ªå¤æ‚å¾ˆå¤šæœ‰å¾ˆå¤šç»´åº¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Get</span><span class="params">(next <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">c.lock.RLock()</span><br><span class="line"><span class="keyword">defer</span> c.lock.RUnlock()</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(ch)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­›é€‰æ•°æ®ï¼Œ ç®€å•å†™ä¸€ä¸ªç­›é€‰è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c.data &#123;</span><br><span class="line"><span class="keyword">if</span> c.data[i] &gt; <span class="number">10</span> &#123;</span><br><span class="line"></span><br><span class="line">ch &lt;- i</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, ok := &lt;-next; !ok &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ç«¯çš„ä»£ç ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">c := Cache&#123;&#125;</span><br><span class="line">next := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c.Get(next) &#123;</span><br><span class="line">    data = <span class="built_in">append</span>(data, i)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt;= <span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">close</span>(next)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·è°ƒæ•´åæŸ¥çœ‹ç¨‹åºçš„å†…å­˜åˆ†é…æ˜¾è‘—é™ä½ï¼Œè€Œä¸”å¹³å®‰æ— äº‹åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œäº†åŠä¸ªæœˆ^_^ï¼Œå½“ç„¶æˆªæ­¢å½“å‰è¿˜ä¸ä¼šå‡ºç°æ­»é”çš„æƒ…å†µã€‚<br>æœ‰ä¸€å¤©ä¸šåŠ¡è°ƒæ•´äº†ï¼Œåœ¨ <code>cache</code> æ¨¡å—æœ‰å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œå…¬ç”¨è¿™ä¸ªé”ï¼ˆå®é™…æˆ‘ç¼“å­˜æ¨¡å—ä¸ºäº†ç»Ÿä¸€ï¼Œéƒ½ä½¿ç”¨ä¸€ä¸ªé”ï¼Œæ–¹ä¾¿ç®¡ç†ï¼‰ï¼Œä¸‹é¢çš„ä»£ç ä¹Ÿå†™åˆ°è¿™ä¸ª <code>cache</code> ç»„ä»¶é‡Œé¢ã€‚</p><p>ä»¥ä¸‹ä»£ç åªå¢åŠ äº†æ”¹å˜çš„éƒ¨åˆ†ï¼Œ<code>....</code> ä¿æŒåŸæ¥çš„ä»£ç ä¸å˜ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">....</span><br><span class="line">x <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">XX</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">int</span></span>&#123;</span><br><span class="line">c.lock.RLock()</span><br><span class="line"><span class="keyword">defer</span> c.lock.RUnlock()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span>  i &gt;c.x &#123;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸€ä¸ªæ–¹æ³•æ€ä¹ˆå°±å¯¼è‡´æ­»é”äº†å‘¢ï¼Œä¸»è¦æ˜¯è°ƒç”¨ç«¯çš„ä¸šåŠ¡ä»£ç ä¹Ÿå‘ç”Ÿå˜åŒ–äº†ï¼Œæ›´æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">c := Cache&#123;&#125;</span><br><span class="line">next := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c.Get(next) &#123;</span><br><span class="line">    data = <span class="built_in">append</span>(data, i)</span><br><span class="line">    <span class="keyword">if</span> c.XX(i) != i  &#123; <span class="comment">// åœ¨è¿™é‡Œè°ƒç”¨äº†ç¼“å­˜æ¨¡å—çš„å¦ä¸€ä¸ªæ–¹æ³•</span></span><br><span class="line">        <span class="built_in">close</span>(next)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åçš„ä»£ç ä¸Šçº¿å­˜æ´»äº†5å¤©å°±æŒ‚äº†ï¼Œå®é™…æ˜¯å½“æ—¶ä¸šåŠ¡è®¢å•éœ€æ±‚å¾ˆå°‘ï¼Œåªæ˜¯æœ‰å¾ˆå¤šæµé‡è¯·æ±‚ï¼Œå¹¶æ²¡æœ‰é¢‘ç¹è®¿é—®è¿™ä¸ªæ–¹æ³•ï¼Œå¦è€…ä¼šåœ¨æçŸ­çš„æ—¶é—´å¯¼è‡´æ­»é”ï¼Œ<br>é€šè¿‡è¿™å—ç®€åŒ–çš„ä»£ç ï¼Œä¹Ÿå¾ˆéš¾åˆ†æå‡ºä¼šå¯¼è‡´æ­»é”ï¼ŒçœŸå®çš„ä¸šåŠ¡ä»£ç å¾ˆå¤šï¼Œè€Œä¸”è°ƒç”¨å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬é€šè¿‡ä»£ç å®¡æ ¸å¹¶æ²¡æœ‰å‘ç°ä»»ä½•é—®é¢˜ã€‚</p><h2 id="äº‹æ•…ç°åœºåˆ†ææ’æŸ¥é—®é¢˜"><a href="#äº‹æ•…ç°åœºåˆ†ææ’æŸ¥é—®é¢˜" class="headerlink" title="äº‹æ•…ç°åœºåˆ†ææ’æŸ¥é—®é¢˜"></a>äº‹æ•…ç°åœºåˆ†ææ’æŸ¥é—®é¢˜</h2><p>ä¸Šçº¿5å¤©åçªç„¶æ¥åˆ°æœåŠ¡æ— æ³•å“åº”çš„æŠ¥è­¦ï¼Œäº‹æ•…å‘ç”Ÿç«‹å³æŸ¥çœ‹äº† <code>grafana</code> çš„ç›‘æ§æ•°æ®ï¼Œå‘ç°åœ¨ææ®µæ—¶é—´å†…æœåŠ¡å™¨èµ„æºæ¶ˆè€—æé€Ÿå¢é•¿ï¼Œç„¶åå°±ç«‹å³æ²¡æœ‰å“åº”äº†</p><p><img src="/assets/image/20181225/20181219-011353.jpg" alt=""></p><p>é€šè¿‡ä¸šåŠ¡ç›‘æ§å‘ç°æœåŠ¡åœ¨æç«¯çš„æ—¶é—´æ‰“å¼€è¿‘10ä¸‡ä¸ª <code>goroutine</code> ä¹‹åæŒç»­äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œ<br><code>cpu</code> å ç”¨å’Œ <code>gc</code> éƒ½å¾ˆæ­£å¸¸ï¼Œ å†…å­˜æ–¹é¢å¯ä»¥çœ‹å‡ºçŸ­æ—¶é—´å†…åˆ†é…äº†å¾ˆå¤šå†…å­˜ï¼Œä½†æ˜¯æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œ<code>gc</code> æ²¡æ³•å›æ”¶è¯´æ˜ä¸€ç›´è¢«å ç”¨ï¼Œ</p><p>çœ‹åˆ°è¿™é‡Œæˆ‘å¿ƒé‡Œåœ¨æƒ³å¯èƒ½æ˜¯æœ‰ä¸ª <code>goroutine</code> å› ä¸ºä»€ä¹ˆåŸå› å¯¼è‡´æ— æ³•ç»“æŸé€ æˆçš„äº‹æ•…å§ï¼Œ<br>ç„¶åæˆ‘å†å¾€ä¸‹çœ‹ï¼ˆå®é™…é¡µé¢æ˜¯åœ¨éœ€è¦æ»šåŠ¨å±å¹•ï¼Œç¬¬ä¸€å±åªæ˜¾ç¤ºäº†ä¸Šé¢6ä¸ªæ¨¡å—ï¼‰ï¼Œå‘ç° open files å’Œ <code>goroutine</code> çš„æƒ…å†µä¸€è‡´ï¼Œå¹¶ä¸”ä¹‹åçš„æ•°æ®çªç„¶ä¸­æ–­ï¼Œ<br>ä¸­æ–­æ˜¯å› ä¸ºæœåŠ¡æ— æ³•å½±å“ï¼Œä¹Ÿå°±æ— æ³•é‡‡é›†æœåŠ¡çš„ä¿¡æ¯äº†ã€‚</p><p><img src="/assets/image/20181225/openfd.jpg" alt=""></p><p><code>goroutine</code> å¹¶ä¸ä¼šå ç”¨ open filesï¼Œä¸€ä¸ªhttpæœåŠ¡å¯¼è‡´è¿™ç§æƒ…å†µå¤§æ¦‚åªèƒ½æ˜¯ç½‘ç»œè¿æ¥è¿‡å¤šï¼Œæˆ‘ä»¬é­å—æ”»å‡»äº†å—â€¦â€¦<br>æ˜¾ç„¶æ˜¯æ²¡æœ‰çš„ä¸ç„¶cpuä¸èƒ½å¾ˆæ­£å¸¸ï¼Œé‚£å°±æ˜¯æœ‰å¯èƒ½è¯·æ±‚æ— æ³•å“åº”ï¼Œä»€ä¹ˆåŸå› å¯¼è‡´å‘¢ï¼Ÿ</p><p>ä½¿ç”¨ <code>lsof -n | grep dsp | wc -l</code> å‘½ä»¤å»æœåŠ¡å™¨æŸ¥æ‰¾æœåŠ¡æ‰“å¼€æ–‡ä»¶æ•°ï¼Œç¡®å®åœ¨å…­ä¸‡äº”åƒå¤šï¼Œ<br>é€šè¿‡ <code>cat /proc/30717/limits</code> å‘ç° <code>Max open files            65535                65535                files</code>ï¼Œ<br>é…ç½®çš„æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°åªæœ‰ 65535ï¼Œä½¿ç”¨ <code>lsof -n | grep dsp |grep TCP | wc -l</code> å‘ç°æ•°æ®å’Œä¹‹å‰æ¥è¿‘ï¼Œåªå°äº†å‡ ä¸ªï¼Œé‚£æ˜¯æ—¥å¿—æ–‡ä»¶å ç”¨çš„ã€‚</p><p>æŸ¥çœ‹æ—¥å¿—å‘ç°å¤§é‡ <code>http: Accept error: accept tcp 172.17.191.231:8090: accept4: too many open files; retrying in 1s</code> é”™è¯¯ã€‚</p><p>è¿™äº›æ•°æ®å¸®åŠ©æˆ‘å¿«é€Ÿå®šä½ç¡®å®æ˜¯æœ‰è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ— æ³•å“åº”å¯¼è‡´çŸ­æ—¶é—´å†…å ç”¨å¾ˆå¤šæ–‡ä»¶æ‰“å¼€æ•°ï¼Œå¯¼è‡´ç³»ç»Ÿé™åˆ¶æ— æ³•å»ºç«‹æ–°çš„è¿æ¥ã€‚<br>è¿™é‡Œè¦è¯´ä¸€ä¸‹ï¼Œå³ä½¿å®¢æˆ·ç«¯æ–­å¼€è¿æ¥äº†ï¼ŒæœåŠ¡å™¨è¿æ¥è¿˜æ˜¯æ²¡æœ‰åŠæ³•å…³é—­ï¼Œå› ä¸º <code>goroutine</code> æ²¡æœ‰åŠæ³•å…³é—­ï¼Œ é™¤éè‡ªå·±é€€å‡ºã€‚</p><p>æ‰¾åˆ°åŸå› äº†ï¼ŒæœåŠ¡æ²¡æ³•å“åº”ï¼Œæ²¡æ³•é€šè¿‡ç°åœºæŸ¥æ‰¾é—®é¢˜äº†ï¼Œå…ˆé‡æ–°å¯åŠ¨ä¸€ä¸‹æœåŠ¡ï¼Œæ¢å¤ä¸šåŠ¡åœ¨æŸ¥æ‰¾ä»£ç é—®é¢˜ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯æŸ¥æ‰¾ä»£ç é—®é¢˜äº†ï¼ŒæœŸé—´åˆå‡ºç°äº†ä¸€æ¬¡æ•…éšœï¼Œç«‹å³é‡å¯æœåŠ¡ï¼Œæ¢å¤ä¸šåŠ¡ã€‚</p><h2 id="åˆ†æè§£å†³é—®é¢˜"><a href="#åˆ†æè§£å†³é—®é¢˜" class="headerlink" title="åˆ†æè§£å†³é—®é¢˜"></a>åˆ†æè§£å†³é—®é¢˜</h2><p>é€šè¿‡å‡ ä¸ªå°æ—¶åˆ†æä»£ç é€»è¾‘ï¼Œç»ˆäºæœ‰äº†è¿›å±•ï¼Œå‘ç°ä¸Šé¢çš„ç¤ºä¾‹ä»£ç é€»è¾‘å—å¯¼è‡´è¯»é”é‡å…¥ï¼Œå­˜åœ¨æ­»é”é£é™©ï¼Œè¿™ç§æ­»é”çš„ç¢°æ’æ¦‚ç‡éå¸¸ä½ï¼Œ<br>ä¹‹å‰è¯´è¿‡æˆ‘ä»¬çš„ç¼“å­˜æ˜¯è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¦‚æœåªæ˜¯è¯»å–æ•°æ®ï¼Œä¸Šé¢çš„ä»£ç ä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€å¤©åˆ·æ–°ç¼“å­˜çš„æ¬¡æ•°ä¹Ÿä¸è¿‡ç™¾ä½™æ¬¡è€Œå·²ã€‚</p><p>çœ‹ä¸€ä¸‹ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆå¯¼è‡´çš„æ­»é”å§ï¼š</p><ul><li>ç¨‹åºæ‰§è¡Œ <code>cache.Get</code> è·å–ä¸€ä¸ª <code>chan</code>, åœ¨ <code>cache.Get</code> é‡Œé¢æœ‰ä¸€ä¸ª <code>goroutine</code> è¯»å–æ•°æ®åªæœ‰åŠ äº†è¯»å†™é”ï¼Œåªæœ‰ <code>goroutine</code> å…³é—­æ‰ä¼šé‡Šæ”¾</li><li><code>for i := range c.Get(next) {</code> éå† <code>chan</code> æ—¶ <code>goroutine</code> ä¸ä¼šç»“æŸï¼Œä¹Ÿå°±è¯´è¯»é”æ²¡æœ‰è¢«é‡Šæ”¾</li><li>éå†æ—¶æ‰§è¡Œäº† <code>c.XX(i)</code> æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹é¢é‡Œé¢ä¹ŸåŠ äº†è¯»é”ï¼Œ å½¢æˆäº†è¯»é”é‡å…¥çš„åœºæ™¯ï¼Œä½†æ˜¯è¯¥æ”¾æ‰§è¡Œå‘¨æœŸå¾ˆçŸ­ï¼Œæ‰§è¡Œå®Œå°±ä¼šé©¬ä¸Šé‡Šæ”¾</li></ul><p>å¥½å§ï¼Œè¿™æ ·çš„æµç¨‹å¹¶æ²¡æœ‰å½¢æˆæ­»é”ï¼Œä»€ä¹ˆæƒ…å†µä¸‹å¯¼è‡´çš„æ­»é”å‘¢ï¼Œæ¥ç€çœ‹ä¸€ä¸‹ä¸€ä¸ªåœºæ™¯ï¼š</p><ul><li>ç¨‹åºæ‰§è¡Œ <code>cache.Get</code> è·å–ä¸€ä¸ª <code>chan</code>, åœ¨ <code>cache.Get</code> é‡Œé¢æœ‰ä¸€ä¸ª <code>goroutine</code> è¯»å–æ•°æ®åªæœ‰åŠ äº†è¯»å†™é”ï¼Œåªæœ‰ <code>goroutine</code> å…³é—­æ‰ä¼šé‡Šæ”¾</li><li><code>for i := range c.Get(next) {</code> éå† <code>chan</code> æ—¶ <code>goroutine</code> ä¸ä¼šç»“æŸï¼Œä¹Ÿå°±è¯´è¯»é”æ²¡æœ‰è¢«é‡Šæ”¾</li><li>æ•°æ®å‘ç”Ÿäº†æ”¹å˜ï¼Œè§¦å‘äº†ç¼“å­˜åˆ·æ–°ï¼Œç”³è¯·ç‹¬å é”ï¼ˆå†™é”ï¼‰ï¼Œç­‰å¾…æ‰€æœ‰è¯»é”é‡Šæ”¾</li><li>éå†æ—¶æ‰§è¡Œ <code>c.XX(i)</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”³è¯·è¯»é”ï¼Œå› ä¸ºå†™é”åœ¨ç­‰å¾…ï¼Œæ‰€ä»¥ä»»ä½•è¯»é”éƒ½å°†ç­‰å¾…å†™é”é‡Šæ”¾åæ‰èƒ½æ·»åŠ æˆåŠŸ</li><li>for å¾ªç¯è¢«é˜»å¡ï¼Œ <code>cache.Get</code> é‡Œé¢çš„ <code>goroutine</code> æ— æ³•é€€å‡ºï¼Œæ— æ³•é‡Šæ”¾è¯»é”</li><li>å†™é”ç­‰å¾…æ‰€æœ‰è¯»é”é‡Šæ”¾</li><li><code>c.XX(i)</code> ç­‰å¾…å†™é”é‡Šæ”¾</li><li>â€¦.</li></ul><p>é‡ç‚¹çœ‹ç¬¬ä¸‰æ­¥ï¼Œè¿™é‡Œæ˜¯å…³é”®ï¼Œå› ä¸ºåœ¨ä¸¤ä¸ªåµŒå¥—çš„è¯»é”ä¸­é—´ç”³è¯·å†™é”ï¼Œå¯¼è‡´æ­»é”å‘ç”Ÿï¼Œæ‰¾åˆ°åŸå› ä¿®å¤èµ·æ¥å¾ˆç®€å•çš„ï¼Œ</p><p>è°ƒæ•´ <code>cache.Get</code> åŠ é”çš„æ–¹æ³•ï¼ŒæŠŠ <code>c.data</code> èµ‹å€¼ç»™ä¸€ä¸ªä¸´æ—¶å˜é‡ <code>data</code>, åœ¨è¿™æ®µä»£ç å‰ååŠ é”å’Œé‡Šæ”¾é”ï¼Œé”çš„ä»£ç å—æ›´å°ï¼Œæ—¶é—´æ›´çŸ­</p><p><code>c.data</code> å•ç‹¬æ‹·è´æ˜¯å®‰å…¨çš„ï¼Œé‚£æ€•æ˜¯æŒ‡é’ˆæ•°æ®ï¼Œå› ä¸ºæ¯æ¬¡åˆ·æ–°ç¼“å­˜éƒ½ä¼šç»™ <code>c.data</code> é‡æ–°èµ‹å€¼ï¼Œåˆ†é…æ–°çš„å†…å­˜ç©ºé—´ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">lock sync.RWMutex</span><br><span class="line">data []<span class="keyword">int</span> <span class="comment">// å®é™…æ•°æ®æ¯”è¿™ä¸ªå¤æ‚å¾ˆå¤šæœ‰å¾ˆå¤šç»´åº¦</span></span><br><span class="line">x <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">XX</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    c.lock.RLock()</span><br><span class="line">    <span class="keyword">defer</span> c.lock.RUnlock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>  i &gt;c.x &#123;</span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Get</span><span class="params">(next <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(ch)</span><br><span class="line"></span><br><span class="line">c.lock.RLock()</span><br><span class="line">data := c.data</span><br><span class="line">c.lock.RUnlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­›é€‰æ•°æ®ï¼Œ ç®€å•å†™ä¸€ä¸ªç­›é€‰è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> data &#123;</span><br><span class="line"><span class="keyword">if</span> data[i] &gt; <span class="number">10</span> &#123;</span><br><span class="line"></span><br><span class="line">ch &lt;- i</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, ok := &lt;-next; !ok &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®å¤ä¹‹åçš„ä¸šåŠ¡çŠ¶æ€ï¼š</p><p><img src="/assets/image/20181225/20181219-011418.jpg" alt=""></p><h2 id="å¤ç°é—®é¢˜"><a href="#å¤ç°é—®é¢˜" class="headerlink" title="å¤ç°é—®é¢˜"></a>å¤ç°é—®é¢˜</h2><p>ç”¨ç¨‹åºå¤ç°ä¸€ä¸‹ä¸Šé¢çš„åœºæ™¯å¯ä»¥å—ï¼Œå¥½åƒæœ‰ç‚¹éš¾ï¼Œæˆ‘å†™äº†ä¸€ä¸ªç®€å•çš„å¤ç°ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> l = sync.RWMutex&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">l.RLock() <span class="comment">// è¯»é”1</span></span><br><span class="line"><span class="keyword">defer</span> l.RUnlock()</span><br><span class="line">fmt.Println(<span class="number">1</span>)</span><br><span class="line">c &lt;- <span class="number">1</span></span><br><span class="line">fmt.Println(<span class="number">2</span>)</span><br><span class="line">runtime.Gosched()</span><br><span class="line">fmt.Println(<span class="number">3</span>)</span><br><span class="line">b()</span><br><span class="line">fmt.Println(<span class="number">4</span>)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="number">5</span>)</span><br><span class="line">&lt;-c</span><br><span class="line">fmt.Println(<span class="number">6</span>)</span><br><span class="line">l.Lock()</span><br><span class="line">fmt.Println(<span class="number">7</span>)</span><br><span class="line">fmt.Println(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">defer</span> l.Unlock()</span><br><span class="line">fmt.Println(<span class="number">9</span>)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="number">10</span>)</span><br><span class="line">l.RLock() <span class="comment">// è¯»é”2</span></span><br><span class="line">fmt.Println(<span class="number">11</span>)</span><br><span class="line"><span class="keyword">defer</span> l.RUnlock()</span><br><span class="line">fmt.Println(<span class="number">12</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µç¨‹åºçš„è¾“å‡º(å— <code>goroutine</code> è¿è¡Œæ—¶å½±å“åœ¨è¾“å‡ºæ•°å­—3ä¹‹å‰ä¼šæœ‰äº›è®¸å·®å¼‚)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">10</span><br></pre></td></tr></table></figure><p>åˆ†æä¸€ä¸‹è¿™ä¸ªè¿è¡Œæµç¨‹å§:</p><ul><li>é¦–å…ˆåŠ ä¸Šè¯»é”1ï¼Œå°±æ˜¯ <code>fmt.Println(1)</code> ä¹‹å‰ï¼Œ çŠ¶æ€åŠ è¯»é”1</li><li>å¦å¤–ä¸€ä¸ª <code>goroutine</code> å¯åŠ¨ï¼Œ<code>fmt.Println(5)</code>ï¼Œ çŠ¶æ€åŠ è¯»é”1</li><li>å‘é€æ•°æ® <code>c &lt;- 1</code> ï¼Œ çŠ¶æ€åŠ è¯»é”1</li><li>æ¥å—åˆ°æ•°æ® <code>&lt;-c</code> <code>fmt.Println(6)</code>ï¼Œ çŠ¶æ€åŠ è¯»é”1</li><li>è¾“å‡º 2 <code>fmt.Println(2)</code>ï¼Œ çŠ¶æ€åŠ è¯»é”1</li><li>æš‚åœå½“å‰ <code>goroutine</code> <code>runtime.Gosched()</code> ï¼Œ çŠ¶æ€åŠ è¯»é”1</li><li>ç”³è¯·å†™é” <code>l.Lock()</code>ï¼Œ ç­‰å¾…è¯»é”1é‡Šæ”¾ï¼Œ çŠ¶æ€åŠ è¯»é”1ã€å†™é”ç­‰å¾…</li><li>åˆ‡æ¢ <code>goroutine</code> æ‰§è¡Œ <code>fmt.Println(3)</code> ä¸ <code>b()</code>ï¼Œ çŠ¶æ€åŠ è¯»é”1ã€å†™é”ç­‰å¾…</li><li>è¾“å‡º10 <code>fmt.Println(10)</code>ï¼Œ ç”³è¯·è¯»é”2ï¼Œç­‰å¾…å†™é”é‡Šæ”¾ï¼Œ çŠ¶æ€åŠ è¯»é”1ã€å†™é”ç­‰å¾…ã€è¯»é”2ç­‰å¾…</li><li>æ”¯æŒç¨‹åºæ°¸ä¹…é˜»å¡â€¦â€¦</li></ul><h2 id="åˆ†æè¯»å†™é”å®ç°"><a href="#åˆ†æè¯»å†™é”å®ç°" class="headerlink" title="åˆ†æè¯»å†™é”å®ç°"></a>åˆ†æè¯»å†™é”å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RLock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">_ = rw.w.state</span><br><span class="line">race.Disable()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="number">1</span>) &lt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// A writer is pending, wait for it.</span></span><br><span class="line">runtime_SemacquireMutex(&amp;rw.readerSem, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”³è¯·å†™é”æ—¶ä¼šåœ¨ <code>rw.readerCount</code> è¯»æ•°é‡å˜é‡ä¸Šè‡ªå¢åŠ  1ï¼Œå¦‚æœç»“æœå°äº 0ï¼Œå½“å‰è¯»é”è¿›å…¥ä¿®æ”¹ç­‰å¾…è¯»é”å”¤é†’ä¿¡å·ï¼Œ<br>å•ç‹¬çœ‹ç€ä¸€ä¸ªæ–¹æ³•ä¼šæ¯”è¾ƒæ‡µï¼Œä¸ºå•¥è¯»çš„æ•°é‡ä¼šå°äº0å‘¢ï¼Œæ¥ç€çœ‹å†™é”ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">_ = rw.w.state</span><br><span class="line">race.Disable()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// First, resolve competition with other writers.</span></span><br><span class="line">rw.w.Lock()</span><br><span class="line"><span class="comment">// Announce to readers there is a pending writer.</span></span><br><span class="line">r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</span><br><span class="line"><span class="comment">// Wait for active readers.</span></span><br><span class="line"><span class="keyword">if</span> r != <span class="number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="number">0</span> &#123;</span><br><span class="line">runtime_SemacquireMutex(&amp;rw.writerSem, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">race.Acquire(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”³è¯·å†™é”æ—¶ä¼šå…ˆåŠ ä¸Šäº’æ–¥é”ï¼Œä¹Ÿå°±æ˜¯æœ‰å…¶å®ƒå†™çš„å®¢æˆ·ç«¯çš„è¯ä¼šç­‰å¾…å†™é”é‡Šæ”¾æ‰èƒ½åŠ ä¸Šï¼Œå…·ä½“å®ç°çœ‹äº’æ–¥é”çš„ä»£ç ï¼Œ<br>ç„¶ååœ¨ <code>rw.readerCount</code> ä¸Šè‡ªå¢ä¸€ä¸ªæå¤§çš„è´Ÿæ•° <code>1 &lt;&lt; 30</code> ï¼Œ è¯»å†™é”è¿™é‡Œä¹Ÿå°±é™åˆ¶äº†æˆ‘ä»¬çš„åŒæ—¶è¯»çš„è¿›ç¨‹ä¸èƒ½è¶…è¿‡è¿™ä¸ªå€¼ã€‚<br>ç„¶ååœ¨ç»“æœä¸ŠåŠ ä¸Š <code>rwmutexMaxReaders</code> ä¹Ÿå°±æ˜¯ <code>atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</code> å¾—åˆ°å®é™…è¯»å®¢æˆ·ç«¯çš„æ•°é‡<br>å¦‚æœè¯»çš„å®¢æˆ·ç«¯ä¸ç­‰äº0ï¼Œå°±åœ¨ <code>rw.readerWait</code> è‡ªå¢è¯»å®¢æˆ·ç«¯çš„æ•°é‡ï¼Œä¹‹åé™·å…¥ç¡çœ ï¼Œç­‰å¾… <code>rw.writerSem</code> å”¤é†’ã€‚</p><p>åˆ†æäº†è¿™ä¸¤æ®µä»£ç æˆ‘ä»¬å°±èƒ½æ˜ç™½ï¼Œå†™é”ç­‰å¾…æˆ–è€…æ·»åŠ æ—¶ï¼Œè¯»é”æ²¡æ³•æ·»åŠ ä¸Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RUnlock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">_ = rw.w.state</span><br><span class="line">race.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class="line">race.Disable()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="number">-1</span>); r &lt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> r+<span class="number">1</span> == <span class="number">0</span> || r+<span class="number">1</span> == -rwmutexMaxReaders &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">throw(<span class="string">"sync: RUnlock of unlocked RWMutex"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// A writer is pending.</span></span><br><span class="line"><span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="number">-1</span>) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// The last reader unblocks the writer.</span></span><br><span class="line">runtime_Semrelease(&amp;rw.writerSem, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾è¯»é”ï¼Œå…ˆåœ¨ <code>rw.readerCount</code> å‡ 1ï¼Œç„¶åæ£€æŸ¥è¯»å®¢æˆ·ç«¯æ˜¯å¦å°äº0ï¼Œå¦‚æœå°äº0è¯´æ˜æœ‰å†™é”åœ¨ç­‰å¾…ï¼Œ<br>åœ¨ <code>rw.readerWait</code> ä¸Šå‡1ï¼Œè¿™ä¸ªå˜é‡è®°å½•çš„æ˜¯å†™ç­‰å¾…è¯»å®¢æˆ·ç«¯çš„æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰éœ€è¦ç­‰å¾…çš„è¯»å®¢æˆ·ç«¯äº†ï¼Œå°±é€šçŸ¥ <code>rw.writerSem</code> å”¤é†’å†™é”</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">_ = rw.w.state</span><br><span class="line">race.Release(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">race.Disable()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Announce to readers there is no active writer.</span></span><br><span class="line">r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</span><br><span class="line"><span class="keyword">if</span> r &gt;= rwmutexMaxReaders &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">throw(<span class="string">"sync: Unlock of unlocked RWMutex"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Unblock blocked readers, if any.</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(r); i++ &#123;</span><br><span class="line">runtime_Semrelease(&amp;rw.readerSem, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Allow other writers to proceed.</span></span><br><span class="line">rw.w.Unlock()</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™é”åœ¨é‡Šæ”¾æ—¶ä¼šç»™ <code>rw.readerCount</code> è‡ªå¢ <code>rwmutexMaxReaders</code> è¿˜åŸçœŸå®è¯»å®¢æˆ·ç«¯æ•°é‡ã€‚<br><code>for i := 0; i &lt; int(r); i++ {</code> ç”¨æ¥å”¤é†’æ‰€æœ‰çš„è¯»å®¢æˆ·ç«¯ï¼Œå› ä¸ºåœ¨å†™é”çš„æ—¶å€™ï¼Œç”³è¯·è¯»é”çš„å®¢æˆ·ç«¯ä¼šè¢«è®¡æ•°ï¼Œä½†æ˜¯éƒ½ä¼šé™·å…¥ç¡çœ çŠ¶æ€ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥å‰ç‰¹åˆ«å¼ºè°ƒè¿‡è¯»é”é‡å…¥å¯¼è‡´æ­»é”çš„é—®é¢˜ï¼Œè€Œä¸”è¿™ä¸ªé—®é¢˜éå¸¸éš¾åœ¨ä¸šåŠ¡ä»£ç é‡Œé¢å¤ç°ï¼Œè§¦å‘å‡ ç‡å¾ˆä½ï¼Œ<br>ç¼–è¯‘å’Œè¿è¡Œæ—¶éƒ½æ— æ³•æ£€æµ‹è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥åƒä¸‡ä¸èƒ½é™·å…¥è¯»é”é‡å…¥çš„åµŒå¥—ä½¿ç”¨çš„æƒ…å†µï¼Œå¦è€…é—®é¢˜éå¸¸éš¾ä»¥æ’æŸ¥ã€‚</p><p>å…³äºåŠ é”çš„å‡ ä¸ªå°ç»éªŒï¼š</p><ul><li>è¿è¡Œæ—¶ç¦»å¼€å½“å‰é€»è¾‘å°±é‡Šæ”¾é”ã€‚</li><li>é”çš„ç²’åº¦è¶Šå°è¶Šå¥½ï¼ŒåŠ é”åå°½å¿«é‡Šæ”¾é”ã€‚</li><li>å°½é‡ä¸ç”¨ <code>defer</code> é‡Šæ”¾é”ã€‚</li><li>è¯»é”ä¸è¦åµŒå¥—ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸¤å¤©å‰ç¬¬ä¸€æ¬¡é‡åˆ°è‡ªå·±çš„ç¨‹åºå‡ºç°æ­»é”ï¼Œ æˆ‘ä¸€ç›´éå¸¸çš„å°å¿ƒä½¿ç”¨é”ï¼Œäº†è§£æ­»é”å¯¼è‡´çš„å„ç§å¯èƒ½æ€§ï¼Œ&lt;br&gt;è¿™æ¬¡çš„ç»å†è®©æˆ‘æœªæ¥ä¼šæ›´åŠ å°å¿ƒï¼Œä¸‹é¢æ¥å›é¡¾ä¸€ä¸‹æ­»é”å‘ç”Ÿçš„è¿‡ç¨‹ä¸ä»£ç æ¼”è¿›çš„è¿‡ç¨‹å§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹&quot;&gt;&lt;/a&gt;ç®€è¿°ä¸šåŠ¡èƒŒæ™¯åŠä»£ç æ¼”è¿›è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;æˆ‘çš„ç¨‹åºä¸­æœ‰ä¸€å—ç¼“å­˜ï¼Œæ•°æ®ä¼šç»„ç»‡å¥½æ”¾åˆ°å†…å­˜ä¸­ï¼Œä¼šæ ¹æ®æ•°æ®æºï¼ˆMySQLï¼‰æ›´æ–°è€Œåˆ·æ–°ç¼“å­˜ï¼Œæ˜¯è¯»å¤šå†™å°‘çš„åº”ç”¨åœºæ™¯ã€‚&lt;br&gt;å†…å­˜ä¸­æœ‰ä¸€ä¸ªå¾ˆå¤§æ•°æ®åˆ—è¡¨ï¼Œç¼“å­˜æ¨¡å—ä¼šæŒ‰æ•°æ®ç»´åº¦è¿›è¡Œåˆ†ç»„ï¼Œæ¯æ¬¡è®¿é—®æ ¹æ®ç»´åº¦æŸ¥æ‰¾åˆ°è¿™ä¸ªåˆ—è¡¨é‡Œé¢çš„æ‰€æœ‰æ•°æ®ã€‚&lt;br&gt;ä¸šåŠ¡æ¨¡å—æ‹¿åˆ°æ•°æ®åä¼šæ ¹æ®ä¸šåŠ¡éœ€è¦å†åšä¸€æ¬¡ç­›é€‰ï¼Œé€‰å‡ºNä¸ªç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼ˆå…·ä½“å¤šå°‘ä¸ªç”±ä¸šåŠ¡æ¨¡å—çš„è§„åˆ™å†³å®šï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="https://blog.thinkeridea.com/categories/go/"/>
    
    
      <category term="è¯»å†™é”" scheme="https://blog.thinkeridea.com/tags/%E8%AF%BB%E5%86%99%E9%94%81/"/>
    
      <category term="æ­»é”" scheme="https://blog.thinkeridea.com/tags/%E6%AD%BB%E9%94%81/"/>
    
  </entry>
  
</feed>
